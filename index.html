<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบออนไลน์ (Chinese Test)</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; user-select: none; -webkit-user-select: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .watermark-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 9000; opacity: 0.08;
            display: flex; flex-wrap: wrap; justify-content: space-around; align-content: space-around;
        }
        .watermark-text { transform: rotate(-45deg); font-size: 20px; font-weight: bold; color: #333; margin: 50px; }
        @media print { html, body { display: none !important; background-color: #000 !important; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen text-slate-800 notranslate" translate="no">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHmmpM8mJQ4M7J8k9L5qW3rX2vN4pR6tU",
            authDomain: "chinesetest2-68.firebaseapp.com",
            databaseURL: "https://chinesetest2-68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chinesetest2-68",
            storageBucket: "chinesetest2-68.firebasestorage.app",
            messagingSenderId: "150596319988",
            appId: "1:150596319988:web:a7cc730d4c2bae21047ca1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fb = { collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const LOGO_URL = "https://img2.pic.in.th/pic/Logoc404dc85753b800c.png";

        // --- 1. Global Utilities ---
        const shuffleArray = (array) => {
            if (!array || !Array.isArray(array)) return [];
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const activeIdMatch = (id) => String(id || '').trim();

        // --- 2. Icons Component ---
        const Icon = ({ path, className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const FileText = (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const LogOut = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const Shield = (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const Upload = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const User = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const XCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const Edit = (props) => <Icon {...props} path={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />;
        const List = (props) => <Icon {...props} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />;
        const Trash = (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />;
        const Eye = (props) => <Icon {...props} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />;
        const BookOpen = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const Layout = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></>} />;
        const Plus = (props) => <Icon {...props} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />;
        const Users = (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M15.31 8.33a4 4 0 0 1 0 5.34"/></>} />;
        const ChevronDown = (props) => <Icon {...props} path={<><polyline points="6 9 12 15 18 9"/></>} />;
        const Send = (props) => <Icon {...props} path={<><line x1="22" y1="2" x2="11" y2="13"/><polyline points="22 2 15 22 11 13 2 9 22 2"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;

        // --- 3. UI Components ---
        const LogoHeader = ({ title, subtitle, className = "" }) => (
            <div className={`flex flex-col items-center mb-8 ${className}`}>
                <img src={LOGO_URL} alt="Logo" className="w-24 h-auto drop-shadow-md mb-4 animate-float" />
                {title && <h2 className="text-2xl font-bold text-slate-800 text-center">{title}</h2>}
                {subtitle && <p className="text-slate-500 text-sm text-center mt-1 uppercase tracking-widest font-black">{subtitle}</p>}
            </div>
        );

        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[9999] flex items-center justify-center text-center">
                <div className="bg-white/95 p-8 rounded-2xl shadow-2xl flex flex-col items-center border border-white/50 max-w-sm w-full mx-4">
                    <div className="relative mb-6">
                        <div className="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
                    </div>
                    <h3 className="text-xl font-bold animate-pulse text-slate-800">{message || 'กำลังประมวลผล...'}</h3>
                </div>
            </div>
        );

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            return (
                <div className={`fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg z-[9999] animate-fade-in`}>
                    <div className="flex items-center gap-2">
                        {type === 'success' && <CheckCircle size={20} />}
                        <span className="font-bold">{message}</span>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl animate-fade-in">
                        <h3 className="text-xl font-bold text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-6 py-2 border-2 rounded-xl font-bold text-slate-600 hover:bg-slate-50">ยกเลิก</button>
                            <button onClick={onConfirm} className="px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">ยืนยัน</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BlackoutOverlay = () => (
            <div className="fixed inset-0 bg-black z-[10000] flex items-center justify-center text-white p-8 text-center">
                <div className="animate-fade-in text-center">
                    <AlertTriangle size={84} className="mx-auto mb-6 text-red-500 animate-bounce" />
                    <h2 className="text-4xl font-black mb-4 text-white uppercase tracking-tighter">ห้ามแคปภาพหน้าจอ!</h2>
                    <p className="text-gray-400 text-xl font-bold">ระบบได้บันทึกความพยายามในการละเมิดกฎการสอบของคุณแล้ว</p>
                </div>
            </div>
        );

        const Watermark = ({ text }) => {
            const items = Array.from({ length: 12 });
            return (<div className="watermark-container">{items.map((_, i) => <div key={i} className="watermark-text">{text}</div>)}</div>);
        };

        // --- 4. Modals ---
        const ViewExamModal = ({ exam, onClose }) => {
            if (!exam) return null;
            return (
                <div className="fixed inset-0 bg-black/60 z-[9998] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl animate-fade-in relative" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                            <div>
                                <h3 className="text-xl font-bold flex items-center gap-2"><FileText size={24} className="text-blue-600"/> ตรวจสอบข้อสอบ</h3>
                                <p className="text-sm text-slate-500 mt-1">{exam.id} - {exam.title}</p>
                            </div>
                            <button onClick={onClose} className="text-slate-400 hover:text-red-500 transition-colors"><XCircle size={24}/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-8">
                            {exam.questions?.map((q, idx) => (
                                <div key={idx} className="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                                    {q.sectionTitle && (
                                        <div className="bg-blue-600 text-white p-3 rounded-lg font-bold mb-3 flex items-center gap-2">
                                            <Layout size={18}/> {q.sectionTitle}
                                        </div>
                                    )}
                                    {q.passage && (
                                        <div className="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4 text-sm italic">
                                            <BookOpen size={14} className="inline mr-2 text-amber-600"/>{q.passage}
                                        </div>
                                    )}
                                    <p className="font-bold text-lg mb-4">{idx + 1}. {q.text}</p>
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                        {q.options.map((opt, oIdx) => (
                                            <div key={oIdx} className={`p-3 rounded-xl border flex items-center gap-3 ${oIdx === q.correct ? 'bg-green-100 border-green-300 text-green-800 font-bold':'bg-white text-slate-600 border-slate-200'}`}>
                                                <span className="w-7 h-7 rounded-full bg-slate-200 flex items-center justify-center shrink-0 text-xs font-bold">{String.fromCharCode(3601 + oIdx)}</span>
                                                <span>{opt}</span>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                        <div className="p-4 border-t bg-slate-50 text-right">
                            <button onClick={onClose} className="px-8 py-2.5 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900">ปิด</button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditExamModal = ({ exam, onClose, onSave }) => {
            const [data, setData] = useState({ title: exam.title, time: exam.timeLimit / 60 });
            const [questions, setQuestions] = useState(exam.questions || []);

            const handleUpdateQuestion = (idx, field, value) => {
                const updated = [...questions];
                updated[idx] = { ...updated[idx], [field]: value };
                setQuestions(updated);
            };

            const handleUpdateOption = (qIdx, oIdx, value) => {
                const updated = [...questions];
                const opts = [...updated[qIdx].options];
                opts[oIdx] = value;
                updated[qIdx].options = opts;
                setQuestions(updated);
            };

            const addQuestion = () => {
                setQuestions([...questions, { 
                    id: Date.now() + Math.random(), 
                    text: '', 
                    options: ['', '', '', ''], 
                    correct: 0, 
                    sectionTitle: '', 
                    passage: '', 
                    passagePosition: 'top' 
                }]);
            };

            const removeQuestion = (idx) => {
                if(confirm('ลบข้อสอบข้อนี้?')) {
                    const updated = questions.filter((_, i) => i !== idx);
                    setQuestions(updated);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[9998] flex items-center justify-center p-4 md:p-10" onClick={onClose}>
                    <div className="bg-white rounded-[2rem] max-w-5xl w-full h-full flex flex-col shadow-2xl animate-fade-in overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 className="text-2xl font-black flex items-center gap-2 uppercase tracking-tighter"><Edit size={24} className="text-blue-600"/> แก้ไขข้อสอบ</h3>
                                <p className="text-sm text-slate-500 font-bold uppercase tracking-widest">รหัสวิชา: {exam.id}</p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full transition-colors"><XCircle size={32}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-8">
                            <section className="bg-slate-100 p-6 rounded-3xl grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase mb-2">ชื่อวิชา</label>
                                    <input type="text" value={data.title} onChange={e=>setData({...data, title: e.target.value})} className="w-full p-4 border rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold" />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase mb-2">เวลาสอบ (นาที)</label>
                                    <input type="number" value={data.time} onChange={e=>setData({...data, time: parseInt(e.target.value) || 0})} className="w-full p-4 border rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold" />
                                </div>
                            </section>
                            <section className="space-y-6">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-black text-lg text-slate-800 uppercase tracking-tighter flex items-center gap-2">
                                        <List size={20} className="text-blue-600"/> รายการข้อสอบ ({questions.length})
                                    </h4>
                                    <button onClick={addQuestion} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-black flex items-center gap-2 hover:bg-blue-700 active:scale-95 shadow-lg uppercase text-xs">
                                        <Plus size={18}/> เพิ่มข้อสอบ
                                    </button>
                                </div>
                                {questions.map((q, idx) => (
                                    <div key={idx} className="bg-white border-2 border-slate-100 p-8 rounded-3xl space-y-4 relative group shadow-sm">
                                        <button onClick={() => removeQuestion(idx)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                            <Trash size={20}/>
                                        </button>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="md:col-span-2">
                                                <label className="text-[10px] font-black text-blue-500 uppercase mb-1 block">ตอนที่</label>
                                                <input type="text" value={q.sectionTitle || ''} onChange={e=>handleUpdateQuestion(idx, 'sectionTitle', e.target.value)} placeholder="เช่น ตอนที่ 1" className="w-full p-3 border rounded-xl bg-blue-50/20 text-sm focus:ring-2 focus:ring-blue-100 font-bold" />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="text-[10px] font-black text-amber-600 uppercase mb-1 block">บทอ่าน</label>
                                                <textarea rows="2" value={q.passage || ''} onChange={e=>handleUpdateQuestion(idx, 'passage', e.target.value)} className="w-full p-3 border rounded-xl bg-amber-50/20 text-sm focus:ring-1 focus:ring-blue-300 outline-none font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block">ตำแหน่ง</label>
                                                <select value={q.passagePosition || 'top'} onChange={e=>handleUpdateQuestion(idx, 'passagePosition', e.target.value)} className="w-full p-2 border rounded-xl text-xs outline-none font-bold bg-white">
                                                    <option value="top">บน</option>
                                                    <option value="bottom">ล่าง</option>
                                                </select>
                                            </div>
                                            <div className="md:col-span-2 pt-4 border-t border-slate-50">
                                                <label className="text-xs font-black text-slate-800 uppercase mb-2 block">ข้อที่ {idx+1}</label>
                                                <input type="text" value={q.text} onChange={e=>handleUpdateQuestion(idx, 'text', e.target.value)} className="w-full p-4 border-2 border-slate-100 rounded-2xl font-black outline-none focus:border-blue-500" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                            {q.options.map((opt, oIdx) => (
                                                <div key={oIdx} className="flex gap-2 items-center">
                                                    <input type="radio" checked={q.correct === oIdx} onChange={() => handleUpdateQuestion(idx, 'correct', oIdx)} className="w-4 h-4 accent-green-600 cursor-pointer" />
                                                    <input type="text" value={opt} onChange={e=>handleUpdateOption(idx, oIdx, e.target.value)} className={`flex-1 p-3.5 border-2 rounded-2xl text-sm outline-none transition-all ${q.correct === oIdx ? 'bg-green-50 border-green-400 font-black':'border-slate-100 focus:border-blue-200'}`} placeholder={`ตัวเลือก ${oIdx+1}`} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </section>
                        </div>
                        <div className="p-6 border-t bg-slate-50 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-4 bg-white border-2 border-slate-200 rounded-2xl font-black hover:bg-slate-100 transition-all uppercase tracking-widest">ยกเลิก</button>
                            <button onClick={()=>onSave(exam.id, { ...data, questions })} className="flex-[2] py-4 bg-green-600 text-white rounded-2xl font-black shadow-xl hover:bg-green-700 transition-all active:scale-95 flex justify-center items-center gap-2 text-xl uppercase tracking-tighter">
                                บันทึกการเปลี่ยนแปลง
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditStudentModal = ({ student, onClose, onSave }) => {
            const [data, setData] = useState({ 
                id: student?.id || '', 
                name: student?.name || '', 
                surname: student?.surname || '', 
                classroom: student?.classroom || '' 
            });

            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[9998] flex items-center justify-center p-4">
                    <div className="bg-white rounded-[2.5rem] max-w-md w-full p-10 shadow-2xl animate-fade-in" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h3 className="text-2xl font-black flex items-center gap-3 uppercase tracking-tighter"><Users className="text-blue-600"/> ข้อมูลนักเรียน</h3>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                    {student?.id ? 'แก้ไขข้อมูล' : 'เพิ่มนักเรียนใหม่'}
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-50 rounded-full text-slate-300 hover:text-red-500 transition-colors"><XCircle size={28}/></button>
                        </div>
                        <div className="space-y-5">
                            <div>
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">รหัสนักเรียน</label>
                                <input type="text" disabled={!!student?.id} value={data.id} onChange={e=>setData({...data, id: e.target.value})} className="w-full p-4 border-2 border-slate-50 rounded-2xl outline-none font-black text-blue-600 bg-slate-50" placeholder="00000" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">ชื่อ</label>
                                    <input type="text" value={data.name} onChange={e=>setData({...data, name: e.target.value})} className="w-full p-3 border-2 border-slate-50 rounded-xl font-bold" />
                                </div>
                                <div>
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">นามสกุล</label>
                                    <input type="text" value={data.surname} onChange={e=>setData({...data, surname: e.target.value})} className="w-full p-3 border-2 border-slate-50 rounded-xl font-bold" />
                                </div>
                            </div>
                            <div>
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">ห้องเรียน</label>
                                <input type="text" value={data.classroom} onChange={e=>setData({...data, classroom: e.target.value})} className="w-full p-3 border-2 border-slate-50 rounded-xl font-bold" placeholder="เช่น 601" />
                            </div>
                        </div>
                        <div className="mt-10 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-4 border-2 border-slate-100 rounded-2xl font-black text-slate-300 uppercase">ยกเลิก</button>
                            <button onClick={()=>onSave(data)} className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all uppercase">
                                บันทึกข้อมูล
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. Main App Component ---
        const SecureExamApp = () => {
            const [step, setStep] = useState('login'); 
            const [student, setStudent] = useState(null);
            const [studentIdInput, setStudentIdInput] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [exams, setExams] = useState([]);
            const [currentExam, setCurrentExam] = useState(null);
            const [adminTab, setAdminTab] = useState('dashboard');
            const [adminTimeLimitInput, setAdminTimeLimitInput] = useState(5); 
            const [adminClassroomInput, setAdminClassroomInput] = useState('All');
            const [monitorFilterRoom, setMonitorFilterRoom] = useState('All'); 
            const [dashboardData, setDashboardData] = useState([]);
            const [editingExam, setEditingExam] = useState(null); 
            const [viewingExam, setViewingExam] = useState(null); 
            const [editingStudent, setEditingStudent] = useState(null);
            const [systemConfig, setSystemConfig] = useState({ 
                activeExamId: '', 
                isOpen: false, 
                customTimeLimit: 0, 
                activeClassroom: 'All', 
                examOpenedAt: '', 
                examStartMs: 0,
                roomPassword: '' 
            });
            const [currentQIdx, setCurrentQIdx] = useState(0); 
            const [timeLeft, setTimeLeft] = useState(0);
            const [answers, setAnswers] = useState({});
            const answersRef = useRef({}); 
            const [examStatus, setExamStatus] = useState('pending');
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState(''); 
            const [error, setError] = useState('');
            const [warningCount, setWarningCount] = useState(0);
            const [isBlackout, setIsBlackout] = useState(false);
            const [newAdminPassword, setNewAdminPassword] = useState('');
            const [adminGlobalPassword, setAdminGlobalPassword] = useState('admin1234');
            
            // State สำหรับสร้างข้อสอบ
            const [newExam, setNewExam] = useState({ id: '', title: '', time: 60 });
            const [newQuestions, setNewQuestions] = useState([]);
            const [qDraft, setQDraft] = useState({ 
                text: '', 
                options: ['', '', '', ''], 
                correct: 0, 
                sectionTitle: '', 
                passage: '', 
                passagePosition: 'top' 
            });
            
            const [confirmDelete, setConfirmDelete] = useState({ isOpen: false, type: '', id: null });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            
            const timerRef = useRef(null);
            const unsubscribers = useRef([]);

            // --- Toast Helper ---
            const showToast = useCallback((message, type = 'success') => {
                setToast({ show: true, message, type });
            }, []);

            // --- Cleanup Function ---
            const cleanupListeners = () => {
                unsubscribers.current.forEach(unsub => unsub?.());
                unsubscribers.current = [];
            };

            // --- Derived Data ---
            const availableClassrooms = useMemo(() => {
                if (!dashboardData || !Array.isArray(dashboardData)) return [];
                return Array.from(new Set(dashboardData.map(d => String(d.classroom || '').trim())))
                    .filter(c => c && c !== 'undefined' && c !== '')
                    .sort();
            }, [dashboardData]);

            const selectedExamPreview = useMemo(() => {
                if (!exams || !Array.isArray(exams) || !systemConfig.activeExamId) return null;
                return exams.find(e => activeIdMatch(e.id) === activeIdMatch(systemConfig.activeExamId));
            }, [exams, systemConfig.activeExamId]);

            const progress = useMemo(() => {
                if (!currentExam || !currentExam.questions) return 0;
                const answeredCount = currentExam.questions.filter(q => answers[q.id] !== undefined).length;
                return Math.round((answeredCount / currentExam.questions.length) * 100);
            }, [answers, currentExam]);

            // --- Database Methods ---
            const fetchExams = async () => {
                try {
                    const snap = await window.fb.getDocs(window.fb.collection(window.db, "exams"));
                    const data = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setExams(data);
                    return data;
                } catch (err) { 
                    console.error(err);
                    return []; 
                }
            };

            const exportToCSV = useCallback(() => {
                const filterRoom = monitorFilterRoom;
                const filtered = dashboardData.filter(d => filterRoom === 'All' || String(d.classroom).trim() === filterRoom.trim());
                
                if (filtered.length === 0) {
                    showToast('ไม่มีข้อมูลสำหรับการส่งออก', 'error');
                    return;
                }

                const headers = ["รหัสนักเรียน", "ชื่อ", "นามสกุล", "ห้อง", "คะแนน", "สถานะ", "หมายเหตุ"];
                const rows = filtered.map(d => [
                    `'${d.id}`,
                    `"${d.name || ''}"`,
                    `"${d.surname || ''}"`,
                    `"${d.classroom || ''}"`,
                    d.score ?? "-",
                    `"${d.status || ''}"`,
                    `"${d.reason || '-'}"`
                ]);

                const csvContent = "\ufeff" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url; 
                link.download = `ExamReport_${systemConfig.activeExamId}_${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click(); 
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('ส่งออกรายงานสำเร็จ');
            }, [dashboardData, monitorFilterRoom, systemConfig.activeExamId, showToast]);

            const handleToggleExam = async (isOpen) => {
                setLoading(true);
                setLoadingMessage(isOpen ? 'กำลังเปิดระบบสอบ...' : 'กำลังปิดระบบสอบ...');
                
                try {
                    await window.fb.updateDoc(window.fb.doc(window.db, "config", "system"), {
                        isOpen, 
                        customTimeLimit: parseInt(adminTimeLimitInput) * 60, 
                        activeClassroom: adminClassroomInput,
                        examOpenedAt: isOpen ? new Date().toLocaleString('th-TH') : '', 
                        examStartMs: isOpen ? Date.now() : 0
                    });
                    showToast(`ระบบสอบ ${isOpen ? 'เปิด' : 'ปิด'} เรียบร้อย`);
                } catch (err) { 
                    showToast(err.message, 'error');
                }
                setLoading(false);
            };

            const handleChangeAdminPassword = async () => {
                if (!newAdminPassword || newAdminPassword.length < 4) {
                    showToast("รหัสผ่านต้องมีความยาวอย่างน้อย 4 ตัวอักษร", 'error');
                    return;
                }
                
                setLoading(true);
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "config", "admin"), { password: newAdminPassword });
                    setAdminGlobalPassword(newAdminPassword);
                    showToast("เปลี่ยนรหัสผ่านแอดมินสำเร็จ");
                    setNewAdminPassword('');
                } catch (err) { 
                    showToast("เกิดข้อผิดพลาด: " + err.message, 'error');
                }
                setLoading(false);
            };

            const handleResetSubmission = async (studentId) => {
                if (!confirm(`ยืนยันการรีเซ็ตสถานะการสอบของนักเรียนรหัส ${studentId}?`)) return;
                
                setLoading(true);
                try {
                    await window.fb.deleteDoc(window.fb.doc(window.db, "submissions", `${studentId}_${systemConfig.activeExamId}`));
                    showToast("รีเซ็ตสถานะเรียบร้อย");
                } catch (err) { 
                    showToast(err.message, 'error');
                }
                setLoading(false);
            };

            const handleChangeExamSubject = async (examId) => {
                const found = exams.find(e => activeIdMatch(e.id) === activeIdMatch(examId));
                if (found) setAdminTimeLimitInput(found.timeLimit / 60);
                
                try {
                    await window.fb.updateDoc(window.fb.doc(window.db,"config","system"), {activeExamId: examId});
                    showToast('เปลี่ยนวิชาสอบเรียบร้อย');
                } catch (err) {
                    showToast(err.message, 'error');
                }
            };

            const handleFileSelect = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                setLoading(true);
                setLoadingMessage('กำลังอ่านไฟล์...');
                
                try {
                    const arrayBuffer = await file.arrayBuffer();
                    const result = await mammoth.extractRawText({ arrayBuffer });
                    
                    // แปลงข้อความที่ได้เป็นโครงสร้างข้อสอบเบื้องต้น
                    const lines = result.value.split('\n').filter(line => line.trim());
                    
                    // สร้างข้อสอบตัวอย่างจากไฟล์
                    const newQuestionsTemp = [];
                    let currentQuestion = null;
                    
                    lines.forEach(line => {
                        if (line.match(/^\d+\./)) {
                            if (currentQuestion && currentQuestion.text) {
                                newQuestionsTemp.push(currentQuestion);
                            }
                            currentQuestion = {
                                text: line.replace(/^\d+\./, '').trim(),
                                options: ['', '', '', ''],
                                correct: 0,
                                sectionTitle: '',
                                passage: '',
                                passagePosition: 'top',
                                id: Date.now() + Math.random() + newQuestionsTemp.length
                            };
                        } else if (line.match(/^[ก-ฮ]\)/) && currentQuestion) {
                            const optionIndex = currentQuestion.options.findIndex(o => o === '');
                            if (optionIndex !== -1) {
                                currentQuestion.options[optionIndex] = line.replace(/^[ก-ฮ]\)/, '').trim();
                            }
                        }
                    });
                    
                    if (currentQuestion && currentQuestion.text) {
                        newQuestionsTemp.push(currentQuestion);
                    }
                    
                    if (newQuestionsTemp.length > 0) {
                        setNewQuestions(prev => [...prev, ...newQuestionsTemp]);
                        showToast(`นำเข้าข้อสอบ ${newQuestionsTemp.length} ข้อเรียบร้อย`);
                    } else {
                        showToast('ไม่พบโครงสร้างข้อสอบในไฟล์', 'error');
                    }
                    
                } catch (err) {
                    showToast('เกิดข้อผิดพลาดในการอ่านไฟล์', 'error');
                }
                
                setLoading(false);
                e.target.value = '';
            };

            const addQuestionToDraft = () => {
                if (!qDraft.text || !qDraft.text.trim()) {
                    showToast('กรุณากรอกโจทย์', 'error');
                    return;
                }
                
                const validOptions = qDraft.options.filter(o => o && o.trim());
                if (validOptions.length < 2) {
                    showToast('กรุณากรอกตัวเลือกอย่างน้อย 2 ตัวเลือก', 'error');
                    return;
                }
                
                setNewQuestions([...newQuestions, { 
                    ...qDraft, 
                    id: Date.now() + Math.random(),
                    options: qDraft.options.map(o => o.trim())
                }]);
                
                setQDraft({ 
                    text: '', 
                    options: ['', '', '', ''], 
                    correct: 0, 
                    sectionTitle: '', 
                    passage: '', 
                    passagePosition: 'top' 
                });
                
                showToast('เพิ่มข้อสอบเรียบร้อย');
            };

            const handleCreateExamSubmit = async () => {
                if (!newExam.id || !newExam.id.trim()) {
                    showToast('กรุณากรอกรหัสวิชา', 'error');
                    return;
                }
                if (!newExam.title || !newExam.title.trim()) {
                    showToast('กรุณากรอกชื่อวิชา', 'error');
                    return;
                }
                if (newQuestions.length === 0) {
                    showToast('กรุณาเพิ่มข้อสอบอย่างน้อย 1 ข้อ', 'error');
                    return;
                }
                
                setLoading(true);
                setLoadingMessage('กำลังบันทึกข้อสอบ...');
                
                try {
                    // ตรวจสอบว่ามีรหัสวิชานี้แล้วหรือไม่
                    const existing = await window.fb.getDoc(window.fb.doc(window.db, "exams", newExam.id.trim()));
                    if (existing.exists()) {
                        if (!confirm('รหัสวิชานี้มีอยู่แล้ว คุณต้องการแทนที่ข้อมูลเดิมหรือไม่?')) {
                            setLoading(false);
                            return;
                        }
                    }
                    
                    await window.fb.setDoc(
                        window.fb.doc(window.db, "exams", newExam.id.trim()), 
                        {
                            title: newExam.title.trim(),
                            timeLimit: newExam.time * 60,
                            questions: newQuestions.filter(q => q.text && q.text.trim())
                        }
                    );
                    
                    showToast('สร้างข้อสอบสำเร็จ');
                    setNewExam({ id: '', title: '', time: 60 });
                    setNewQuestions([]);
                    setAdminTab('manage_exams');
                    await fetchExams();
                } catch (err) {
                    showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
                }
                
                setLoading(false);
            };

            const prepareExamFromData = useCallback((examData) => {
                if (!examData || !examData.questions) return;
                
                let processed = JSON.parse(JSON.stringify(examData));
                const hasStructure = processed.questions.some(q => q.sectionTitle || q.passage);
                if (!hasStructure) processed.questions = shuffleArray(processed.questions);
                
                processed.questions = processed.questions.map(q => {
                    const opts = q.options.map((opt, i) => ({ text: opt, isCorrect: i === q.correct }));
                    const shuffled = shuffleArray(opts);
                    return { 
                        ...q, 
                        options: shuffled.map(o => o.text), 
                        correct: shuffled.findIndex(o => o.isCorrect) 
                    };
                });
                
                setCurrentExam({ 
                    ...processed, 
                    timeLimit: systemConfig.customTimeLimit || processed.timeLimit 
                });
            }, [systemConfig.customTimeLimit]);

            const submitExam = useCallback(async (reason = 'Normal', isCheat = false) => {
                if (examStatus !== 'active' && !['TimeOut', 'Manual Submit', 'User Submitted'].includes(reason)) return;
                
                clearInterval(timerRef.current);
                setLoading(true); 
                setLoadingMessage('กำลังส่งคำตอบ...');
                
                let score = 0;
                if (currentExam && currentExam.questions) {
                    currentExam.questions.forEach(q => { 
                        if(answersRef.current[q.id] === q.correct) score++; 
                    });
                }
                
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "submissions", `${student.id}_${currentExam.id}`), {
                        studentId: student.id, 
                        studentName: `${student.name} ${student.surname}`, 
                        examId: currentExam.id,
                        score: score, 
                        totalScore: currentExam.questions.length, 
                        status: isCheat ? 'CHEATED' : 'COMPLETED', 
                        reason, 
                        answers: answersRef.current, 
                        submittedAt: new Date().toISOString()
                    });
                    
                    showToast(`ส่งกระดาษคำตอบเรียบร้อย! คะแนน: ${score}/${currentExam.questions.length}`);
                    
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (err) { 
                    showToast('เกิดข้อผิดพลาดในการส่งคำตอบ', 'error');
                    console.error(err);
                }
                setLoading(false);
            }, [currentExam, student, examStatus, showToast]);

            const handleStudentLogin = async (e) => {
                e.preventDefault(); 
                setLoading(true); 
                setError('');
                
                try {
                    const inputId = studentIdInput.trim();
                    if (!inputId) {
                        setError('กรุณากรอกรหัสนักเรียน');
                        setLoading(false);
                        return;
                    }
                    
                    const snap = await window.fb.getDoc(window.fb.doc(window.db, "students", inputId));
                    
                    if (snap.exists()) {
                        const sData = { id: snap.id, ...snap.data() };
                        setStudent(sData);
                        
                        const activeId = activeIdMatch(systemConfig.activeExamId);
                        
                        if (systemConfig.isOpen && activeId) { 
                            const allExams = await fetchExams();
                            const found = allExams.find(e => activeIdMatch(e.id) === activeId);
                            if (found) { 
                                prepareExamFromData(found); 
                                setStep('instructions');
                            } else {
                                setStep('waiting_room');
                            }
                        } else {
                            setStep('waiting_room');
                        }
                        
                        showToast('เข้าสู่ระบบสำเร็จ');
                    } else {
                        setError('ไม่พบรหัสนักเรียนในระบบ');
                    }
                } catch (err) { 
                    setError(err.message);
                    showToast(err.message, 'error');
                }
                setLoading(false);
            };

            const startExam = () => {
                if (!systemConfig.isOpen) {
                    showToast('ระบบปิดการสอบอยู่', 'error');
                    return;
                }
                if (!currentExam) {
                    showToast('ข้อมูลข้อสอบไม่พร้อม', 'error');
                    return;
                }
                
                setTimeLeft(currentExam.timeLimit || 3600); 
                setStep('exam'); 
                setExamStatus('active');
                
                if (timerRef.current) clearInterval(timerRef.current);
                
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) { 
                            submitExam('หมดเวลา'); 
                            return 0; 
                        } 
                        return prev - 1; 
                    });
                }, 1000);
            };

            const handleDeleteConfirm = async () => {
                if (!confirmDelete.id) return;
                
                setLoading(true);
                setLoadingMessage('กำลังลบข้อมูล...');
                
                try {
                    if (confirmDelete.type === 'student') {
                        await window.fb.deleteDoc(window.fb.doc(window.db, "students", confirmDelete.id));
                        showToast('ลบข้อมูลนักเรียนเรียบร้อย');
                    } else if (confirmDelete.type === 'exam') {
                        await window.fb.deleteDoc(window.fb.doc(window.db, "exams", confirmDelete.id));
                        showToast('ลบข้อสอบเรียบร้อย');
                        await fetchExams();
                    }
                } catch (err) {
                    showToast(err.message, 'error');
                }
                
                setLoading(false);
                setConfirmDelete({ isOpen: false, type: '', id: null });
            };

            // --- Effects ---
            useEffect(() => {
                const init = async () => {
                    await fetchExams();
                    
                    // ตรวจสอบและสร้าง admin config ถ้ายังไม่มี
                    const adminDoc = await window.fb.getDoc(window.fb.doc(window.db, "config", "admin"));
                    if (!adminDoc.exists()) {
                        await window.fb.setDoc(window.fb.doc(window.db, "config", "admin"), { 
                            password: "admin1234" 
                        });
                    }
                };
                
                init();
                
                const unsubConfig = window.fb.onSnapshot(
                    window.fb.doc(window.db, "config", "system"), 
                    (doc) => {
                        if (doc.exists()) setSystemConfig(doc.data());
                    }
                );
                
                const unsubAdmin = window.fb.onSnapshot(
                    window.fb.doc(window.db, "config", "admin"), 
                    (doc) => {
                        if (doc.exists()) setAdminGlobalPassword(doc.data().password);
                    }
                );
                
                unsubscribers.current.push(unsubConfig, unsubAdmin);
                
                return () => {
                    cleanupListeners();
                };
            }, []);

            useEffect(() => {
                let unsubStudent = null;
                
                if (student?.id && (['waiting_room', 'instructions', 'exam'].includes(step))) {
                    unsubStudent = window.fb.onSnapshot(
                        window.fb.doc(window.db, "students", student.id), 
                        (doc) => {
                            if (doc.exists()) setStudent({ id: doc.id, ...doc.data() });
                        }
                    );
                    
                    if (unsubStudent) {
                        unsubscribers.current.push(unsubStudent);
                    }
                }
                
                return cleanupListeners;
            }, [student?.id, step]);

            useEffect(() => {
                let unsubSubmissions = null;
                
                if (step === 'admin_dashboard' && (adminTab === 'manage_students' || adminTab === 'dashboard')) {
                    setLoading(true);
                    
                    window.fb.getDocs(window.fb.collection(window.db, "students"))
                        .then(snap => {
                            const allStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            
                            const subQuery = window.fb.query(
                                window.fb.collection(window.db, "submissions"), 
                                window.fb.where("examId", "==", systemConfig.activeExamId || "NONE")
                            );
                            
                            unsubSubmissions = window.fb.onSnapshot(subQuery, (subSnap) => {
                                const submissions = {};
                                subSnap.forEach(doc => { 
                                    submissions[doc.data().studentId] = doc.data(); 
                                });
                                
                                setDashboardData(allStudents.map(std => {
                                    const sub = submissions[std.id];
                                    return { 
                                        ...std, 
                                        score: sub?.score, 
                                        status: sub?.status || 'รอเข้าสอบ', 
                                        reason: sub?.reason 
                                    };
                                }));
                                setLoading(false);
                            }, (error) => {
                                console.error(error);
                                setLoading(false);
                            });
                            
                            if (unsubSubmissions) {
                                unsubscribers.current.push(unsubSubmissions);
                            }
                        })
                        .catch(() => setLoading(false));
                }
                
                return cleanupListeners;
            }, [step, adminTab, systemConfig.activeExamId]);

            useEffect(() => {
                const autoRedirect = async () => {
                    if (step !== 'waiting_room' || !systemConfig.isOpen || !systemConfig.activeExamId || !student) return;
                    
                    const cfgRoom = String(systemConfig.activeClassroom || 'All').trim().toLowerCase();
                    const studentRoom = String(student.classroom || '').trim().toLowerCase();
                    const isCorrectRoom = cfgRoom === 'all' || cfgRoom === studentRoom;
                    
                    if (isCorrectRoom) {
                        setLoading(true); 
                        setLoadingMessage('กำลังเตรียมข้อมูลข้อสอบ...');
                        
                        const currentExamsList = await fetchExams();
                        const found = currentExamsList.find(e => activeIdMatch(e.id) === activeIdMatch(systemConfig.activeExamId));
                        
                        if (found) { 
                            prepareExamFromData(found); 
                            setStep('instructions');
                        }
                        
                        setLoading(false);
                    }
                };
                
                autoRedirect();
            }, [systemConfig.isOpen, systemConfig.activeExamId, systemConfig.activeClassroom, step, student, prepareExamFromData]);

            // Anti-Cheat
            useEffect(() => {
                if (step !== 'exam' || examStatus !== 'active') return;
                
                const handleCheat = () => {
                    setWarningCount(prev => {
                        const next = prev + 1;
                        if (next <= 2) { 
                            showToast(`⚠️ คำเตือน ${next}/2: ห้ามสลับหน้าจอหรือพับแท็บเด็ดขาด!`, 'error'); 
                            return next; 
                        } else { 
                            submitExam('สลับหน้าจอเกินกำหนด', true); 
                            return next; 
                        }
                    });
                };
                
                const handleVisibility = () => { 
                    if (document.hidden) handleCheat(); 
                };
                
                const handleKeyDown = (e) => {
                    if (e.key === 'PrintScreen' || (e.ctrlKey && e.shiftKey && e.key === 'S')) {
                        setIsBlackout(true);
                        setTimeout(() => setIsBlackout(false), 4000);
                        showToast('🚨 ตรวจพบพฤติกรรมสุ่มเสี่ยงต่อการทุจริต', 'error');
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibility);
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                return () => {
                    document.removeEventListener('visibilitychange', handleVisibility);
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, [step, examStatus, submitExam, showToast]);

            // Manage Students Tab
            const renderManageStudents = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h3 className="font-black text-2xl uppercase tracking-tighter">
                            จัดการนักเรียน
                        </h3>
                        <button 
                            onClick={() => setEditingStudent({})} 
                            className="bg-slate-900 text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 shadow-xl uppercase text-xs tracking-widest"
                        >
                            <Plus size={18}/> เพิ่มนักเรียน
                        </button>
                    </div>
                    
                    <div className="bg-white border-2 border-slate-50 rounded-[3rem] overflow-hidden shadow-xl">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-slate-50 text-slate-400 text-[10px] font-black uppercase border-b">
                                <tr>
                                    <th className="p-6">รหัสนักเรียน</th>
                                    <th className="p-6">ชื่อ-นามสกุล</th>
                                    <th className="p-6 text-center">ห้อง</th>
                                    <th className="p-6 text-right">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y-2 divide-slate-50">
                                {dashboardData.map(std => (
                                    <tr key={std.id} className="hover:bg-slate-50/70 transition-all">
                                        <td className="p-6 font-mono font-black text-blue-600">{std.id}</td>
                                        <td className="p-6 font-black text-xl">{std.name} {std.surname}</td>
                                        <td className="p-6 text-center font-black text-slate-400 text-lg">ห้อง {std.classroom}</td>
                                        <td className="p-6 text-right">
                                            <div className="flex gap-2 justify-end">
                                                <button 
                                                    onClick={() => setEditingStudent(std)} 
                                                    className="p-4 bg-slate-50 rounded-2xl text-slate-400 hover:text-blue-600 transition-all shadow-sm"
                                                >
                                                    <Edit size={20}/>
                                                </button>
                                                <button 
                                                    onClick={() => setConfirmDelete({ isOpen: true, type: 'student', id: std.id })} 
                                                    className="p-4 bg-slate-50 rounded-2xl text-slate-400 hover:text-red-500 transition-all shadow-sm"
                                                >
                                                    <Trash size={20}/>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            // Manage Exams Tab
            const renderManageExams = () => (
                <div className="space-y-6">
                    <h3 className="font-black text-2xl border-b-2 border-slate-50 pb-4 flex items-center gap-3 uppercase tracking-tighter">
                        <List size={28} className="text-blue-600"/> คลังข้อสอบ
                    </h3>
                    
                    <div className="grid grid-cols-1 gap-6">
                        {exams.map(ex => (
                            <div key={ex.id} className="bg-white p-8 rounded-[2.5rem] border-2 border-slate-50 shadow-sm flex flex-col md:flex-row justify-between items-center gap-8 hover:border-blue-200 transition-all">
                                <div className="flex-1">
                                    <h4 className="font-black text-3xl tracking-tight mb-2 leading-tight">
                                        {ex.title}
                                    </h4>
                                    <div className="flex gap-6 text-xs text-slate-400 font-black uppercase">
                                        <span className="bg-blue-50 text-blue-600 px-3 py-1 rounded-lg">
                                            ID: {ex.id}
                                        </span>
                                        <span className="flex items-center gap-2 font-black text-slate-600">
                                            <FileText size={16}/> {ex.questions?.length || 0} ข้อ
                                        </span>
                                        <span className="flex items-center gap-2 font-black text-slate-600">
                                            <Clock size={16}/> {ex.timeLimit / 60} นาที
                                        </span>
                                    </div>
                                </div>
                                <div className="flex gap-3 shrink-0">
                                    <button 
                                        onClick={() => setViewingExam(ex)} 
                                        className="p-5 bg-slate-50 text-slate-400 rounded-3xl hover:bg-blue-50 hover:text-blue-600 transition-all shadow-sm"
                                    >
                                        <Eye size={24}/>
                                    </button>
                                    <button 
                                        onClick={() => setEditingExam(ex)} 
                                        className="p-5 bg-slate-50 text-slate-400 rounded-3xl hover:bg-slate-800 hover:text-white transition-all shadow-sm"
                                    >
                                        <Edit size={24}/>
                                    </button>
                                    <button 
                                        onClick={() => setConfirmDelete({ isOpen: true, type: 'exam', id: ex.id })} 
                                        className="p-5 bg-slate-50 text-slate-400 rounded-3xl hover:bg-red-50 hover:text-red-500 transition-all shadow-sm"
                                    >
                                        <Trash size={24}/>
                                    </button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );

            // Create Exam Tab
            const renderCreateExam = () => (
                <div className="space-y-8 max-w-4xl mx-auto">
                    {/* Word Import */}
                    <div className="bg-emerald-50 p-8 rounded-[2.5rem] border-2 border-emerald-100 flex items-center justify-between">
                        <div className="flex items-center gap-4 text-emerald-800">
                            <div className="p-4 bg-emerald-600 text-white rounded-3xl shadow-lg">
                                <FileText size={32}/>
                            </div>
                            <div>
                                <h4 className="font-black text-2xl uppercase tracking-tighter">
                                    นำเข้าจาก Word
                                </h4>
                                <p className="text-sm font-bold text-emerald-600">
                                    อัปโหลดไฟล์ .docx เพื่อแปลงเป็นข้อสอบ
                                </p>
                            </div>
                        </div>
                        <label className="bg-emerald-600 text-white px-8 py-4 rounded-3xl cursor-pointer flex items-center gap-2 font-black hover:bg-emerald-700 transition-all shadow-xl uppercase tracking-tighter">
                            <Upload size={20}/> เลือกไฟล์
                            <input type="file" accept=".docx" onChange={handleFileSelect} className="hidden" />
                        </label>
                    </div>

                    {/* Exam Info */}
                    <div className="bg-white p-10 rounded-[3rem] border-2 border-slate-50 space-y-6 shadow-sm">
                        <h3 className="font-black text-slate-300 text-[10px] uppercase tracking-[0.3em] mb-4">
                            ขั้นตอนที่ 1: ข้อมูลข้อสอบ
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <input 
                                type="text" 
                                placeholder="รหัสวิชา" 
                                value={newExam.id} 
                                onChange={e => setNewExam({...newExam, id: e.target.value})} 
                                className="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50" 
                            />
                            <input 
                                type="text" 
                                placeholder="ชื่อวิชา" 
                                value={newExam.title} 
                                onChange={e => setNewExam({...newExam, title: e.target.value})} 
                                className="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50" 
                            />
                            <input 
                                type="number" 
                                placeholder="เวลา (นาที)" 
                                value={newExam.time} 
                                onChange={e => setNewExam({...newExam, time: parseInt(e.target.value) || 0})} 
                                className="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50" 
                                min="1"
                            />
                        </div>
                    </div>

                    {/* Question Builder */}
                    <div className="bg-white p-10 rounded-[3rem] border-2 border-slate-50 space-y-8 shadow-sm">
                        <h3 className="font-black text-slate-300 text-[10px] uppercase tracking-[0.3em] mb-4">
                            ขั้นตอนที่ 2: สร้างข้อสอบ
                        </h3>
                        
                        <div className="grid grid-cols-1 gap-6">
                            <input 
                                type="text" 
                                placeholder="หัวข้อส่วน (ถ้ามี)" 
                                value={qDraft.sectionTitle} 
                                onChange={e => setQDraft({...qDraft, sectionTitle: e.target.value})} 
                                className="p-5 border-2 border-slate-50 rounded-3xl bg-blue-50/30 font-bold shadow-inner" 
                            />
                            
                            <textarea 
                                rows="3" 
                                placeholder="บทอ่าน (ถ้ามี)" 
                                value={qDraft.passage} 
                                onChange={e => setQDraft({...qDraft, passage: e.target.value})} 
                                className="p-5 border-2 border-slate-50 rounded-3xl bg-amber-50/30 font-bold shadow-inner" 
                            />
                            
                            <div className="flex gap-4">
                                <select 
                                    value={qDraft.passagePosition} 
                                    onChange={e => setQDraft({...qDraft, passagePosition: e.target.value})}
                                    className="p-3 border-2 border-slate-50 rounded-xl bg-white font-bold"
                                >
                                    <option value="top">แสดงบทอ่านด้านบน</option>
                                    <option value="bottom">แสดงบทอ่านด้านล่าง</option>
                                </select>
                            </div>
                            
                            <input 
                                type="text" 
                                placeholder="โจทย์ข้อสอบ" 
                                value={qDraft.text} 
                                onChange={e => setQDraft({...qDraft, text: e.target.value})} 
                                className="p-6 border-2 border-slate-100 rounded-[2.5rem] font-black text-xl shadow-sm" 
                            />
                            
                            <div className="space-y-4">
                                {qDraft.options.map((opt, i) => (
                                    <div key={i} className="flex gap-4 items-center">
                                        <input 
                                            type="radio" 
                                            checked={qDraft.correct === i} 
                                            onChange={() => setQDraft({...qDraft, correct: i})} 
                                            className="w-8 h-8 accent-green-600" 
                                        />
                                        <input 
                                            type="text" 
                                            value={opt} 
                                            onChange={e => {
                                                const n = [...qDraft.options];
                                                n[i] = e.target.value;
                                                setQDraft({...qDraft, options: n});
                                            }} 
                                            className={`flex-1 p-5 border-2 rounded-3xl text-lg font-black ${
                                                qDraft.correct === i 
                                                    ? 'bg-green-50 border-green-400' 
                                                    : 'bg-slate-50/50 border-slate-50'
                                            }`}
                                            placeholder={`ตัวเลือกที่ ${i + 1}`} 
                                        />
                                    </div>
                                ))}
                                
                                {qDraft.options.length < 6 && (
                                    <button 
                                        onClick={() => setQDraft(p => ({
                                            ...p, 
                                            options: [...p.options, '']
                                        }))} 
                                        className="text-sm text-blue-600 font-black uppercase"
                                    >
                                        + เพิ่มตัวเลือก
                                    </button>
                                )}
                            </div>
                            
                            <button 
                                onClick={addQuestionToDraft} 
                                className="w-full bg-slate-900 text-white py-6 rounded-[2.5rem] font-black text-2xl uppercase tracking-tighter shadow-xl flex items-center justify-center gap-2"
                            >
                                <Plus size={32}/> เพิ่มข้อสอบ ({newQuestions.length})
                            </button>
                        </div>
                    </div>

                    {/* Publish Button */}
                    {newQuestions.length > 0 && (
                        <button 
                            onClick={handleCreateExamSubmit} 
                            className="w-full bg-green-600 text-white py-6 rounded-[3rem] font-black text-3xl shadow-2xl uppercase tracking-tighter border-4 border-green-500/20 hover:bg-green-700 transition-all active:scale-95"
                        >
                            บันทึกข้อสอบ
                        </button>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen text-slate-800 selection:bg-blue-100">
                    {loading && <LoadingOverlay message={loadingMessage} />}
                    {isBlackout && <BlackoutOverlay />}
                    
                    <ConfirmDialog 
                        isOpen={confirmDelete.isOpen}
                        title="ยืนยันการลบ"
                        message="คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้? การกระทำนี้ไม่สามารถเรียกคืนได้"
                        onConfirm={handleDeleteConfirm}
                        onCancel={() => setConfirmDelete({ isOpen: false, type: '', id: null })}
                    />
                    
                    {toast.show && (
                        <Toast 
                            message={toast.message} 
                            type={toast.type} 
                            onClose={() => setToast({ show: false, message: '', type: 'success' })}
                        />
                    )}
                    
                    {/* Modals */}
                    {editingExam && (
                        <EditExamModal 
                            exam={editingExam} 
                            onClose={() => setEditingExam(null)} 
                            onSave={async (id, updateData) => {
                                setLoading(true);
                                setLoadingMessage('กำลังบันทึกการเปลี่ยนแปลง...');
                                try { 
                                    await window.fb.updateDoc(
                                        window.fb.doc(window.db, "exams", id), 
                                        { 
                                            title: updateData.title, 
                                            timeLimit: updateData.time * 60, 
                                            questions: updateData.questions 
                                        }
                                    ); 
                                    showToast('บันทึกการเปลี่ยนแปลงเรียบร้อย'); 
                                    setEditingExam(null); 
                                    await fetchExams(); 
                                } catch (err) { 
                                    showToast(err.message, 'error');
                                }
                                setLoading(false);
                            }} 
                        />
                    )}
                    
                    {viewingExam && (
                        <ViewExamModal 
                            exam={viewingExam} 
                            onClose={() => setViewingExam(null)} 
                        />
                    )}
                    
                    {editingStudent !== null && (
                        <EditStudentModal 
                            student={editingStudent} 
                            onClose={() => setEditingStudent(null)} 
                            onSave={async (data) => {
                                if (!data.id || !data.id.trim()) {
                                    showToast('กรุณากรอกรหัสนักเรียน', 'error');
                                    return;
                                }
                                if (!data.name || !data.name.trim()) {
                                    showToast('กรุณากรอกชื่อ', 'error');
                                    return;
                                }
                                
                                setLoading(true); 
                                setLoadingMessage('กำลังบันทึกข้อมูล...');
                                
                                try {
                                    await window.fb.setDoc(
                                        window.fb.doc(window.db, "students", data.id.trim()), 
                                        { 
                                            name: data.name, 
                                            surname: data.surname, 
                                            classroom: data.classroom 
                                        }
                                    );
                                    setEditingStudent(null); 
                                    showToast('บันทึกข้อมูลเรียบร้อย');
                                } catch (err) {
                                    showToast(err.message, 'error');
                                }
                                
                                setLoading(false);
                            }} 
                        />
                    )}

                    {/* Login นักเรียน */}
                    {step === 'login' && (
                        <div className="min-h-screen flex items-center justify-center p-4">
                            <div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md relative text-center animate-fade-in border-white border-2">
                                <button onClick={() => setStep('admin_login')} className="absolute top-4 right-4 text-slate-400 p-2 hover:bg-sky-100 rounded-full transition-colors">
                                    <Shield size={20}/>
                                </button>
                                <LogoHeader title="ระบบสอบ Secure Exam" subtitle="STUDENT LOGIN" />
                                <form onSubmit={handleStudentLogin} className="space-y-6">
                                    <div className="text-left">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">รหัสนักเรียน</label>
                                        <input 
                                            type="text" 
                                            value={studentIdInput} 
                                            onChange={(e) => setStudentIdInput(e.target.value)} 
                                            className="w-full p-5 border-2 border-slate-50 rounded-2xl text-center text-2xl tracking-widest outline-none font-black bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-100" 
                                            placeholder="00000" 
                                            required 
                                            autoFocus 
                                        />
                                    </div>
                                    {error && (
                                        <div className="p-4 bg-red-50 text-red-600 rounded-2xl text-sm font-bold animate-shake">
                                            {error}
                                        </div>
                                    )}
                                    <button className="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-blue-700 transition-all text-xl uppercase tracking-tighter">
                                        เข้าสู่ระบบ
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Admin Login */}
                    {step === 'admin_login' && (
                        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                            <div className="glass-card p-10 rounded-3xl w-full max-w-sm text-center shadow-2xl border-white border-2">
                                <LogoHeader title="Admin Access" subtitle="AUTHENTICATION" />
                                <form onSubmit={e => {
                                    e.preventDefault(); 
                                    if(adminPassword === adminGlobalPassword) { 
                                        setStep('admin_dashboard'); 
                                        showToast('เข้าสู่ระบบแอดมินสำเร็จ'); 
                                    } else showToast('รหัสผ่านไม่ถูกต้อง', 'error');
                                }} className="space-y-4">
                                    <input 
                                        type="password" 
                                        value={adminPassword} 
                                        onChange={e => setAdminPassword(e.target.value)} 
                                        className="w-full p-4 border rounded-2xl text-center outline-none focus:ring-2 focus:ring-slate-800 text-lg font-bold bg-slate-50" 
                                        placeholder="รหัสผ่าน" 
                                        autoFocus
                                    />
                                    <button className="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-black transition-all text-lg uppercase">
                                        เข้าสู่ระบบ
                                    </button>
                                </form>
                                <button onClick={() => setStep('login')} className="mt-6 text-sm text-slate-400 font-bold hover:text-slate-600 uppercase tracking-widest">
                                    กลับสู่หน้านักเรียน
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Waiting Room */}
                    {step === 'waiting_room' && (
                        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                            <div className="glass-card p-12 rounded-[3.5rem] w-full max-w-md shadow-2xl relative overflow-hidden text-center border-white border-2">
                                <div className="absolute top-0 left-0 w-full h-3 bg-blue-100 overflow-hidden">
                                    <div className="h-full bg-blue-600 animate-[pulse_2s_infinite]"></div>
                                </div>
                                
                                <h2 className="text-4xl font-black mb-10 uppercase tracking-tighter">
                                    ห้องรอสอบ
                                </h2>
                                
                                <div className="relative inline-block mb-10">
                                    <div className="w-24 h-24 border-[8px] border-blue-100 border-t-blue-600 rounded-full animate-spin mx-auto"></div>
                                    <div className="absolute inset-0 flex items-center justify-center text-3xl font-bold">⏳</div>
                                </div>
                                
                                <p className="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-3">
                                    วิชาที่สอบ
                                </p>
                                <div className="font-black text-blue-600 text-2xl bg-blue-50 py-5 px-8 rounded-3xl inline-block border-2 border-blue-100 shadow-inner leading-snug">
                                    {selectedExamPreview?.title || 'รออาจารย์เริ่มการสอบ...'}
                                </div>
                                
                                <p className="mt-12 text-sm text-slate-400 italic font-black uppercase tracking-tighter">
                                    กรุณาอย่ารีเฟรชหน้าจอ ระบบจะพาท่านเข้าสอบโดยอัตโนมัติ
                                </p>
                            </div>
                        </div>
                    )}

                    {/* Instructions */}
                    {step === 'instructions' && currentExam && (
                        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                            <div className="glass-card p-12 rounded-[3.5rem] w-full max-w-lg shadow-2xl border-white border-2">
                                <div className="flex flex-col sm:flex-row items-center gap-5 mb-10">
                                    <div className="p-5 bg-blue-600 text-white rounded-[2rem] shadow-xl">
                                        <Lock size={36}/>
                                    </div>
                                    <div className="text-center sm:text-left">
                                        <h2 className="text-4xl font-black uppercase tracking-tighter leading-none">
                                            กฎการสอบ
                                        </h2>
                                        <p className="text-sm text-slate-400 font-black uppercase tracking-widest mt-2">
                                            {currentExam.title}
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="space-y-4 mb-10 text-slate-700 text-sm sm:text-base">
                                    <div className="flex gap-5 items-center p-6 bg-red-50 text-red-700 rounded-3xl border-2 border-red-100 font-black shadow-sm">
                                        <XCircle size={24} className="shrink-0"/> 
                                        ห้ามสลับหน้าจอหรือพับแท็บโดยเด็ดขาด
                                    </div>
                                    <div className="flex gap-5 items-center p-6 bg-orange-50 text-orange-700 rounded-3xl border-2 border-orange-100 font-black shadow-sm">
                                        <AlertTriangle size={24} className="shrink-0"/> 
                                        ห้ามบันทึกภาพหน้าจอ ระบบจะตัดสิทธิ์การสอบทันที
                                    </div>
                                    <div className="flex gap-5 items-center p-6 bg-blue-50 text-blue-700 rounded-3xl border-2 border-blue-100 font-black shadow-sm">
                                        <Clock size={24} className="shrink-0"/> 
                                        เวลาสอบ: {currentExam.timeLimit / 60} นาที
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={startExam} 
                                    className="w-full bg-slate-800 text-white py-6 rounded-3xl font-black text-2xl shadow-xl hover:bg-black transition-all active:scale-95 uppercase tracking-wider"
                                >
                                    เริ่มสอบ
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Exam */}
                    {step === 'exam' && currentExam && (
                        <div className="min-h-screen bg-slate-100 pb-32 animate-fade-in">
                            {/* Watermark */}
                            <Watermark text={`${student?.id} - ${student?.name}`} />
                            
                            {/* Header */}
                            <div className="sticky top-0 bg-white/95 backdrop-blur-md border-b z-20 shadow-md">
                                <div className="px-8 py-5 flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <img src={LOGO_URL} alt="Logo" className="w-10 h-10 hidden sm:block" />
                                        <div className="font-black truncate text-xl tracking-tight">
                                            {currentExam.title}
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <button 
                                            onClick={() => {
                                                if(confirm(`ยืนยันส่งกระดาษคำตอบ?\nคุณตอบไปแล้ว ${currentExam.questions.filter(q => answers[q.id] !== undefined).length} จาก ${currentExam.questions.length} ข้อ`)) 
                                                    submitExam('Manual Submit');
                                            }} 
                                            className="hidden md:flex px-4 py-2 bg-red-600 text-white rounded-xl font-black text-xs uppercase items-center gap-2 hover:bg-red-700 active:scale-95 transition-all shadow-sm"
                                        >
                                            <Send size={14}/> ส่งข้อสอบทันที
                                        </button>
                                        <div className={`px-5 py-2.5 rounded-xl font-mono font-black text-xl border-2 transition-colors ${
                                            timeLeft < 300 
                                                ? 'bg-red-50 border-red-500 text-red-600 animate-pulse'
                                                : 'bg-slate-800 border-slate-800 text-white'
                                        }`}>
                                            {Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}
                                        </div>
                                    </div>
                                </div>
                                <div className="w-full h-2 bg-slate-200">
                                    <div className="h-full bg-blue-600 transition-all duration-500" style={{width: `${progress}%`}}></div>
                                </div>
                                <div className="bg-blue-50 px-8 py-1.5 flex justify-between items-center border-b border-blue-100">
                                    <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest">ความคืบหน้า: {progress}%</span>
                                    <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest">ตอบแล้ว: {currentExam.questions.filter(q => answers[q.id] !== undefined).length} / {currentExam.questions.length}</span>
                                </div>
                            </div>

                            {/* Question Navigation */}
                            <div className="max-w-5xl mx-auto p-4 md:p-10 space-y-8">
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                    <div className="flex items-center gap-2 mb-4 text-slate-400 font-black text-[10px] uppercase tracking-widest">
                                        <List size={14}/> แผนที่ข้อสอบ
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {currentExam.questions.map((q, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => setCurrentQIdx(idx)} 
                                                className={`w-10 h-10 rounded-xl font-black text-sm transition-all border-2 flex items-center justify-center ${
                                                    currentQIdx === idx 
                                                        ? 'border-blue-600 bg-blue-50 text-blue-600 scale-110 shadow-md ring-2 ring-blue-100' 
                                                        : answers[q.id] !== undefined 
                                                        ? 'bg-green-500 border-green-500 text-white' 
                                                        : 'bg-white border-slate-200 text-slate-400 hover:border-slate-300'
                                                }`}
                                            >
                                                {idx + 1}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {/* Current Question */}
                                <div className="bg-white p-10 md:p-16 rounded-[4rem] shadow-2xl relative overflow-hidden border border-white">
                                    <div className="absolute top-0 right-0 p-8 opacity-[0.03] text-[12rem] font-black select-none pointer-events-none tracking-tighter leading-none">
                                        # {currentQIdx + 1}
                                    </div>
                                    
                                    {currentExam.questions[currentQIdx].passage && currentExam.questions[currentQIdx].passagePosition !== 'bottom' && (
                                        <div className="bg-amber-50 border-l-[10px] border-amber-400 p-8 mb-10 rounded-r-[2.5rem] text-slate-700 italic whitespace-pre-wrap font-black text-lg">
                                            <BookOpen size={24} className="inline mr-4 mb-1 text-amber-600"/>
                                            {currentExam.questions[currentQIdx].passage}
                                        </div>
                                    )}
                                    
                                    <div className="relative mb-12">
                                        <h3 className="text-3xl font-black text-slate-800 leading-tight tracking-tight">
                                            {currentExam.questions[currentQIdx].text}
                                        </h3>
                                    </div>
                                    
                                    {currentExam.questions[currentQIdx].passage && currentExam.questions[currentQIdx].passagePosition === 'bottom' && (
                                        <div className="bg-amber-50 border-l-[10px] border-amber-400 p-8 mb-12 rounded-r-[2.5rem] text-slate-700 italic whitespace-pre-wrap font-black text-lg">
                                            <BookOpen size={24} className="inline mr-4 mb-1 text-amber-600"/>
                                            {currentExam.questions[currentQIdx].passage}
                                        </div>
                                    )}
                                    
                                    <div className="grid gap-5">
                                        {currentExam.questions[currentQIdx].options.map((opt, i) => (
                                            <label 
                                                key={i} 
                                                className={`flex items-center p-8 border-2 rounded-[2.5rem] cursor-pointer transition-all active:scale-[0.98] group ${
                                                    answers[currentExam.questions[currentQIdx].id] === i 
                                                        ? 'bg-blue-600 border-blue-600 text-white shadow-2xl ring-8 ring-blue-100 font-bold'
                                                        : 'bg-slate-50 border-transparent text-slate-600 hover:bg-white hover:border-blue-100 hover:shadow-lg'
                                                }`}
                                            >
                                                <input 
                                                    type="radio" 
                                                    className="hidden" 
                                                    checked={answers[currentExam.questions[currentQIdx].id] === i}
                                                    onChange={() => {
                                                        setAnswers({
                                                            ...answers, 
                                                            [currentExam.questions[currentQIdx].id]: i
                                                        });
                                                        answersRef.current = {
                                                            ...answersRef.current,
                                                            [currentExam.questions[currentQIdx].id]: i
                                                        };
                                                    }}
                                                />
                                                <div className={`w-12 h-12 rounded-2xl border-2 mr-6 flex items-center justify-center font-black text-xl transition-all ${
                                                    answers[currentExam.questions[currentQIdx].id] === i
                                                        ? 'bg-white text-blue-600 border-white'
                                                        : 'bg-white text-slate-300 border-slate-200'
                                                }`}>
                                                    {String.fromCharCode(3601 + i)}
                                                </div>
                                                <span className="text-2xl leading-tight font-black">{opt}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>

                                {/* Navigation Buttons */}
                                <div className="flex justify-between items-center px-4">
                                    <button 
                                        onClick={() => setCurrentQIdx(p => Math.max(0, p - 1))} 
                                        disabled={currentQIdx === 0} 
                                        className="px-8 py-4 bg-white text-slate-600 border-2 border-slate-200 rounded-3xl font-black disabled:opacity-30 hover:bg-slate-50 shadow-sm transition-all uppercase"
                                    >
                                        ย้อนกลับ
                                    </button>
                                    
                                    <div className="text-slate-400 font-black text-sm hidden sm:block uppercase tracking-tighter">
                                        ข้อที่ {currentQIdx + 1} / {currentExam.questions.length}
                                    </div>
                                    
                                    {currentQIdx < currentExam.questions.length - 1 ? (
                                        <button 
                                            onClick={() => setCurrentQIdx(p => p + 1)} 
                                            className="px-10 py-4 bg-slate-800 text-white rounded-2xl font-black shadow-lg hover:bg-black transition-all active:scale-95 uppercase"
                                        >
                                            ถัดไป
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={() => {
                                                if(confirm("ยืนยันส่งกระดาษคำตอบ?")) 
                                                    submitExam('User Submitted');
                                            }} 
                                            className="px-12 py-4 bg-green-600 text-white rounded-2xl font-black shadow-xl hover:bg-green-700 transition-all active:scale-95 uppercase text-lg"
                                        >
                                            ส่งข้อสอบ
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Admin Dashboard */}
                    {step === 'admin_dashboard' && (
                        <div className="p-4 md:p-8 max-w-7xl mx-auto animate-fade-in">
                            <div className="glass-card rounded-3xl shadow-2xl min-h-[85vh] flex flex-col overflow-hidden bg-white/60">
                                <div className="p-4 border-b flex justify-between items-center bg-white/80 overflow-x-auto gap-4 shadow-sm">
                                    <div className="flex gap-2 bg-slate-100 p-1.5 rounded-2xl shrink-0">
                                        <button onClick={() => setAdminTab('dashboard')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'dashboard' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <RefreshCw size={16}/> ภาพรวม
                                        </button>
                                        <button onClick={() => setAdminTab('manage_exams')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'manage_exams' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <List size={16}/> จัดการข้อสอบ
                                        </button>
                                        <button onClick={() => setAdminTab('manage_students')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'manage_students' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <Users size={16}/> จัดการนักเรียน
                                        </button>
                                        <button onClick={() => setAdminTab('security')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'security' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <Lock size={16}/> ความปลอดภัย
                                        </button>
                                        <button onClick={() => setAdminTab('create_exam')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'create_exam' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <Plus size={16}/> สร้างข้อสอบ
                                        </button>
                                    </div>
                                    <button onClick={() => { setStep('login'); setAdminPassword(''); cleanupListeners(); }} className="p-3 bg-red-50 text-red-500 hover:bg-red-500 hover:text-white rounded-2xl transition-all shadow-sm">
                                        <LogOut size={20}/>
                                    </button>
                                </div>
                                
                                <div className="p-8 overflow-y-auto flex-1">
                                    {adminTab === 'dashboard' && (
                                        <div className="space-y-10">
                                            {/* Dashboard content - same as before */}
                                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                                                <div className="lg:col-span-8 bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl space-y-8">
                                                    <h3 className="font-black text-2xl uppercase tracking-tighter flex items-center gap-3">
                                                        <Shield className="text-blue-600" size={32}/> แผงควบคุม
                                                    </h3>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                                        <div>
                                                            <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
                                                                วิชาที่จะเปิด
                                                            </label>
                                                            <div className="relative">
                                                                <select 
                                                                    value={systemConfig.activeExamId} 
                                                                    onChange={e => handleChangeExamSubject(e.target.value)} 
                                                                    className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl appearance-none shadow-sm"
                                                                >
                                                                    <option value="">เลือกวิชา</option>
                                                                    {exams.map(e => (
                                                                        <option key={e.id} value={e.id}>
                                                                            {e.id} | {e.title}
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                                <div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                                                    <ChevronDown size={24}/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
                                                                ห้องเรียนที่สอบได้
                                                            </label>
                                                            <div className="relative">
                                                                <select 
                                                                    value={adminClassroomInput} 
                                                                    onChange={e => setAdminClassroomInput(e.target.value)} 
                                                                    className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl appearance-none shadow-sm"
                                                                >
                                                                    <option value="All">ทุกห้องเรียน</option>
                                                                    {availableClassrooms.map(room => (
                                                                        <option key={room} value={room}>
                                                                            เฉพาะห้อง {room}
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                                <div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                                                    <ChevronDown size={24}/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div className="md:col-span-2">
                                                            <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
                                                                เวลาสอบ (นาที)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                value={adminTimeLimitInput} 
                                                                onChange={e => setAdminTimeLimitInput(e.target.value)} 
                                                                className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl shadow-inner" 
                                                                min="1"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="lg:col-span-4 space-y-6">
                                                    {selectedExamPreview ? (
                                                        <div className="bg-slate-900 text-white p-10 rounded-[3.5rem] shadow-2xl space-y-6 relative overflow-hidden">
                                                            <h4 className="text-3xl font-black leading-tight tracking-tight">
                                                                {selectedExamPreview.title}
                                                            </h4>
                                                            <div className="pt-6 border-t border-white/10 space-y-3">
                                                                <p className="text-xs opacity-60">จำนวนข้อ: {selectedExamPreview.questions?.length || 0} ข้อ</p>
                                                                <p className="text-xs opacity-60">เวลา: {selectedExamPreview.timeLimit / 60} นาที</p>
                                                            </div>
                                                            <button 
                                                                onClick={() => handleToggleExam(!systemConfig.isOpen)} 
                                                                className={`w-full py-5 rounded-[2rem] font-black text-xl transition-all shadow-2xl active:scale-95 uppercase ${
                                                                    systemConfig.isOpen ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'
                                                                }`}
                                                            >
                                                                {systemConfig.isOpen ? 'ปิดระบบสอบ' : 'เปิดระบบสอบ'}
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <div className="bg-white border-4 border-dashed border-slate-100 p-16 rounded-[3.5rem] text-center text-slate-400 font-black">
                                                            กรุณาเลือกวิชา
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            {/* Live Monitor */}
                                            <div className="pt-10 space-y-6">
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-center gap-6">
                                                        <h4 className="font-black text-2xl uppercase tracking-tighter">
                                                            ติดตามสถานะ
                                                        </h4>
                                                        <div className="flex items-center gap-3 bg-white p-2 border-2 border-slate-50 rounded-2xl">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-2">
                                                                แสดงห้อง:
                                                            </label>
                                                            <select 
                                                                value={monitorFilterRoom} 
                                                                onChange={e => setMonitorFilterRoom(e.target.value)} 
                                                                className="bg-transparent font-black text-blue-600 outline-none text-sm cursor-pointer pr-4"
                                                            >
                                                                <option value="All">ทุกห้องเรียน</option>
                                                                {availableClassrooms.map(room => (
                                                                    <option key={room} value={room}>
                                                                        ห้อง {room}
                                                                    </option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <button 
                                                        onClick={exportToCSV} 
                                                        className="text-xs bg-emerald-50 text-emerald-700 px-6 py-3 rounded-2xl border-2 border-emerald-100 hover:bg-emerald-100 font-black uppercase flex items-center gap-2"
                                                    >
                                                        <Download size={18}/> ส่งออกรายงาน
                                                    </button>
                                                </div>

                                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                                    {dashboardData
                                                        .filter(d => monitorFilterRoom === 'All' || String(d.classroom).trim() === monitorFilterRoom.trim())
                                                        .map((d, i) => (
                                                            <div 
                                                                key={i} 
                                                                className={`bg-white p-6 rounded-[2.5rem] border-2 flex flex-col justify-between shadow-sm transition-all hover:shadow-lg ${
                                                                    d.status === 'COMPLETED' 
                                                                        ? 'border-emerald-100 ring-4 ring-emerald-400/10' 
                                                                        : d.status === 'IN_PROGRESS' 
                                                                        ? 'border-blue-100 ring-4 ring-blue-400/10 animate-pulse' 
                                                                        : 'border-slate-50 opacity-60'
                                                                }`}
                                                            >
                                                                <div className="flex justify-between items-start">
                                                                    <span className="font-black text-[10px] text-slate-400 tracking-tighter uppercase">
                                                                        {d.id}
                                                                    </span>
                                                                    <div className="flex gap-1 items-center">
                                                                        <button 
                                                                            onClick={() => handleResetSubmission(d.id)} 
                                                                            className="p-1 text-red-400 hover:text-red-600 transition-colors" 
                                                                            title="รีเซ็ตสถานะการสอบ"
                                                                        >
                                                                            <RefreshCw size={14}/>
                                                                        </button>
                                                                        <span className={`text-[9px] px-3 py-1 rounded-full font-black uppercase tracking-widest ${
                                                                            d.status === 'COMPLETED' 
                                                                                ? 'bg-emerald-100 text-emerald-700' 
                                                                                : d.status === 'IN_PROGRESS' 
                                                                                ? 'bg-blue-100 text-blue-700' 
                                                                                : 'bg-slate-100 text-slate-400'
                                                                        }`}>
                                                                            {d.status}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <div className="text-lg font-black truncate py-6 border-b-2 border-slate-50 mb-6">
                                                                    {d.name} {d.surname}
                                                                </div>
                                                                <div className="flex justify-between items-end">
                                                                    <div className="flex flex-col">
                                                                        <span className="text-[9px] text-slate-300 font-black uppercase">
                                                                            คะแนน
                                                                        </span>
                                                                        <span className="text-4xl font-black text-slate-900 leading-none">
                                                                            {d.score ?? '-'}
                                                                        </span>
                                                                    </div>
                                                                    <span className="text-[10px] font-black text-slate-300 uppercase">
                                                                        ห้อง {d.classroom}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {adminTab === 'manage_students' && renderManageStudents()}
                                    {adminTab === 'manage_exams' && renderManageExams()}
                                    {adminTab === 'create_exam' && renderCreateExam()}
                                    
                                    {adminTab === 'security' && (
                                        <div className="space-y-6">
                                            <div className="max-w-md mx-auto bg-white p-10 rounded-[3rem] border-2 border-slate-50 shadow-xl">
                                                <h3 className="font-black text-2xl uppercase tracking-tighter mb-8 flex items-center gap-3">
                                                    <Lock size={32} className="text-blue-600"/> รหัสผ่านแอดมิน
                                                </h3>
                                                <div className="space-y-6">
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">
                                                            รหัสผ่านใหม่
                                                        </label>
                                                        <input 
                                                            type="text" 
                                                            value={newAdminPassword} 
                                                            onChange={e => setNewAdminPassword(e.target.value)} 
                                                            className="w-full p-5 border-2 border-slate-50 rounded-2xl outline-none font-black bg-slate-50 focus:bg-white" 
                                                            placeholder="รหัสผ่านใหม่"
                                                        />
                                                    </div>
                                                    <button 
                                                        onClick={handleChangeAdminPassword} 
                                                        className="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase"
                                                    >
                                                        เปลี่ยนรหัสผ่าน
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SecureExamApp />);
    </script>
</body>
</html>
