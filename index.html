<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบออนไลน์ (Secure Exam) - Admin Console</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; user-select: none; -webkit-user-select: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .watermark-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 9000; overflow: hidden; opacity: 0.08;
            display: flex; flex-wrap: wrap; justify-content: space-around; align-content: space-around;
        }
        .watermark-text {
            transform: rotate(-45deg); font-size: 20px; font-weight: bold; color: #333; margin: 50px;
        }
        @media print { html, body { display: none !important; background-color: #000 !important; } }
        /* Animation */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen text-slate-800 notranslate" translate="no">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBhwr9Fxejg1hoAqbSkvUUq_RGZCwCskqc",
            authDomain: "chinesetest2-68.firebaseapp.com",
            databaseURL: "https://chinesetest2-68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chinesetest2-68",
            storageBucket: "chinesetest2-68.firebasestorage.app",
            messagingSenderId: "150596319988",
            appId: "1:150596319988:web:a7cc730d4c2bae21047ca1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // Expose Firebase to Window for React
        window.db = db;
        window.fb = { collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where };
    </script>

    <script type="text/babel">
        // --- Icons ---
        const Icon = ({ path, className, size = 24 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>);
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const FileText = (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const LogOut = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const Shield = (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const Upload = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />;
        const HelpCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" x2="12.01" y1="17" y2="17"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const User = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const XCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const Edit = (props) => <Icon {...props} path={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />;
        const Save = (props) => <Icon {...props} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></>} />;
        const List = (props) => <Icon {...props} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />;

        const { useState, useEffect, useRef } = React;
        const LOGO_URL = "https://img2.pic.in.th/pic/Logoc404dc85753b800c.png";

        // --- Components ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[9999] flex items-center justify-center">
                <div className="bg-white/95 p-8 rounded-2xl shadow-2xl flex flex-col items-center border border-white/50 animate-bounce-slight max-w-sm w-full mx-4">
                    <div className="relative mb-6"><div className="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div></div>
                    <h3 className="text-xl font-bold text-slate-800 text-center animate-pulse">{message || 'กำลังประมวลผล...'}</h3>
                </div>
            </div>
        );

        const BlackoutOverlay = () => (
            <div className="fixed inset-0 bg-black z-[10000] flex items-center justify-center text-white p-8 text-center">
                <div><AlertTriangle size={64} className="mx-auto mb-4 text-red-500 animate-bounce" /><h2 className="text-3xl font-bold mb-2">ห้ามแคปภาพหน้าจอ!</h2><p className="text-gray-400">ระบบได้บันทึกความพยายามในการบันทึกภาพหน้าจอของคุณแล้ว</p></div>
            </div>
        );

        const Watermark = ({ text }) => {
            const items = Array.from({ length: 12 });
            return (<div className="watermark-container">{items.map((_, i) => <div key={i} className="watermark-text">{text}</div>)}</div>);
        };

        const LogoHeader = ({ title, subtitle, className = "" }) => (
            <div className={`flex flex-col items-center mb-8 ${className}`}>
                <img src={LOGO_URL} alt="Logo" className="w-24 h-auto drop-shadow-md mb-4 animate-float" />
                {title && <h2 className="text-2xl font-bold text-slate-800 text-center">{title}</h2>}
                {subtitle && <p className="text-slate-500 text-sm text-center mt-1">{subtitle}</p>}
            </div>
        );

        const TemplateModal = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/60 z-[9998] flex items-center justify-center p-4" onClick={onClose}>
                <div className="bg-white rounded-2xl max-w-lg w-full p-6 shadow-2xl relative" onClick={e => e.stopPropagation()}>
                    <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-red-500"><XCircle size={24}/></button>
                    <h3 className="text-xl font-bold text-slate-800 mb-4 flex items-center gap-2"><FileText className="text-sky-600"/> รูปแบบไฟล์ Word</h3>
                    <div className="bg-gray-50 p-4 rounded-xl border border-gray-200 text-sm font-mono text-slate-700 mb-4 overflow-x-auto">
                        <p>1. โจทย์ข้อที่หนึ่ง?</p><p>ก. ตัวเลือก 1</p><p>ข. ตัวเลือก 2</p><p>ค. ตัวเลือก 3</p><p>ง. ตัวเลือก 4</p><p className="font-bold text-green-600">เฉลย: ข</p>
                    </div>
                    <button onClick={onClose} className="mt-6 w-full bg-sky-600 text-white py-2 rounded-xl font-bold hover:bg-sky-700">เข้าใจแล้ว</button>
                </div>
            </div>
        );

        const EditExamModal = ({ exam, onClose, onSave }) => {
            const [data, setData] = useState({ title: exam.title, time: exam.timeLimit / 60 });
            return (
                <div className="fixed inset-0 bg-black/60 z-[9998] flex items-center justify-center p-4" onClick={onClose}>
                    <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl animate-fade-in" onClick={e => e.stopPropagation()}>
                        <h3 className="text-xl font-bold mb-4 flex items-center gap-2"><Edit size={20} className="text-blue-600"/> แก้ไขรายวิชา: {exam.id}</h3>
                        <div className="space-y-4">
                            <div><label className="block text-sm font-bold text-slate-600 mb-1">ชื่อวิชา</label><input type="text" value={data.title} onChange={e=>setData({...data, title: e.target.value})} className="w-full p-3 border rounded-xl" /></div>
                            <div><label className="block text-sm font-bold text-slate-600 mb-1">เวลาสอบมาตรฐาน (นาที)</label><input type="number" value={data.time} onChange={e=>setData({...data, time: e.target.value})} className="w-full p-3 border rounded-xl" /></div>
                        </div>
                        <div className="mt-6 flex gap-3">
                            <button onClick={onClose} className="flex-1 py-2 border rounded-xl text-slate-500 hover:bg-slate-50">ยกเลิก</button>
                            <button onClick={()=>onSave(exam.id, data)} className="flex-1 py-2 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700">บันทึก</button>
                        </div>
                    </div>
                </div>
            );
        };

        const SecureExamApp = () => {
            // --- State ---
            const [step, setStep] = useState('login'); 
            const [student, setStudent] = useState(null);
            const [studentIdInput, setStudentIdInput] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [exams, setExams] = useState([]);
            const [currentExam, setCurrentExam] = useState(null);
            
            // Admin
            const [adminTab, setAdminTab] = useState('dashboard');
            const [adminTimeLimitInput, setAdminTimeLimitInput] = useState(5); 
            const [adminClassroomInput, setAdminClassroomInput] = useState('All');
            const [dashboardData, setDashboardData] = useState([]);
            const [adminElapsedSeconds, setAdminElapsedSeconds] = useState(0);
            const [showTemplateModal, setShowTemplateModal] = useState(false);
            const [editingExam, setEditingExam] = useState(null); // For Edit Modal
            
            // Create Exam
            const [newExam, setNewExam] = useState({ id: '', title: '', time: 60 });
            const [newQuestions, setNewQuestions] = useState([]);
            const [qDraft, setQDraft] = useState({ text: '', options: ['', ''], correct: 0, mediaType: 'none', mediaContent: '' });

            const [systemConfig, setSystemConfig] = useState({ activeExamId: '', isOpen: false, customTimeLimit: 0, activeClassroom: 'All', examOpenedAt: '', examStartMs: 0 });
            
            // Exam Execution
            const [currentQIdx, setCurrentQIdx] = useState(0); 
            const [timeLeft, setTimeLeft] = useState(0);
            const [answers, setAnswers] = useState({});
            const answersRef = useRef({}); 
            const [examStatus, setExamStatus] = useState('pending');
            const [score, setScore] = useState(0);
            const [warningCount, setWarningCount] = useState(0); 
            const [isBlackout, setIsBlackout] = useState(false);
            
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('กำลังประมวลผล...'); 
            const [error, setError] = useState('');
            const timerRef = useRef(null);
            const fileInputRef = useRef(null);

            // --- Effects ---
            useEffect(() => {
                fetchExams();
                const unsub = window.fb.onSnapshot(window.fb.doc(window.db, "config", "system"), (doc) => {
                    if (doc.exists()) {
                        const data = doc.data();
                        setSystemConfig({
                            activeExamId: data.activeExamId,
                            isOpen: data.isOpen,
                            customTimeLimit: data.customTimeLimit || 0,
                            activeClassroom: data.activeClassroom || 'All',
                            examOpenedAt: data.examOpenedAt || '',
                            examStartMs: data.examStartMs || 0
                        });
                    }
                });
                return () => unsub();
            }, []);

            // Dashboard Logic
            useEffect(() => {
                let unsubSubmissions = null;
                if (step === 'admin_dashboard') {
                    setLoading(true);
                    window.fb.getDocs(window.fb.collection(window.db, "students")).then(snap => {
                        const allStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                        const subQuery = window.fb.query(window.fb.collection(window.db, "submissions"), window.fb.where("examId", "==", systemConfig.activeExamId || "NONE"));
                        unsubSubmissions = window.fb.onSnapshot(subQuery, (subSnap) => {
                            const submissions = {};
                            subSnap.forEach(doc => { submissions[doc.data().studentId] = doc.data(); });
                            const combined = allStudents.map(std => {
                                const sub = submissions[std.id];
                                return { ...std, score: sub ? sub.score : undefined, status: sub ? sub.status : 'รอเข้าสอบ', reason: sub ? sub.reason : undefined };
                            });
                            setDashboardData(combined);
                            setLoading(false);
                        });
                    });
                }
                return () => { if(unsubSubmissions) unsubSubmissions(); };
            }, [step, systemConfig.activeExamId]);

            // Timer
            useEffect(() => {
                let timerInterval;
                if (systemConfig.isOpen && systemConfig.examStartMs > 0) {
                    timerInterval = setInterval(() => {
                        const diff = Math.floor((Date.now() - systemConfig.examStartMs) / 1000);
                        setAdminElapsedSeconds(diff >= 0 ? diff : 0);
                    }, 1000);
                } else { setAdminElapsedSeconds(0); }
                return () => clearInterval(timerInterval);
            }, [systemConfig.isOpen, systemConfig.examStartMs]);

            // Auto-Redirect
            useEffect(() => {
                if (step === 'waiting_room' && systemConfig.isOpen && systemConfig.activeExamId) {
                    const configClassroom = String(systemConfig.activeClassroom || 'All').trim();
                    if(configClassroom === 'All' || configClassroom === String(student.classroom).trim()) {
                        prepareExam(systemConfig.activeExamId);
                        setStep('instructions');
                    }
                }
            }, [systemConfig, step, student]);

            const shuffleArray = (array) => {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };

            const fetchExams = async () => {
                try {
                    const snap = await window.fb.getDocs(window.fb.collection(window.db, "exams"));
                    const list = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    setExams(list);
                } catch (err) { console.error("Failed to fetch exams", err); }
            };

            const handleUpdateLiveConfig = async () => {
                if (!systemConfig.isOpen) return;
                setLoading(true); setLoadingMessage('กำลังอัปเดตการตั้งค่า...');
                try {
                    const configRef = window.fb.doc(window.db, "config", "system");
                    await window.fb.updateDoc(configRef, {
                        customTimeLimit: parseInt(adminTimeLimitInput) * 60,
                        activeClassroom: adminClassroomInput
                    });
                    alert("อัปเดตเวลาและห้องเรียบร้อย!");
                } catch (err) { alert("เกิดข้อผิดพลาด: " + err.message); }
                setLoading(false);
            };

            const handleToggleExam = async (isOpen) => {
                setLoading(true); 
                setLoadingMessage(isOpen ? 'กำลังเปิดระบบสอบ...' : 'กำลังปิดระบบสอบ...');
                try {
                    const now = new Date();
                    const openedTime = isOpen ? now.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
                    const startMs = isOpen ? now.getTime() : 0;
                    
                    const configRef = window.fb.doc(window.db, "config", "system");
                    await window.fb.updateDoc(configRef, {
                        isOpen: isOpen,
                        customTimeLimit: isOpen ? parseInt(adminTimeLimitInput) * 60 : systemConfig.customTimeLimit,
                        activeClassroom: isOpen ? adminClassroomInput : systemConfig.activeClassroom,
                        examOpenedAt: openedTime,
                        examStartMs: startMs
                    });
                } catch (err) { alert("เกิดข้อผิดพลาดในการบันทึก: " + err.message); }
                setLoading(false);
            };

            const handleChangeExamSubject = async (examId) => {
                setLoading(true); setLoadingMessage('กำลังเปลี่ยนรายวิชา...');
                try {
                    const selected = exams.find(e => String(e.id) === String(examId));
                    if (selected) setAdminTimeLimitInput(selected.timeLimit / 60);
                    const configRef = window.fb.doc(window.db, "config", "system");
                    await window.fb.updateDoc(configRef, { isOpen: false, activeExamId: examId });
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            // --- Manage Exams CRUD ---
            const handleDeleteExam = async (examId) => {
                if(!confirm(`ยืนยันการลบวิชา ${examId}? การกระทำนี้ไม่สามารถย้อนกลับได้`)) return;
                setLoading(true);
                try {
                    await window.fb.deleteDoc(window.fb.doc(window.db, "exams", examId));
                    alert("ลบวิชาสำเร็จ");
                    fetchExams();
                } catch(e) { alert("Error: "+e.message); }
                setLoading(false);
            };

            const handleUpdateExam = async (examId, newData) => {
                setLoading(true);
                try {
                    await window.fb.updateDoc(window.fb.doc(window.db, "exams", examId), {
                        title: newData.title,
                        timeLimit: parseInt(newData.time) * 60
                    });
                    alert("แก้ไขสำเร็จ");
                    setEditingExam(null);
                    fetchExams();
                } catch(e) { alert("Error: "+e.message); }
                setLoading(false);
            };

            // --- Word Import ---
            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                setLoading(true); setLoadingMessage('กำลังอ่านไฟล์ Word...');
                const reader = new FileReader();
                reader.onload = function(e) {
                    mammoth.extractRawText({arrayBuffer: e.target.result})
                        .then(result => { parseImportedText(result.value); setLoading(false); })
                        .catch(err => { console.error(err); alert("อ่านไฟล์ไม่สำเร็จ"); setLoading(false); });
                };
                reader.readAsArrayBuffer(file);
                event.target.value = null;
            };

            const parseImportedText = (text) => {
                const lines = text.split('\n').map(l => l.trim()).filter(l => l);
                const parsedQuestions = [];
                let currentQ = null;
                const questionStartRegex = /^(\d+)[\.\)]\s+(.*)/;
                const optionRegex = /^([a-zA-Zก-ฮ])[\.\)]\s+(.*)/;
                const answerRegex = /^(เฉลย|Answer|Ans|ans)[:\s]+([a-zA-Zก-ฮ])/i;
                const letterToIndex = (char) => {
                    const c = char.toLowerCase();
                    const thaiMap = {'ก':0, 'ข':1, 'ค':2, 'ง':3, 'จ':4};
                    return thaiMap[char] !== undefined ? thaiMap[char] : c.charCodeAt(0) - 97;
                };

                lines.forEach(line => {
                    const ansMatch = line.match(answerRegex);
                    if (ansMatch && currentQ) { currentQ.correct = letterToIndex(ansMatch[2]); parsedQuestions.push(currentQ); currentQ = null; return; }
                    
                    const qMatch = line.match(questionStartRegex);
                    if (qMatch) {
                        if (currentQ) parsedQuestions.push(currentQ);
                        currentQ = { text: qMatch[2], options: [], correct: 0, mediaType: 'none', mediaContent: '' };
                        return;
                    }

                    const optMatch = line.match(optionRegex);
                    if (optMatch && currentQ) { currentQ.options.push(optMatch[2]); return; }

                    if (currentQ && currentQ.options.length === 0) currentQ.text += " " + line;
                });
                if (currentQ) parsedQuestions.push(currentQ);

                if (parsedQuestions.length > 0) {
                    setNewQuestions(prev => [...prev, ...parsedQuestions]);
                    alert(`นำเข้าสำเร็จ ${parsedQuestions.length} ข้อ`);
                } else alert("ไม่พบข้อสอบในรูปแบบที่กำหนด");
            };

            const handleCreateExamSubmit = async () => {
                if (!newExam.id || !newExam.title || newQuestions.length === 0) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
                setLoading(true); setLoadingMessage('กำลังบันทึกชุดข้อสอบ...');
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "exams", newExam.id), {
                        ...newExam,
                        timeLimit: parseInt(newExam.time) * 60,
                        questions: newQuestions
                    });
                    alert("สร้างข้อสอบสำเร็จ!");
                    setNewExam({ id: '', title: '', time: 60 }); setNewQuestions([]); setAdminTab('manage_exams'); fetchExams();
                } catch (err) { alert("เกิดข้อผิดพลาด: " + err.message); }
                setLoading(false);
            };

            // --- Student Login ---
            const handleStudentLogin = async (e) => {
                e.preventDefault(); setLoading(true); setLoadingMessage('กำลังตรวจสอบข้อมูลนักเรียน...'); setError('');
                try {
                    const docSnap = await window.fb.getDoc(window.fb.doc(window.db, "students", studentIdInput));
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        const sData = { id: docSnap.id, ...data };
                        const activeId = String(systemConfig.activeExamId).trim();
                        if (!sData.assignedExams || !sData.assignedExams.includes(activeId)) {
                            setError(`คุณไม่มีสิทธิ์สอบวิชานี้`); setLoading(false); return;
                        }
                        const cfgRoom = String(systemConfig.activeClassroom || 'All').trim();
                        if (cfgRoom !== 'All' && cfgRoom !== sData.classroom) {
                            setError(`เปิดสอบเฉพาะห้อง ${cfgRoom}`); setLoading(false); return;
                        }
                        setStudent(sData);
                        if (systemConfig.isOpen) { prepareExam(activeId); setStep('instructions'); }
                        else setStep('waiting_room');
                    } else setError('ไม่พบรหัสนักเรียน');
                } catch (err) { setError('การเชื่อมต่อขัดข้อง'); console.error(err); }
                setLoading(false);
            };

            const prepareExam = (examId) => {
                const found = exams.find(e => String(e.id).trim() === String(examId).trim());
                if (found) {
                    let processedExam = JSON.parse(JSON.stringify(found));
                    processedExam.questions = shuffleArray(processedExam.questions).map(q => {
                        const optionsWithMeta = q.options.map((opt, index) => ({ text: opt, isCorrect: index === q.correct }));
                        const shuffled = shuffleArray(optionsWithMeta);
                        return { ...q, options: shuffled.map(o => o.text), correct: shuffled.findIndex(o => o.isCorrect) };
                    });
                    const effectiveTime = systemConfig.customTimeLimit > 0 ? systemConfig.customTimeLimit : found.timeLimit;
                    setCurrentExam({ ...processedExam, timeLimit: effectiveTime });
                }
            };

            const startExam = () => {
                if (!systemConfig.isOpen) { alert("ระบบปิดแล้ว"); window.location.reload(); return; }
                setTimeLeft(currentExam.timeLimit); setStep('exam'); setExamStatus('active'); setCurrentQIdx(0);
                answersRef.current = {}; setAnswers({}); setWarningCount(0);
                timerRef.current = setInterval(() => { 
                    setTimeLeft(p => { if(p <= 1) { submitExam('TimeOut'); return 0; } return p - 1; }); 
                }, 1000);
            };

            const submitExam = async (reason = 'Normal', isCheat = false) => {
                if (examStatus === 'submitted' || examStatus === 'cheated') return;
                clearInterval(timerRef.current);
                setLoading(true); setLoadingMessage('กำลังบันทึกคำตอบ...'); 
                let score = 0;
                const currentAnswers = answersRef.current || {};
                const currentStatus = isCheat ? 'CHEATED' : (reason === 'TimeOut' ? 'TIMEOUT' : 'COMPLETED');
                if(currentExam?.questions) { currentExam.questions.forEach(q => { if(currentAnswers[q.id] === q.correct) score++; }); }
                setScore(score); setExamStatus(isCheat ? 'cheated' : 'submitted');
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "submissions", `${student.id}_${currentExam.id}`), {
                        studentId: student.id, studentName: `${student.name} ${student.surname}`, examId: currentExam.id,
                        score: score, totalScore: currentExam.questions.length, status: currentStatus, reason: reason, answers: currentAnswers, submittedAt: new Date().toISOString()
                    });
                    alert(`บันทึกสำเร็จ!\nคะแนน: ${score}/${currentExam.questions.length}`);
                    window.location.reload();
                } catch(e) { console.error(e); alert("เกิดข้อผิดพลาดในการบันทึก: " + e.message); setLoading(false); }
            };

            // Anti-Cheat
            useEffect(() => {
                if (step !== 'exam') return;
                const handleCheat = () => {
                    if (examStatus === 'submitted' || examStatus === 'cheated') return;
                    setWarningCount(prev => {
                        const newCount = prev + 1;
                        if (newCount <= 2) { alert(`⚠️ แจ้งเตือน ${newCount}/2: ห้ามสลับหน้าจอ`); return newCount; } 
                        else { submitExam("สลับหน้าจอเกินกำหนด", true); return newCount; }
                    });
                };
                const handleVis = () => { if (document.hidden) handleCheat(); };
                const handleKeyDown = (e) => { if (e.key === 'PrintScreen' || (e.ctrlKey && e.shiftKey && e.key === 'S')) { setIsBlackout(true); setTimeout(() => setIsBlackout(false), 2000); alert("ตรวจพบการพยายามแคปหน้าจอ"); } };
                document.addEventListener('visibilitychange', handleVis); document.addEventListener('contextmenu', e => e.preventDefault()); document.addEventListener('keydown', handleKeyDown);
                return () => { document.removeEventListener('visibilitychange', handleVis); document.removeEventListener('contextmenu', e => e.preventDefault()); document.removeEventListener('keydown', handleKeyDown); clearInterval(timerRef.current); };
            }, [step, examStatus]); 

            const exportToCSV = () => {
                const filterRoom = adminClassroomInput;
                const filtered = dashboardData.filter(d => filterRoom === 'All' || String(d.classroom) === String(filterRoom));
                if (filtered.length === 0) { alert("ไม่มีข้อมูล"); return; }
                const headers = ["ID", "Name", "Surname", "Class", "Score", "Status", "Reason"];
                const rows = filtered.map(d => [ `'${d.id}`, `"${d.name}"`, `"${d.surname}"`, `"${d.classroom}"`, d.score !== undefined ? d.score : "-", `"${d.status || 'รอสอบ'}"`, `"${d.reason || '-'}"` ]);
                const csvContent = "\ufeff" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const url = URL.createObjectURL(new Blob([csvContent], { type: 'text/csv;charset=utf-8;' }));
                const link = document.createElement("a");
                link.href = url; link.download = `Exam_Report_${new Date().getTime()}.csv`;
                link.click();
            };

            const handleAdminLogin = (e) => { e.preventDefault(); if(adminPassword === 'admin1234') { setStep('admin_dashboard'); } else { alert('รหัสผิด'); } };
            const addQuestionToDraft = () => { if (!qDraft.text || qDraft.options.some(o => !o.trim())) return alert("กรอกข้อมูลให้ครบ"); setNewQuestions([...newQuestions, { ...qDraft }]); setQDraft({ text: '', options: ['', ''], correct: 0, mediaType: 'none', mediaContent: '' }); };

            // Render
            return (
                <>
                    {loading && <LoadingOverlay message={loadingMessage} />}
                    {isBlackout && <BlackoutOverlay />}
                    {showTemplateModal && <TemplateModal onClose={() => setShowTemplateModal(false)} />}
                    {editingExam && <EditExamModal exam={editingExam} onClose={()=>setEditingExam(null)} onSave={handleUpdateExam} />}
                    {step === 'exam' && student && <Watermark text={`${student.id} - ${student.name}`} />}
                    
                    {step === 'login' && (
                        <div className="min-h-screen flex flex-col items-center justify-center p-4">
                            <div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md relative overflow-hidden">
                                <button onClick={() => setStep('admin_login')} className="absolute top-4 right-4 text-slate-400 p-2 hover:bg-sky-50 rounded-full"><Shield size={20}/></button>
                                <LogoHeader title="เข้าสู่ระบบสอบ" subtitle="Secure Exam System (Firestore)" />
                                <form onSubmit={handleStudentLogin} className="space-y-5">
                                    <input type="text" value={studentIdInput} onChange={(e) => setStudentIdInput(e.target.value)} className="w-full px-5 py-3 border rounded-xl text-lg text-center tracking-widest" placeholder="รหัสนักเรียน" required />
                                    {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-xl flex items-center gap-2"><AlertTriangle size={18}/>{error}</div>}
                                    <button type="submit" disabled={loading} className="w-full bg-blue-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-blue-700 transition">เข้าสู่ระบบ</button>
                                </form>
                            </div>
                        </div>
                    )}

                    {step === 'admin_login' && (
                        <div className="min-h-screen flex items-center justify-center p-4">
                            <div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-sm">
                                <LogoHeader title="ผู้ดูแลระบบ" />
                                <form onSubmit={handleAdminLogin} className="space-y-4">
                                    <input type="password" value={adminPassword} onChange={e=>setAdminPassword(e.target.value)} className="w-full px-5 py-3 border rounded-xl text-center" placeholder="รหัสผ่าน Admin" autoFocus/>
                                    <button className="w-full bg-slate-800 text-white font-bold py-3 rounded-xl">Login</button>
                                </form>
                                <button onClick={()=>setStep('login')} className="w-full text-sm text-center mt-6 text-slate-500">กลับหน้าหลัก</button>
                            </div>
                        </div>
                    )}

                    {step === 'admin_dashboard' && (
                        <div className="min-h-screen p-4 md:p-8">
                            <div className="max-w-6xl mx-auto glass-card rounded-2xl shadow-2xl min-h-[80vh] overflow-hidden">
                                <div className="bg-white/50 p-6 border-b flex justify-between items-center">
                                    <div className="flex gap-2">
                                        <button onClick={()=>setAdminTab('dashboard')} className={`px-4 py-2 rounded-lg font-bold transition ${adminTab==='dashboard'?'bg-blue-100 text-blue-700':'text-slate-500 hover:bg-slate-50'}`}>Dashboard</button>
                                        <button onClick={()=>setAdminTab('manage_exams')} className={`px-4 py-2 rounded-lg font-bold transition ${adminTab==='manage_exams'?'bg-blue-100 text-blue-700':'text-slate-500 hover:bg-slate-50'}`}>จัดการคลังข้อสอบ</button>
                                        <button onClick={()=>setAdminTab('create_exam')} className={`px-4 py-2 rounded-lg font-bold transition ${adminTab==='create_exam'?'bg-blue-100 text-blue-700':'text-slate-500 hover:bg-slate-50'}`}>สร้างข้อสอบใหม่</button>
                                    </div>
                                    <button onClick={()=>{setStep('login'); setAdminPassword('');}}><LogOut size={20}/></button>
                                </div>
                                <div className="p-6">
                                    {adminTab === 'manage_exams' && (
                                        <div className="animate-fade-in">
                                            <h3 className="font-bold text-lg text-slate-700 mb-4 flex items-center gap-2"><List size={20}/> รายวิชาทั้งหมดในระบบ</h3>
                                            <div className="grid gap-4">
                                                {exams.map(ex => (
                                                    <div key={ex.id} className="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row justify-between items-center gap-4">
                                                        <div className="flex-1">
                                                            <div className="flex items-center gap-3 mb-1"><span className="bg-slate-100 text-slate-600 font-mono font-bold px-2 py-0.5 rounded text-sm">{ex.id}</span> <span className="font-bold text-lg text-slate-800">{ex.title}</span></div>
                                                            <div className="text-slate-500 text-sm flex gap-4"><span>เวลา: {ex.timeLimit/60} นาที</span><span>จำนวน: {ex.questions?.length || 0} ข้อ</span></div>
                                                        </div>
                                                        <div className="flex gap-2">
                                                            <button onClick={()=>setEditingExam(ex)} className="px-4 py-2 border border-slate-200 text-slate-600 rounded-lg hover:bg-slate-50 flex items-center gap-2"><Edit size={16}/> แก้ไข</button>
                                                            <button onClick={()=>handleDeleteExam(ex.id)} className="px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-lg hover:bg-red-100 flex items-center gap-2"><Trash size={16}/> ลบ</button>
                                                        </div>
                                                    </div>
                                                ))}
                                                {exams.length === 0 && <div className="text-center p-8 text-slate-400">ยังไม่มีรายวิชา</div>}
                                            </div>
                                        </div>
                                    )}

                                    {adminTab === 'create_exam' && (
                                        <div className="space-y-6 animate-fade-in">
                                            <div className="bg-emerald-50 p-6 rounded-xl border border-emerald-100 flex items-center justify-between">
                                                <div className="flex items-center gap-3"><FileText size={24} className="text-emerald-600"/><div><h3 className="font-bold text-emerald-900">นำเข้าจาก Word</h3><p className="text-sm text-emerald-700">อัปโหลด .docx</p></div></div>
                                                <div className="flex gap-2">
                                                    <button onClick={() => setShowTemplateModal(true)} className="text-sm text-emerald-700 underline flex items-center gap-1"><HelpCircle size={16}/> ตัวอย่าง</button>
                                                    <label className="bg-emerald-600 text-white px-4 py-2 rounded-lg cursor-pointer flex gap-2"><Upload size={18}/> เลือกไฟล์ <input type="file" ref={fileInputRef} accept=".docx" onChange={handleFileSelect} className="hidden" /></label>
                                                </div>
                                            </div>
                                            <div className="bg-sky-50 p-6 rounded-xl border border-sky-100 grid grid-cols-3 gap-4">
                                                <input type="text" placeholder="รหัสวิชา (ID)" value={newExam.id} onChange={e=>setNewExam({...newExam, id: e.target.value})} className="p-3 border rounded-lg" />
                                                <input type="text" placeholder="ชื่อวิชา" value={newExam.title} onChange={e=>setNewExam({...newExam, title: e.target.value})} className="p-3 border rounded-lg" />
                                                <input type="number" placeholder="เวลา (นาที)" value={newExam.time} onChange={e=>setNewExam({...newExam, time: e.target.value})} className="p-3 border rounded-lg" />
                                            </div>
                                            <div className="bg-white p-6 rounded-xl border">
                                                <h3 className="font-bold mb-4">เพิ่มข้อสอบ ({newQuestions.length + 1})</h3>
                                                <input type="text" placeholder="คำถาม..." value={qDraft.text} onChange={e=>setQDraft({...qDraft, text: e.target.value})} className="w-full p-3 border rounded-lg mb-4" />
                                                {qDraft.options.map((opt, i) => (
                                                    <div key={i} className="flex gap-2 mb-2"><input type="radio" checked={qDraft.correct === i} onChange={()=>setQDraft({...qDraft, correct: i})} /><input type="text" value={opt} onChange={e=>{const n=[...qDraft.options];n[i]=e.target.value;setQDraft({...qDraft, options:n})}} className="flex-1 p-2 border rounded" placeholder={`ตัวเลือก ${i+1}`}/></div>
                                                ))}
                                                <button onClick={()=>setQDraft(p=>({...p, options:[...p.options,'']}))} className="text-sm text-blue-600">+ เพิ่มตัวเลือก</button>
                                                <div className="mt-4"><button onClick={addQuestionToDraft} className="bg-blue-600 text-white px-6 py-2 rounded-lg">เพิ่มข้อสอบ</button></div>
                                            </div>
                                            <div className="pt-6 border-t"><button onClick={handleCreateExamSubmit} className="w-full bg-green-600 text-white py-3 rounded-xl font-bold">บันทึกชุดข้อสอบ</button></div>
                                        </div>
                                    )}

                                    {adminTab === 'dashboard' && (
                                        <div className="animate-fade-in">
                                            <div className="bg-slate-50 p-6 rounded-xl mb-6 grid grid-cols-4 gap-4 items-end">
                                                <div><label className="text-xs font-bold block mb-2">วิชา</label><select value={systemConfig.activeExamId} onChange={(e)=>handleChangeExamSubject(e.target.value)} className="w-full p-3 border rounded-xl">{exams.map(e=><option key={e.id} value={e.id}>{e.id} {e.title}</option>)}</select></div>
                                                <div><label className="text-xs font-bold block mb-2">ห้อง</label><input type="text" value={adminClassroomInput} onChange={e=>setAdminClassroomInput(e.target.value)} className="w-full p-3 border rounded-xl"/></div>
                                                <div><label className="text-xs font-bold block mb-2">เวลา (นาที)</label><input type="number" value={adminTimeLimitInput} onChange={e=>setAdminTimeLimitInput(e.target.value)} className="w-full p-3 border rounded-xl"/></div>
                                                <div className="flex gap-2">
                                                    {systemConfig.isOpen ? 
                                                        <button onClick={handleUpdateLiveConfig} className="flex-1 p-3 bg-blue-500 text-white rounded-xl font-bold hover:bg-blue-600 text-sm">อัปเดต</button> : null
                                                    }
                                                    <button onClick={()=>handleToggleExam(!systemConfig.isOpen)} className={`flex-1 p-3 rounded-xl font-bold text-white ${systemConfig.isOpen ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'}`}>{systemConfig.isOpen ? 'ปิดสอบ' : 'เปิดสอบ'}</button>
                                                </div>
                                            </div>
                                            <div className="flex justify-between mb-4"><h3 className="font-bold">รายชื่อนักเรียน</h3><button onClick={exportToCSV} className="text-sm bg-green-50 text-green-700 px-4 py-2 rounded-lg border border-green-200 flex gap-2"><Download size={16}/> Export CSV</button></div>
                                            <div className="grid grid-cols-4 gap-4">
                                                {dashboardData.filter(d => adminClassroomInput === 'All' || d.classroom === adminClassroomInput).map((d, i) => (
                                                    <div key={i} className={`p-4 rounded-xl border ${d.status==='COMPLETED'?'bg-green-50 border-green-200':d.status==='IN_PROGRESS'?'bg-blue-50 border-blue-200':'bg-white'}`}>
                                                        <div className="flex justify-between"><span className="font-bold">{d.id}</span><span className="text-xs">{d.status}</span></div>
                                                        <div className="truncate">{d.name}</div>
                                                        <div className="text-right font-bold text-xl">{d.score !== undefined ? d.score : '-'}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {step === 'waiting_room' && (
                        <div className="min-h-screen flex items-center justify-center p-4">
                            <div className="glass-card p-10 rounded-2xl w-full max-w-md text-center">
                                <h2 className="text-2xl font-bold mb-4">ห้องพักรอสอบ</h2>
                                <div className="text-6xl mb-6 animate-bounce">⏳</div>
                                <p className="text-slate-500">วิชา: <span className="font-bold text-slate-800">{currentExam?.title || 'รอครูเปิดระบบ...'}</span></p>
                            </div>
                        </div>
                    )}

                    {step === 'instructions' && (
                        <div className="min-h-screen flex items-center justify-center p-4">
                            <div className="glass-card p-8 rounded-3xl w-full max-w-lg">
                                <h2 className="text-2xl font-bold mb-6 border-b pb-4">กฎระเบียบ</h2>
                                <div className="space-y-4 mb-8">
                                    <div className="flex gap-4 items-center"><XCircle className="text-red-500"/> ห้ามสลับหน้าจอ</div>
                                    <div className="flex gap-4 items-center"><AlertTriangle className="text-orange-500"/> ห้ามแคปภาพ</div>
                                    <div className="flex gap-4 items-center"><Clock className="text-blue-500"/> เวลา: {currentExam?.timeLimit / 60} นาที</div>
                                </div>
                                <button onClick={startExam} className="w-full bg-green-600 text-white py-4 rounded-2xl font-bold text-lg">เริ่มทำข้อสอบ</button>
                            </div>
                        </div>
                    )}

                    {step === 'exam' && currentExam && (
                        <div className="min-h-screen bg-slate-50 pb-24">
                            <div className="sticky top-0 bg-white/90 backdrop-blur border-b z-20 px-4 py-3 flex justify-between items-center shadow-sm">
                                <div><h1 className="font-bold truncate">{currentExam.title}</h1><p className="text-xs">{student.name}</p></div>
                                <div className="bg-slate-100 px-3 py-1 rounded-lg font-mono font-bold text-blue-600">{Math.floor(timeLeft/60)}:{String(timeLeft%60).padStart(2,'0')}</div>
                            </div>
                            <div className="max-w-4xl mx-auto p-4 md:p-8">
                                <div className="bg-white p-6 rounded-2xl shadow-sm border mb-6">
                                    <h3 className="text-xl font-bold mb-6">{currentExam.questions[currentQIdx].text}</h3>
                                    <div className="space-y-3">
                                        {currentExam.questions[currentQIdx].options.map((opt, i) => (
                                            <label key={i} className={`flex items-center p-4 border rounded-xl cursor-pointer transition ${answers[currentExam.questions[currentQIdx].id]===i?'bg-blue-50 border-blue-500 ring-1 ring-blue-500':''}`}>
                                                <input type="radio" className="hidden" checked={answers[currentExam.questions[currentQIdx].id]===i} onChange={()=>{setAnswers({...answers,[currentExam.questions[currentQIdx].id]:i}); answersRef.current = {...answers,[currentExam.questions[currentQIdx].id]:i};}} />
                                                <div className={`w-5 h-5 rounded-full border mr-3 flex items-center justify-center ${answers[currentExam.questions[currentQIdx].id]===i?'border-blue-500 bg-blue-500':''}`}>{answers[currentExam.questions[currentQIdx].id]===i&&<div className="w-2 h-2 bg-white rounded-full"/>}</div>
                                                <span>{opt}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div className="flex justify-between">
                                    <button onClick={()=>setCurrentQIdx(p=>Math.max(0,p-1))} disabled={currentQIdx===0} className="px-6 py-3 border rounded-xl disabled:opacity-50">ก่อนหน้า</button>
                                    {currentQIdx < currentExam.questions.length - 1 ? 
                                        <button onClick={()=>setCurrentQIdx(p=>p+1)} className="px-8 py-3 bg-blue-600 text-white rounded-xl">ถัดไป</button> : 
                                        <button onClick={()=>submitExam('User Submitted')} className="px-8 py-3 bg-green-600 text-white rounded-xl font-bold">ส่งคำตอบ</button>
                                    }
                                </div>
                            </div>
                        </div>
                    )}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SecureExamApp />);
    </script>
</body>
</html>
