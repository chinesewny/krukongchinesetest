<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบออนไลน์ (Secure Exam)</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; user-select: none; -webkit-user-select: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        /* Anti-Screenshot Watermark */
        .watermark-container {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 9000;
            overflow: hidden;
            opacity: 0.08;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-around;
            align-content: space-around;
        }
        .watermark-text {
            transform: rotate(-45deg);
            font-size: 20px;
            font-weight: bold;
            color: #333;
            margin: 50px;
        }
        /* REMOVED: Blur content when inactive CSS section */
        @media print {
            html, body { display: none !important; background-color: #000 !important; }
        }
    </style>
    <meta name="google" content="notranslate" />
    <meta http-equiv="Content-Language" content="th" />
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen text-slate-800 notranslate" translate="no">
    <div id="root"></div>

    <script type="text/babel">
        // --- Icons ---
        const Icon = ({ path, className, size = 24 }) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>);
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const FileText = (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const LogOut = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const Shield = (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const PlayCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polygon points="10 8 16 12 10 16 10 8"/></>} />;
        const StopCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><rect width="6" height="6" x="9" y="9"/></>} />;
        const PlusCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="16"/><line x1="8" x2="16" y1="12" y2="12"/></>} />;
        const Image = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></>} />;
        const ChevronRight = (props) => <Icon {...props} path={<polyline points="9 18 15 12 9 6"/>} />;
        const ChevronLeft = (props) => <Icon {...props} path={<polyline points="15 18 9 12 15 6"/>} />;
        const Settings = (props) => <Icon {...props} path={<><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const Trash = (props) => <Icon {...props} path={<><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></>} />;
        const User = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const XCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const School = (props) => <Icon {...props} path={<><path d="m4 6 8-4 8 4"/><path d="m18 10 4 2v8a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2v-8l4-2"/><path d="M14 22v-4a2 2 0 1 0-4 0v4"/><path d="M18 5v17"/><path d="M6 5v17"/><circle cx="12" cy="9" r="2"/></>} />;
        const EyeOff = (props) => <Icon {...props} path={<><path d="M9.88 9.88a3 3 0 1 0 4.24 4.24"/><path d="M10.73 5.08A10.43 10.43 0 0 1 12 5c7 0 10 7 10 7a13.16 13.16 0 0 1-1.67 2.68"/><path d="M6.61 6.61A13.526 13.526 0 0 0 2 12s3 7 10 7a9.74 9.74 0 0 0 5.39-1.61"/><line x1="2" x2="22" y1="2" y2="22"/></>} />;

        const { useState, useEffect, useRef } = React;
        const GAS_API_URL = "https://script.google.com/macros/s/AKfycbwLqt4BQe17ST8aSNzZy78UXZIGL95n7NWux28VrVoqA14Jk9l76Clz3_I8RcgWrII-/exec";
        const LOGO_URL = "https://img2.pic.in.th/pic/Logoc404dc85753b800c.png";

        // --- Loading Overlay Component ---
        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[9999] flex items-center justify-center transition-all duration-300">
                <div className="bg-white/95 p-8 rounded-2xl shadow-2xl flex flex-col items-center border border-white/50 animate-bounce-slight max-w-sm w-full mx-4">
                    <div className="relative mb-6">
                        <div className="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
                        <div className="absolute inset-0 flex items-center justify-center">
                            <div className="w-8 h-8 bg-sky-50 rounded-full shadow-inner"></div>
                        </div>
                    </div>
                    <h3 className="text-xl font-bold text-slate-800 text-center animate-pulse">{message || 'กำลังประมวลผล...'}</h3>
                    <p className="text-slate-500 text-sm mt-2 text-center">กรุณารอสักครู่ ห้ามปิดหน้าต่างนี้</p>
                </div>
            </div>
        );

        // --- Blackout Overlay (Anti-Screenshot) ---
        const BlackoutOverlay = () => (
            <div className="fixed inset-0 bg-black z-[10000] flex items-center justify-center text-white p-8 text-center">
                <div>
                    <AlertTriangle size={64} className="mx-auto mb-4 text-red-500 animate-bounce" />
                    <h2 className="text-3xl font-bold mb-2">ห้ามแคปภาพหน้าจอ!</h2>
                    <p className="text-gray-400">ระบบได้บันทึกความพยายามในการบันทึกภาพหน้าจอของคุณแล้ว</p>
                </div>
            </div>
        );

        // --- Watermark Component (Anti-Screenshot) ---
        const Watermark = ({ text }) => {
            const items = Array.from({ length: 12 });
            return (
                <div className="watermark-container">
                    {items.map((_, i) => (
                        <div key={i} className="watermark-text">{text}</div>
                    ))}
                </div>
            );
        };

        // --- Logo Component ---
        const LogoHeader = ({ title, subtitle, className = "" }) => (
            <div className={`flex flex-col items-center mb-8 ${className}`}>
                <img src={LOGO_URL} alt="Logo" className="w-24 h-auto drop-shadow-md mb-4 animate-float" />
                {title && <h2 className="text-2xl font-bold text-slate-800 text-center">{title}</h2>}
                {subtitle && <p className="text-slate-500 text-sm text-center mt-1">{subtitle}</p>}
            </div>
        );

        const SecureExamApp = () => {
            // --- State ---
            const [step, setStep] = useState('login'); 
            const [student, setStudent] = useState(null);
            const [studentIdInput, setStudentIdInput] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [exams, setExams] = useState([]);
            const [currentExam, setCurrentExam] = useState(null);
            
            // Admin
            const [adminTab, setAdminTab] = useState('dashboard');
            const [adminTimeLimitInput, setAdminTimeLimitInput] = useState(5); 
            const [adminClassroomInput, setAdminClassroomInput] = useState('All');
            const [dashboardData, setDashboardData] = useState([]);
            const [adminElapsedSeconds, setAdminElapsedSeconds] = useState(0);
            
            // Create Exam
            const [newExam, setNewExam] = useState({ id: '', title: '', time: 60 });
            const [newQuestions, setNewQuestions] = useState([]);
            const [qDraft, setQDraft] = useState({ text: '', options: ['', ''], correct: 0, mediaType: 'none', mediaContent: '' });

            const [systemConfig, setSystemConfig] = useState({ activeExamId: '', isOpen: false, customTimeLimit: 0, activeClassroom: 'All', examOpenedAt: '', examStartMs: 0 });
            
            // Exam Execution
            const [currentQIdx, setCurrentQIdx] = useState(0); 
            const [timeLeft, setTimeLeft] = useState(0);
            const [answers, setAnswers] = useState({});
            const answersRef = useRef({}); 
            const [examStatus, setExamStatus] = useState('pending');
            const [cheatReason, setCheatReason] = useState(null);
            const [score, setScore] = useState(0);
            const [warningCount, setWarningCount] = useState(0); 
            const [isBlackout, setIsBlackout] = useState(false); // For screen blackout
            
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState('กำลังประมวลผล...'); 
            const [error, setError] = useState('');
            const timerRef = useRef(null);
            const configIntervalRef = useRef(null);

            // --- Effects ---
            useEffect(() => {
                fetchExams();
                fetchSystemConfig();
                configIntervalRef.current = setInterval(fetchSystemConfig, 5000);
                return () => clearInterval(configIntervalRef.current);
            }, []);

            useEffect(() => {
                let interval;
                if (step === 'admin_dashboard') {
                    fetchDashboardData();
                    // Reduced polling time to 3 seconds for more "real-time" feel
                    interval = setInterval(fetchDashboardData, 3000);
                }
                
                let timerInterval;
                if (systemConfig.isOpen && systemConfig.examStartMs > 0) {
                    timerInterval = setInterval(() => {
                        const now = Date.now();
                        const diff = Math.floor((now - systemConfig.examStartMs) / 1000);
                        setAdminElapsedSeconds(diff >= 0 ? diff : 0);
                    }, 1000);
                } else {
                    setAdminElapsedSeconds(0);
                }

                return () => {
                    clearInterval(interval);
                    clearInterval(timerInterval);
                };
            }, [step, systemConfig.isOpen, systemConfig.examStartMs]);

            const shuffleArray = (array) => {
                const newArray = [...array];
                for (let i = newArray.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
                }
                return newArray;
            };

            const fetchExams = async () => {
                try {
                    const res = await fetch(`${GAS_API_URL}?action=get_exams&t=${Date.now()}`);
                    const data = await res.json();
                    if (Array.isArray(data)) setExams(data);
                } catch (err) { console.error("Failed to fetch exams"); }
            };

            const fetchSystemConfig = async () => {
                try {
                    const res = await fetch(`${GAS_API_URL}?action=get_config&t=${Date.now()}`);
                    const data = await res.json();
                    setSystemConfig(prev => {
                        const newConfig = {
                            activeExamId: data.active_exam_id,
                            isOpen: data.is_open === 'true' || data.is_open === true,
                            customTimeLimit: parseInt(data.custom_time_limit) || 0,
                            activeClassroom: data.active_classroom || 'All',
                            examOpenedAt: data.exam_opened_at || '',
                            examStartMs: parseInt(data.exam_start_ms) || 0
                        };
                        if (JSON.stringify(prev) === JSON.stringify(newConfig)) return prev;
                        return newConfig;
                    });
                    if ((data.is_open === 'true' || data.is_open === true) && step === 'waiting_room') setStep('instructions');
                } catch (err) {}
            };

            const fetchDashboardData = async () => {
                if(step !== 'admin_dashboard') setLoading(true); 
                try {
                    const res = await fetch(`${GAS_API_URL}?action=get_dashboard_data&t=${Date.now()}`);
                    const data = await res.json();
                    if (data && data.students) setDashboardData(data.students);
                } catch (err) { console.error("Dashboard error"); }
                setLoading(false);
            };

            const handleToggleExam = async (isOpen) => {
                setLoading(true); 
                setLoadingMessage(isOpen ? 'กำลังเปิดระบบสอบ...' : 'กำลังปิดระบบสอบ...');
                try {
                    const now = new Date();
                    const openedTime = isOpen ? now.toLocaleDateString('th-TH', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) : '';
                    const startMs = isOpen ? now.getTime() : '';

                    setSystemConfig(prev => ({
                        ...prev, isOpen: isOpen,
                        customTimeLimit: isOpen ? parseInt(adminTimeLimitInput) * 60 : prev.customTimeLimit,
                        activeClassroom: isOpen ? adminClassroomInput : prev.activeClassroom,
                        examOpenedAt: openedTime, examStartMs: isOpen ? startMs : 0
                    }));

                    const requests = [];
                    if (isOpen) {
                        requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'custom_time_limit', value: parseInt(adminTimeLimitInput) * 60 }) }));
                        requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'active_classroom', value: adminClassroomInput }) }));
                        requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'exam_opened_at', value: openedTime }) }));
                        requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'exam_start_ms', value: startMs }) }));
                    } else {
                        requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'exam_opened_at', value: '' }) }));
                        requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'exam_start_ms', value: '' }) }));
                    }
                    requests.push(fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'is_open', value: isOpen }) }));
                    
                    await Promise.all(requests);
                    await fetchSystemConfig();
                } catch (err) { alert("เกิดข้อผิดพลาดในการบันทึก"); fetchSystemConfig(); }
                setLoading(false);
            };

            const handleChangeExamSubject = async (examId) => {
                setLoading(true); setLoadingMessage('กำลังเปลี่ยนรายวิชา...');
                try {
                    setSystemConfig(prev => ({ ...prev, activeExamId: examId, isOpen: false }));
                    const selected = exams.find(e => String(e.id) === String(examId));
                    if (selected) setAdminTimeLimitInput(selected.timeLimit / 60);
                    await Promise.all([
                        fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'is_open', value: false }) }),
                        fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'update_config', key: 'active_exam_id', value: examId }) })
                    ]);
                    await fetchDashboardData();
                    await fetchSystemConfig();
                } catch (err) { console.error(err); }
                setLoading(false);
            };

            const handleCreateExamSubmit = async () => {
                if (!newExam.id || !newExam.title || newQuestions.length === 0) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
                setLoading(true); setLoadingMessage('กำลังบันทึกชุดข้อสอบ...');
                try {
                    await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({ action: 'create_exam', exam: newExam, questions: newQuestions }) });
                    alert("สร้างข้อสอบสำเร็จ!");
                    setNewExam({ id: '', title: '', time: 60 }); setNewQuestions([]); setAdminTab('dashboard'); fetchExams();
                } catch (err) { alert("เกิดข้อผิดพลาด"); }
                setLoading(false);
            };

            const addQuestionToDraft = () => {
                if (!qDraft.text || qDraft.options.some(o => !o.trim())) { alert("กรุณากรอกข้อมูลให้ครบ"); return; }
                setNewQuestions([...newQuestions, { ...qDraft }]);
                setQDraft({ text: '', options: ['', ''], correct: 0, mediaType: 'none', mediaContent: '' });
            };
            const addDraftOption = () => setQDraft(prev => ({ ...prev, options: [...prev.options, ''] }));
            const removeDraftOption = (index) => {
                if (qDraft.options.length <= 2) return;
                const newOptions = qDraft.options.filter((_, i) => i !== index);
                let newCorrect = qDraft.correct;
                if (index === qDraft.correct) newCorrect = 0;
                else if (index < qDraft.correct) newCorrect = qDraft.correct - 1;
                setQDraft(prev => ({ ...prev, options: newOptions, correct: newCorrect }));
            };

            const handleStudentLogin = async (e) => {
                e.preventDefault(); setLoading(true); setLoadingMessage('กำลังตรวจสอบข้อมูลนักเรียน...'); setError('');
                try {
                    const res = await fetch(`${GAS_API_URL}?action=check_student&id=${studentIdInput}&t=${Date.now()}`);
                    const data = await res.json();
                    if (data.found) {
                        const sData = { 
                            id: studentIdInput, 
                            name: data.name, surname: data.surname, number: data.number,
                            classroom: String(data.classroom || "").trim(), 
                            assignedExams: data.assignedExams ? data.assignedExams.map(ex => String(ex).trim()) : [] 
                        };
                        const activeId = String(systemConfig.activeExamId).trim();
                        if (sData.assignedExams.length === 0) { setError('คุณไม่มีสิทธิ์เข้าสอบ'); setLoading(false); return; }
                        if (activeId && !sData.assignedExams.includes(activeId)) {
                            const activeExam = exams.find(ex => String(ex.id).trim() === activeId);
                            setError(`คุณไม่มีสิทธิ์สอบวิชานี้: ${activeExam ? activeExam.title : activeId}`); setLoading(false); return;
                        }
                        const cfgRoom = String(systemConfig.activeClassroom || 'All').trim();
                        if (cfgRoom !== 'All' && cfgRoom !== sData.classroom) {
                            setError(`เปิดสอบเฉพาะห้อง ${cfgRoom} (คุณอยู่ห้อง ${sData.classroom})`); setLoading(false); return;
                        }
                        setStudent(sData);
                        if (systemConfig.isOpen) { prepareExam(activeId); setStep('instructions'); }
                        else setStep('waiting_room');
                    } else setError('ไม่พบรหัสนักเรียน');
                } catch (err) { setError('การเชื่อมต่อขัดข้อง'); }
                setLoading(false);
            };

            const prepareExam = (examId) => {
                const cleanExamId = String(examId).trim();
                const found = exams.find(e => String(e.id).trim() === cleanExamId);
                if (found) {
                    let processedExam = JSON.parse(JSON.stringify(found));
                    processedExam.questions = shuffleArray(processedExam.questions);
                    processedExam.questions = processedExam.questions.map(q => {
                        const optionsWithMeta = q.options.map((opt, index) => ({ text: opt, isCorrect: index === q.correct }));
                        const shuffledOptionsWithMeta = shuffleArray(optionsWithMeta);
                        return {
                            ...q,
                            options: shuffledOptionsWithMeta.map(o => o.text),
                            correct: shuffledOptionsWithMeta.findIndex(o => o.isCorrect)
                        };
                    });
                    const effectiveTime = systemConfig.customTimeLimit > 0 ? systemConfig.customTimeLimit : found.timeLimit;
                    setCurrentExam({ ...processedExam, timeLimit: effectiveTime });
                } else {
                    setCurrentExam({ id: cleanExamId, title: "กำลังโหลดข้อมูล...", timeLimit: 300, questions: [] });
                }
            };

            useEffect(() => {
                if (step === 'waiting_room' && systemConfig.isOpen && systemConfig.activeExamId) {
                    const configClassroom = String(systemConfig.activeClassroom || 'All').trim();
                    if(configClassroom === 'All' || configClassroom === String(student.classroom).trim()) {
                        prepareExam(systemConfig.activeExamId);
                        setStep('instructions');
                    }
                }
            }, [systemConfig, step, student]);

            const startExam = async () => {
                if (!systemConfig.isOpen) { alert("ระบบปิดแล้ว"); window.location.reload(); return; }
                
                try {
                    // Send IN_PROGRESS status
                    fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({
                        action: 'submit_exam', 
                        studentId: student.id, 
                        studentName: `${student.name} ${student.surname}`,
                        examId: currentExam.id, 
                        score: 0, 
                        totalScore: currentExam.questions.length, 
                        status: 'IN_PROGRESS', 
                        reason: 'Started Exam', 
                        answers: {}
                    })});
                } catch(e) {}

                setTimeLeft(currentExam.timeLimit); setStep('exam'); setExamStatus('active'); setCurrentQIdx(0);
                answersRef.current = {}; setAnswers({}); setWarningCount(0);

                timerRef.current = setInterval(() => { 
                    setTimeLeft(p => { 
                        if(p <= 1) { submitExam('TimeOut'); return 0; } 
                        return p - 1; 
                    }); 
                }, 1000);
            };

            const submitExam = async (reason = 'Normal', isCheat = false) => {
                // IMPORTANT: Prevent double submission
                if (examStatus === 'submitted' || examStatus === 'cheated') return;

                clearInterval(timerRef.current);
                setLoading(true); setLoadingMessage('กำลังบันทึกคำตอบ...'); 
                
                let score = 0;
                const currentAnswers = answersRef.current || {};
                const currentStatus = isCheat ? 'CHEATED' : (reason === 'TimeOut' ? 'TIMEOUT' : 'COMPLETED');

                if(currentExam?.questions) {
                    currentExam.questions.forEach(q => { if(currentAnswers[q.id] === q.correct) score++; });
                }
                
                // Update local state first to prevent UI interaction
                setScore(score); 
                setExamStatus(isCheat ? 'cheated' : 'submitted');

                try {
                    const response = await fetch(GAS_API_URL, { method: 'POST', body: JSON.stringify({
                        action: 'submit_exam', 
                        studentId: student.id, 
                        studentName: `${student.name} ${student.surname}`,
                        examId: currentExam.id, 
                        score: score, 
                        totalScore: currentExam.questions.length, 
                        status: currentStatus, 
                        reason: reason, 
                        answers: currentAnswers
                    })});

                    // Ensure we wait for response slightly to confirm save
                    const result = await response.json(); 

                    setLoading(false); // Stop loading overlay

                    // Show Alert
                    let msg = "";
                    if (isCheat) { msg = `ยุติการสอบเนื่องจาก: ${reason}\nคะแนน: ${score}/${currentExam.questions.length}`; } 
                    else if (reason === 'TimeOut') { msg = `หมดเวลาสอบ! ระบบส่งคำตอบอัตโนมัติ\nคะแนน: ${score}/${currentExam.questions.length}`; } 
                    else { msg = `บันทึกข้อสอบสำเร็จ!\nคะแนน: ${score}/${currentExam.questions.length}`; }

                    // Small timeout to allow React to render any final state if needed
                    setTimeout(() => {
                        alert(msg);
                        window.location.reload(); // Redirect to login
                    }, 100);

                } catch(e) { 
                    console.error(e); 
                    setLoading(false);
                    alert("เกิดข้อผิดพลาดในการบันทึกข้อมูล กรุณาแจ้งผู้คุมสอบ (แต่อย่าปิดหน้าต่างนี้จนกว่าจะได้รับคำแนะนำ)"); 
                }
            };

            // Anti-Cheat (Vis & PrintScreen ONLY - BLUR REMOVED)
            useEffect(() => {
                if (step !== 'exam') return;
                
                const handleCheat = () => {
                    if (examStatus === 'submitted' || examStatus === 'cheated') return;
                    
                    setWarningCount(prev => {
                        const newCount = prev + 1;
                        if (newCount <= 2) {
                            alert(`⚠️ แจ้งเตือนการทำผิดกฎครั้งที่ ${newCount}/2\nห้ามสลับหน้าจอหรือออกจากหน้าสอบ!\n(หากทำผิดครบ 3 ครั้ง ระบบจะตัดสิทธิ์และส่งคะแนนทันที)`);
                            return newCount;
                        } else {
                            submitExam("สลับหน้าจอเกินกำหนด (3 ครั้ง)", true);
                            return newCount;
                        }
                    });
                };

                const handleVis = () => { 
                    // Modified: Only check visibility for cheating, DO NOT blur
                    if (document.hidden) handleCheat(); 
                };

                const handleKeyDown = (e) => {
                    if (e.key === 'PrintScreen' || (e.metaKey && e.shiftKey && (e.key === '3' || e.key === '4')) || (e.ctrlKey && e.shiftKey && e.key === 'S')) {
                        setIsBlackout(true);
                        setTimeout(() => setIsBlackout(false), 2000);
                        alert("ตรวจพบการพยายามแคปหน้าจอ! การกระทำนี้ถูกบันทึกไว้แล้ว");
                    }
                };
                
                document.addEventListener('visibilitychange', handleVis);
                // REMOVED: window.addEventListener('blur', handleBlur);
                // REMOVED: window.addEventListener('focus', removeBlur);
                document.addEventListener('contextmenu', e => e.preventDefault());
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('keyup', (e) => { if(e.key === 'PrintScreen') setIsBlackout(false); });
                
                return () => { 
                    document.removeEventListener('visibilitychange', handleVis); 
                    // REMOVED: window.removeEventListener('blur', handleBlur);
                    document.removeEventListener('contextmenu', e => e.preventDefault());
                    document.removeEventListener('keydown', handleKeyDown);
                    clearInterval(timerRef.current); 
                };
            }, [step, examStatus]); 

            const handleAdminLogin = async (e) => {
                e.preventDefault(); setLoading(true); setLoadingMessage('กำลังเข้าสู่ระบบ...'); setError('');
                try { const r = await fetch(`${GAS_API_URL}?action=check_admin&password=${adminPassword}`); const d = await r.json();
                if(d.valid) { setStep('admin_dashboard'); fetchDashboardData(); } else setError('รหัสผิด'); } catch(e){ setError('Error'); } setLoading(false);
            };

            const formatTime = (seconds) => {
                const hrs = Math.floor(seconds / 3600);
                const mins = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                if (hrs > 0) return `${hrs}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            };

            // --- Render ---
            return (
                <>
                    {loading && <LoadingOverlay message={loadingMessage} />}
                    {isBlackout && <BlackoutOverlay />}
                    {step === 'exam' && student && <Watermark text={`${student.id} - ${student.name}`} />}
                    
                    {(() => {
                        if (step === 'admin_dashboard') {
                            const uniqueClassrooms = ['All', ...new Set(dashboardData.map(d => d.classroom).filter(Boolean))].sort();
                            const filterClassroom = systemConfig.isOpen ? systemConfig.activeClassroom : adminClassroomInput;
                            const filteredData = dashboardData.filter(std => filterClassroom === 'All' || String(std.classroom) === String(filterClassroom));
                            const stats = {
                                total: filteredData.length,
                                completed: filteredData.filter(d => d.status === 'COMPLETED').length,
                                cheated: filteredData.filter(d => d.status === 'CHEATED').length,
                                started: filteredData.filter(d => d.status === 'IN_PROGRESS').length, 
                                waiting: filteredData.filter(d => !d.status || d.status === 'รอเข้าสอบ').length,
                            };

                            return (
                                <div className="min-h-screen p-4 md:p-8">
                                    <div className="max-w-6xl mx-auto glass-card rounded-2xl shadow-2xl overflow-hidden min-h-[80vh]">
                                        <div className="bg-white/50 p-6 border-b border-white/50 flex flex-col md:flex-row justify-between items-center gap-4">
                                            <div className="flex items-center gap-3"><img src={LOGO_URL} className="w-10 h-auto"/> <div><h1 className="text-xl font-bold text-slate-800">แผงควบคุมระบบสอบ</h1></div></div>
                                            <div className="flex bg-slate-100 p-1 rounded-lg">
                                                <button onClick={()=>setAdminTab('dashboard')} className={`px-4 py-2 rounded-md text-sm font-bold transition ${adminTab==='dashboard'?'bg-white text-sky-700 shadow-sm':'text-slate-500'}`}>ควบคุมการสอบ</button>
                                                <button onClick={()=>setAdminTab('create_exam')} className={`px-4 py-2 rounded-md text-sm font-bold transition ${adminTab==='create_exam'?'bg-white text-sky-700 shadow-sm':'text-slate-500'}`}>+ สร้างข้อสอบ</button>
                                            </div>
                                            <button onClick={()=>{setStep('login'); setAdminPassword('');}} className="p-2 text-slate-400 hover:text-red-500 rounded-full"><LogOut size={20}/></button>
                                        </div>

                                        <div className="p-6 md:p-8">
                                            {adminTab === 'create_exam' ? (
                                                <div className="space-y-6">
                                                    <div className="bg-sky-50 p-6 rounded-xl border border-sky-100">
                                                        <h3 className="font-bold text-sky-800 mb-4 flex items-center gap-2"><Settings size={18}/> 1. ข้อมูลชุดข้อสอบ</h3>
                                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                                            <input type="text" placeholder="รหัสวิชา (เช่น ENG01)" value={newExam.id} onChange={e=>setNewExam({...newExam, id: e.target.value})} className="p-3 border rounded-lg focus:ring-2 focus:ring-sky-400 outline-none" />
                                                            <input type="text" placeholder="ชื่อวิชา" value={newExam.title} onChange={e=>setNewExam({...newExam, title: e.target.value})} className="p-3 border rounded-lg focus:ring-2 focus:ring-sky-400 outline-none" />
                                                            <input type="number" placeholder="เวลา (นาที)" value={newExam.time} onChange={e=>setNewExam({...newExam, time: e.target.value})} className="p-3 border rounded-lg focus:ring-2 focus:ring-sky-400 outline-none" />
                                                        </div>
                                                    </div>
                                                    <div className="bg-white p-6 rounded-xl border shadow-sm">
                                                        <h3 className="font-bold text-gray-800 mb-4 flex items-center gap-2"><PlusCircle size={18}/> 2. เพิ่มข้อสอบ (ข้อที่ {newQuestions.length + 1})</h3>
                                                        <div className="mb-4 bg-gray-50 p-4 rounded-lg">
                                                            <label className="text-sm font-bold text-gray-600 mb-2 block">สื่อประกอบ</label>
                                                            <div className="flex gap-2 mb-2">
                                                                <select value={qDraft.mediaType} onChange={e=>setQDraft({...qDraft, mediaType: e.target.value})} className="p-2 border rounded-lg text-sm"><option value="none">ไม่มี</option><option value="image">รูปภาพ (URL)</option><option value="text_box">ข้อความ</option></select>
                                                                {qDraft.mediaType!=='none' && <input type="text" placeholder="URL หรือ ข้อความ" value={qDraft.mediaContent} onChange={e=>setQDraft({...qDraft, mediaContent: e.target.value})} className="flex-1 p-2 border rounded-lg text-sm"/>}
                                                            </div>
                                                            {qDraft.mediaType==='image' && qDraft.mediaContent && <img src={qDraft.mediaContent} className="h-32 object-contain mx-auto border bg-white mt-2"/>}
                                                        </div>
                                                        <input type="text" placeholder="คำถาม..." value={qDraft.text} onChange={e=>setQDraft({...qDraft, text: e.target.value})} className="w-full p-3 border rounded-lg mb-4 font-medium" />
                                                        <div className="mb-4 space-y-3">
                                                            {qDraft.options.map((opt, i) => (
                                                                <div key={i} className="flex items-center gap-3 bg-gray-50 p-2 rounded-lg border">
                                                                    <input type="radio" name="correct" checked={qDraft.correct === i} onChange={()=>setQDraft({...qDraft, correct: i})} className="w-4 h-4" />
                                                                    <input type="text" placeholder={`ตัวเลือก ${i+1}`} value={opt} onChange={e=>{const n=[...qDraft.options]; n[i]=e.target.value; setQDraft({...qDraft, options: n})}} className="flex-1 p-2 bg-transparent outline-none text-sm"/>
                                                                    {qDraft.options.length>2 && <button onClick={()=>removeDraftOption(i)} className="text-slate-400 hover:text-red-500"><Trash size={16}/></button>}
                                                                </div>
                                                            ))}
                                                            <button onClick={addDraftOption} className="text-sm text-sky-600 font-bold hover:underline flex items-center gap-1"><PlusCircle size={14}/> เพิ่มตัวเลือก</button>
                                                        </div>
                                                        <button onClick={addQuestionToDraft} className="bg-sky-600 text-white px-5 py-2 rounded-lg text-sm font-semibold hover:bg-sky-700 shadow flex items-center gap-2">เพิ่มลงรายการ</button>
                                                    </div>
                                                    <div className="border-t pt-6">
                                                        <h4 className="font-bold text-gray-600 mb-4">รายการข้อสอบที่จะบันทึก ({newQuestions.length} ข้อ)</h4>
                                                        <div className="max-h-60 overflow-y-auto space-y-2 mb-6 pr-2">
                                                            {newQuestions.map((q, i) => (
                                                                <div key={i} className="text-sm p-3 bg-white border rounded-lg flex justify-between items-center shadow-sm">
                                                                    <span className="truncate flex-1 font-medium">{i+1}. {q.text} <span className="text-xs text-gray-400">({q.options.length} ตัวเลือก)</span></span>
                                                                    <button onClick={()=>setNewQuestions(newQuestions.filter((_,x)=>x!==i))} className="text-red-500 text-xs font-bold border border-red-200 px-2 py-1 rounded">ลบ</button>
                                                                </div>
                                                            ))}
                                                        </div>
                                                        <button onClick={handleCreateExamSubmit} disabled={loading || newQuestions.length===0} className="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white py-3 rounded-xl font-bold hover:shadow-lg disabled:opacity-50">บันทึกชุดข้อสอบ</button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <>
                                                    <div className="bg-gradient-to-r from-sky-50 to-indigo-50 border border-sky-100 p-6 rounded-xl mb-6 shadow-sm">
                                                        <h3 className="font-bold text-sky-900 mb-4 flex items-center gap-2 text-lg"><Settings size={20}/> ตั้งค่าการเปิดสอบ</h3>
                                                        <div className="grid grid-cols-1 md:grid-cols-4 gap-6 items-end">
                                                            <div><label className="block text-xs font-bold text-sky-700 mb-2">1. รหัสวิชา</label><select value={systemConfig.activeExamId} onChange={(e)=>handleChangeExamSubject(e.target.value)} className="w-full p-3 border border-sky-200 rounded-xl outline-none bg-white"><option value="" disabled>-- เลือก --</option>{exams.map(e=><option key={e.id} value={e.id}>{e.id} : {e.title}</option>)}</select></div>
                                                            <div><label className="block text-xs font-bold text-sky-700 mb-2">2. ห้องเรียน</label><select value={adminClassroomInput} onChange={(e)=>setAdminClassroomInput(e.target.value)} className="w-full p-3 border border-sky-200 rounded-xl outline-none bg-white">{uniqueClassrooms.map(r=><option key={r} value={r}>{r==='All'?'ทุกห้อง':r}</option>)}</select></div>
                                                            <div><label className="block text-xs font-bold text-sky-700 mb-2">3. เวลา (นาที)</label><input type="number" value={adminTimeLimitInput} onChange={(e)=>setAdminTimeLimitInput(e.target.value)} className="w-full p-3 border border-sky-200 rounded-xl outline-none text-center font-bold bg-white"/></div>
                                                            <div>{systemConfig.isOpen ? <button onClick={()=>handleToggleExam(false)} className="w-full bg-red-500 text-white p-3 rounded-xl font-bold shadow-lg">ปิดระบบสอบ</button> : <button onClick={()=>handleToggleExam(true)} disabled={!systemConfig.activeExamId} className="w-full bg-emerald-500 text-white p-3 rounded-xl font-bold shadow-lg disabled:opacity-50">เปิดสอบทันที</button>}</div>
                                                        </div>
                                                        <div className="mt-4 flex flex-col md:flex-row justify-between items-start md:items-center text-sm border-t border-sky-200 pt-3 gap-2">
                                                            <span className="text-sky-600">สถานะ: <span className={`font-bold ml-2 ${systemConfig.isOpen ? 'text-green-600' : 'text-red-600'}`}>{systemConfig.isOpen ? `เปิดสอบ (${systemConfig.activeClassroom === 'All' ? 'ทุกห้อง' : 'ห้อง ' + systemConfig.activeClassroom})` : 'ปิดรับการสอบ'}</span></span>
                                                            {systemConfig.isOpen && (
                                                                <div className="flex items-center gap-3">
                                                                    <div className="bg-white border border-sky-200 px-3 py-1 rounded-full text-xs text-sky-600 flex items-center gap-2"><Clock size={14}/> เปิดเมื่อ: {systemConfig.examOpenedAt}</div>
                                                                    <div className="bg-sky-600 text-white px-3 py-1 rounded-full text-sm font-mono font-bold flex items-center gap-2 shadow-sm animate-pulse"><span>เวลา:</span>{formatTime(adminElapsedSeconds)}</div>
                                                                </div>
                                                            )}
                                                        </div>
                                                    </div>
                                                    <div className="flex justify-between items-center mb-4"><h3 className="font-bold text-slate-700">สถานะผู้เข้าสอบ ({filterClassroom === 'All' ? 'ทุกห้อง' : `ห้อง ${filterClassroom}`})</h3><button onClick={fetchDashboardData} className="text-sm bg-white border px-4 py-2 rounded-lg flex items-center gap-2"><RefreshCw size={14}/> อัปเดต</button></div>
                                                    <div className="grid grid-cols-4 gap-4 mb-6">
                                                        <div className="bg-white p-4 rounded-xl shadow-sm border-b-4 border-gray-300"><p className="text-xs text-gray-500">รอสอบ</p><p className="text-2xl font-bold">{stats.waiting} <span className="text-sm font-normal text-gray-400">/ {stats.total}</span></p></div>
                                                        <div className="bg-white p-4 rounded-xl shadow-sm border-b-4 border-blue-500"><p className="text-xs text-gray-500">กำลังสอบ</p><p className="text-2xl font-bold text-blue-600">{stats.started}</p></div>
                                                        <div className="bg-white p-4 rounded-xl shadow-sm border-b-4 border-emerald-500"><p className="text-xs text-gray-500">ส่งแล้ว</p><p className="text-2xl font-bold text-emerald-600">{stats.completed}</p></div>
                                                        <div className="bg-white p-4 rounded-xl shadow-sm border-b-4 border-red-500"><p className="text-xs text-gray-500">ทุจริต</p><p className="text-2xl font-bold text-red-600">{stats.cheated}</p></div>
                                                    </div>
                                                    <div className="mt-6">
                                                        {filteredData.length === 0 ? <div className="p-12 text-center text-slate-400 bg-white rounded-xl border border-dashed border-slate-300"><User size={48} className="mx-auto mb-3 opacity-20"/><p>ไม่พบรายชื่อนักเรียน</p></div> : 
                                                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                                                                {filteredData.map((d, i) => {
                                                                    const isCompleted = d.status === 'COMPLETED';
                                                                    const isCheated = d.status === 'CHEATED';
                                                                    const isInProgress = d.status === 'IN_PROGRESS';
                                                                    let cardClass = "bg-white border-slate-200 hover:border-slate-300";
                                                                    let badgeClass = "bg-slate-100 text-slate-500";
                                                                    let scoreClass = "text-slate-400";
                                                                    if (isCompleted) { cardClass = "bg-emerald-50/50 border-emerald-200 hover:border-emerald-300"; badgeClass = "bg-emerald-100 text-emerald-700"; scoreClass = "text-emerald-600"; } 
                                                                    else if (isCheated) { cardClass = "bg-red-50/50 border-red-200 hover:border-red-300"; badgeClass = "bg-red-100 text-red-700"; scoreClass = "text-red-600"; } 
                                                                    else if (isInProgress) { cardClass = "bg-blue-50/50 border-blue-200 hover:border-blue-300"; badgeClass = "bg-blue-100 text-blue-700 animate-pulse"; scoreClass = "text-blue-600"; }
                                                                    return (
                                                                        <div key={i} className={`p-5 rounded-2xl border transition-all duration-200 shadow-sm hover:shadow-md flex flex-col justify-between ${cardClass}`}>
                                                                            <div><div className="flex justify-between items-start mb-2"><span className="text-xs font-mono font-bold text-slate-400 bg-white/50 px-2 py-0.5 rounded border border-slate-100">#{d.id}</span><span className={`px-2 py-1 rounded-md text-xs font-bold uppercase tracking-wider ${badgeClass}`}>{d.status === 'IN_PROGRESS' ? 'กำลังสอบ' : (d.status || 'รอเข้าสอบ')}</span></div><h4 className="font-bold text-slate-800 text-lg mb-1 truncate" title={`${d.name} ${d.surname}`}>{d.name} {d.surname}</h4><div className="flex items-center gap-2 text-sm text-slate-500 mb-4"><School size={14}/> <span>ห้อง {d.classroom}</span></div></div>
                                                                            <div className="pt-4 border-t border-slate-200/50 flex items-end justify-between"><div><p className="text-[10px] text-slate-400 uppercase font-bold tracking-wide mb-0.5">คะแนน</p><p className={`text-2xl font-black ${d.score !== undefined ? scoreClass : 'text-slate-300'}`}>{d.score !== undefined ? d.score : '-'}</p></div>{d.reason && <div className="text-right max-w-[60%] pl-2"><p className="text-[10px] text-slate-400 uppercase font-bold tracking-wide mb-0.5">หมายเหตุ</p><p className="text-xs text-red-500 font-medium leading-tight line-clamp-2" title={d.reason}>{d.reason}</p></div>}</div>
                                                                        </div>
                                                                    );
                                                                })}
                                                            </div>
                                                        }
                                                    </div>
                                                </>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            );
                        }

                        if (step === 'exam') {
                            const q = currentExam.questions[currentQIdx];
                            return (
                                <div className="min-h-screen bg-slate-50 pb-24">
                                    <div className="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-20 border-b border-slate-200">
                                        <div className="max-w-4xl mx-auto px-4 py-3 flex justify-between items-center">
                                            <div><h1 className="font-bold text-slate-800 text-lg line-clamp-1">{currentExam.title}</h1><p className="text-xs text-slate-500 font-medium">{student.name} {student.surname} ({student.id})</p></div>
                                            <div className={`flex items-center gap-2 px-4 py-2 bg-slate-100 rounded-lg font-mono font-bold text-lg shadow-inner ${timeLeft<60?'text-red-600 bg-red-50': 'text-slate-700'}`}>
                                                <Clock size={20}/> 
                                                <span>เหลือเวลา {formatTime(timeLeft)}</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="max-w-4xl mx-auto px-4 py-8">
                                        <div className="bg-white p-8 rounded-2xl shadow-lg border border-slate-100 relative overflow-hidden">
                                            {q.mediaType === 'image' && q.mediaContent && <div className="mb-8 flex justify-center bg-slate-50 p-4 rounded-xl border border-slate-100"><img src={q.mediaContent} className="max-h-80 max-w-full object-contain rounded shadow-sm" /></div>}
                                            {q.mediaType === 'text_box' && q.mediaContent && <div className="mb-8 p-6 bg-amber-50 border border-amber-100 rounded-xl text-slate-800 text-base whitespace-pre-wrap leading-relaxed shadow-sm">{q.mediaContent}</div>}
                                            <h3 className="font-bold text-xl md:text-2xl text-slate-800 mb-8 leading-snug">{q.question}</h3>
                                            <div className="space-y-4">
                                                {q.options.map((opt, optIndex) => (
                                                    <label key={optIndex} className={`group flex items-center p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 ${answers[q.id] === optIndex ? 'bg-sky-50 border-sky-500 shadow-md' : 'border-slate-100 hover:border-sky-200 hover:bg-slate-50'}`}>
                                                        <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center mr-4 transition-colors ${answers[q.id] === optIndex ? 'border-sky-600 bg-sky-600' : 'border-slate-300 group-hover:border-sky-400'}`}>{answers[q.id] === optIndex && <div className="w-2.5 h-2.5 bg-white rounded-full"></div>}</div>
                                                        <input type="radio" className="hidden" name={`q-${q.id}`} checked={answers[q.id] === optIndex} onChange={() => {
                                                            const newAns = {...answers, [q.id]: optIndex};
                                                            setAnswers(newAns);
                                                            answersRef.current = newAns;
                                                        }} />
                                                        <span className={`text-lg ${answers[q.id] === optIndex ? 'text-sky-900 font-semibold' : 'text-slate-700'}`}>{opt}</span>
                                                    </label>
                                                ))}
                                            </div>
                                        </div>
                                        <div className="flex justify-between mt-8">
                                            <button onClick={() => setCurrentQIdx(prev => Math.max(0, prev - 1))} disabled={currentQIdx === 0} className="px-6 py-3 bg-white border border-slate-200 text-slate-600 rounded-xl font-semibold hover:bg-slate-50 flex items-center gap-2 disabled:opacity-50"><ChevronLeft size={20}/> ก่อนหน้า</button>
                                            {currentQIdx < currentExam.questions.length - 1 ? 
                                                <button onClick={() => setCurrentQIdx(prev => prev + 1)} className="px-8 py-3 bg-gradient-to-r from-sky-600 to-blue-700 text-white rounded-xl font-bold hover:shadow-lg flex items-center gap-2">ถัดไป <ChevronRight size={20}/></button> : 
                                                <button 
                                                    type="button"
                                                    onClick={() => { if(window.confirm('ยืนยันการส่งคำตอบ?')) submitExam('User Submitted'); }} 
                                                    className="px-8 py-3 bg-gradient-to-r from-emerald-500 to-green-600 text-white rounded-xl font-bold hover:shadow-lg shadow-emerald-200 transition-transform transform hover:-translate-y-0.5 active:scale-95"
                                                >
                                                    ส่งคำตอบ
                                                </button>
                                            }
                                        </div>
                                    </div>
                                </div>
                            );
                        }

                        if (step === 'waiting_room') return (<div className="min-h-screen flex items-center justify-center p-4"><div className="glass-card p-10 rounded-2xl shadow-2xl w-full max-w-md text-center"><LogoHeader title="ห้องพักรอสอบ" subtitle="กรุณารอสักครู่..." /><div className="my-8 relative"><div className="absolute inset-0 bg-sky-200 rounded-full animate-ping opacity-20"></div><div className="relative bg-sky-100 p-6 rounded-full text-sky-600 inline-block"><Clock size={48} className="animate-pulse"/></div></div><div className="bg-white/60 p-5 rounded-xl border border-white/50 mb-6"><p className="text-sm text-slate-500 uppercase tracking-wide font-bold mb-1">วิชาที่จะสอบ</p><p className="font-bold text-xl text-slate-800">{currentExam?.title || 'กำลังโหลดข้อมูล...'}</p><div className="mt-3 flex items-center justify-center gap-2 text-sm text-orange-600 font-medium bg-orange-50 py-1.5 px-3 rounded-full mx-auto w-fit"><span className="w-2 h-2 bg-orange-500 rounded-full animate-pulse"></span> รอสัญญาณจากครูผู้คุมสอบ</div></div><button onClick={() => setStep('login')} className="text-slate-400 hover:text-slate-600 text-sm font-medium underline transition">ยกเลิก / ออกจากระบบ</button></div></div>);
                        if (step === 'login') return (<div className="min-h-screen flex flex-col items-center justify-center p-4"><div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md border border-white/40 relative overflow-hidden"><button onClick={() => { setStep('admin_login'); setError(''); }} className="absolute top-4 right-4 text-slate-400 hover:text-sky-600 transition p-2 hover:bg-sky-50 rounded-full"><Shield size={20} /></button><LogoHeader title="เข้าสู่ระบบสอบ" subtitle="กรุณากรอกข้อมูลเพื่อยืนยันตัวตน" /><form onSubmit={handleStudentLogin} className="space-y-5"><div><label className="block text-sm font-bold text-slate-700 mb-2 ml-1">รหัสประจำตัวนักเรียน</label><input type="text" value={studentIdInput} onChange={(e) => setStudentIdInput(e.target.value)} className="w-full px-5 py-3 bg-white border border-slate-200 rounded-xl focus:ring-4 focus:ring-sky-100 outline-none shadow-sm text-lg" placeholder="กรอกรหัสเลข 4-5 หลัก" required /></div>{error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-xl flex items-center gap-3 border border-red-100 animate-pulse"><AlertTriangle size={18} className="shrink-0"/>{error}</div>}<button type="submit" disabled={loading} className="w-full bg-gradient-to-r from-sky-600 to-blue-700 hover:from-sky-700 hover:to-blue-800 text-white font-bold py-3.5 rounded-xl shadow-lg transform transition active:scale-[0.98] disabled:opacity-70 disabled:cursor-not-allowed text-lg">{loading ? 'กำลังตรวจสอบ...' : 'เข้าสู่ระบบ'}</button></form><p className="text-center text-slate-400 text-xs mt-8">Secure Exam System v2.0 • Powered by React & GAS</p></div></div>);
                        if (step === 'admin_login') return (<div className="min-h-screen flex items-center justify-center p-4"><div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-sm border border-white/40"><LogoHeader title="ผู้ดูแลระบบ" subtitle="เฉพาะครูผู้สอนเท่านั้น" className="mb-6"/><form onSubmit={handleAdminLogin} className="space-y-4"><input type="password" value={adminPassword} onChange={e=>setAdminPassword(e.target.value)} className="w-full px-5 py-3 bg-white border border-slate-200 rounded-xl focus:ring-4 focus:ring-sky-100 outline-none text-center tracking-widest text-lg" placeholder="•••••••" autoFocus/>{error && <p className="text-red-500 text-sm text-center bg-red-50 p-2 rounded-lg">{error}</p>}<button className="w-full bg-slate-800 hover:bg-slate-900 text-white font-bold py-3 rounded-xl shadow-lg transition transform hover:-translate-y-0.5">เข้าสู่ระบบ (Admin)</button></form><button onClick={()=>setStep('login')} className="w-full text-sm text-center mt-6 text-slate-500 hover:text-slate-800 font-medium">กลับหน้าสำหรับนักเรียน</button></div></div>);
                        if (step === 'instructions') return (
                            <div className="min-h-screen flex items-center justify-center p-4">
                                <div className="glass-card p-8 rounded-3xl shadow-2xl w-full max-w-lg border border-white/40">
                                    <LogoHeader className="mb-2"/>
                                    <h2 className="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3 border-b pb-4"><Lock className="text-amber-500" /> กฎระเบียบห้องสอบ</h2>
                                    <div className="bg-sky-50/80 p-5 rounded-2xl mb-6 border border-sky-100">
                                        <div className="flex items-center gap-3 mb-2"><div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-sky-600 shadow-sm"><User size={20}/></div><div><p className="text-xs text-sky-600 uppercase font-bold">ผู้เข้าสอบ</p><p className="text-sky-900 font-bold text-lg">{student.name} {student.surname}</p></div></div>
                                        <div className="flex items-center gap-3"><div className="w-10 h-10 bg-white rounded-full flex items-center justify-center text-sky-600 shadow-sm"><FileText size={20}/></div><div><p className="text-xs text-sky-600 uppercase font-bold">วิชาสอบ</p><p className="text-sky-900 font-bold">{currentExam ? currentExam.title : ''}</p></div></div>
                                    </div>
                                    <div className="space-y-4 mb-8">
                                        <div className="flex items-start gap-4 p-3 hover:bg-red-50 rounded-xl transition cursor-default">
                                            <div className="p-2 bg-red-100 text-red-600 rounded-lg"><XCircle size={20}/></div>
                                            <div><p className="font-bold text-slate-700">ห้ามสลับหน้าจอ (Tab)</p><p className="text-xs text-slate-500">อนุญาตให้กลับเข้าสอบได้ 1 ครั้ง หากทำผิดครั้งที่ 2 ระบบจะส่งคะแนนและตัดสิทธิ์ทันที</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-3 hover:bg-orange-50 rounded-xl transition cursor-default">
                                            <div className="p-2 bg-orange-100 text-orange-600 rounded-lg"><AlertTriangle size={20}/></div>
                                            <div><p className="font-bold text-slate-700">ห้ามแคปภาพหน้าจอ</p><p className="text-xs text-slate-500">ระบบมีการฝังลายน้ำระบุตัวตนบนหน้าจอสอบ</p></div>
                                        </div>
                                        <div className="flex items-start gap-4 p-3 hover:bg-blue-50 rounded-xl transition cursor-default">
                                            <div className="p-2 bg-blue-100 text-blue-600 rounded-lg"><Clock size={20}/></div>
                                            <div><p className="font-bold text-slate-700">เวลาสอบ: {currentExam && currentExam.timeLimit ? Math.floor(currentExam.timeLimit / 60) : '-'} นาที</p><p className="text-xs text-slate-500">ระบบจะส่งคำตอบอัตโนมัติเมื่อหมดเวลา</p></div>
                                        </div>
                                    </div>
                                    <button onClick={startExam} disabled={loading} className="w-full bg-gradient-to-r from-emerald-500 to-green-600 text-white text-lg py-4 rounded-2xl font-bold shadow-lg shadow-emerald-200 transform transition hover:-translate-y-1 active:scale-[0.98]">รับทราบและเริ่มทำข้อสอบ</button>
                                </div>
                            </div>
                        );
                        if (step === 'result') { return null; }
                        return null;
                    })()}
                </>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SecureExamApp />);
    </script>
</body>
</html>
