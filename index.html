<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบสอบออนไลน์ (Secure Exam) - Admin Console</title>
    <link rel="icon" href="https://img2.pic.in.th/pic/Logoc404dc85753b800c.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Sarabun', sans-serif; user-select: none; -webkit-user-select: none; }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
        }
        .watermark-container {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none; z-index: 9000; opacity: 0.08;
            display: flex; flex-wrap: wrap; justify-content: space-around; align-content: space-around;
        }
        .watermark-text { transform: rotate(-45deg); font-size: 20px; font-weight: bold; color: #333; margin: 50px; }
        @media print { html, body { display: none !important; background-color: #000 !important; } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }
        .animate-shake { animation: shake 0.2s ease-in-out 0s 2; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
                /* เพิ่ม CSS สำหรับจัดการการแสดงผล */
        .whitespace-pre-line {
            white-space: pre-line;
        }
        .option-letter {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 0.75rem;
            background-color: #f1f5f9;
            color: #64748b;
            font-weight: 700;
            margin-right: 1rem;
        }
        .option-letter.selected {
            background-color: #2563eb;
            color: white;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen text-slate-800 notranslate" translate="no">
    <div id="root"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCHmmpM8mJQ4M7J8k9L5qW3rX2vN4pR6tU",
            authDomain: "chinesetest2-68.firebaseapp.com",
            databaseURL: "https://chinesetest2-68-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "chinesetest2-68",
            storageBucket: "chinesetest2-68.firebasestorage.app",
            messagingSenderId: "150596319988",
            appId: "1:150596319988:web:a7cc730d4c2bae21047ca1"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        window.db = db;
        window.fb = { collection, doc, getDoc, getDocs, setDoc, updateDoc, deleteDoc, onSnapshot, query, where };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback, useMemo } = React;
        const LOGO_URL = "https://img2.pic.in.th/pic/Logoc404dc85753b800c.png";

        // --- 1. Global Utilities ---
        const shuffleArray = (array) => {
            if (!array || !Array.isArray(array)) return [];
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        };

        const formatImportedQuestions = (questions) => {
    return questions.map(q => {
        // ลบช่องว่างส่วนเกินอย่างเดียว ไม่ต้องตัดพินอิน
        const formatted = {
            ...q,
            text: q.text, // เก็บตามเดิม
            options: q.options.map(opt => opt), // เก็บตามเดิม
            passage: q.passage ? q.passage : ''
        };
        
        // เรียงตัวเลือกใหม่ให้สวยงาม (ให้มีครบ 4 ตัวเลือก)
        const validOptions = formatted.options.filter(opt => opt !== '');
        while (validOptions.length < 4) {
            validOptions.push('');
        }
        formatted.options = validOptions;
        
        return formatted;
    });
};
        const showFileFormatExample = () => {
            const example = `ตัวอย่างรูปแบบไฟล์ที่รองรับ:

รูปแบบที่ 1: ตัวเลือกภาษาไทย (ก-ง)
1. ข้อสอบข้อที่ 1
ก. ตัวเลือกที่ 1
ข. ตัวเลือกที่ 2
ค. ตัวเลือกที่ 3
ง. ตัวเลือกที่ 4

รูปแบบที่ 2: ตัวเลือกภาษาอังกฤษ (a-d)
2. Question 2
a. option a
b. option b
c. option c
d. option d

รูปแบบที่ 3: ตัวเลือกตัวเลข (1-4)
3. คำถามข้อที่ 3
1. ตัวเลือก 1
2. ตัวเลือก 2
3. ตัวเลือก 3
4. ตัวเลือก 4

รูปแบบที่ 4: มีบทอ่าน
บทอ่านสำหรับข้อสอบ...
4. คำถามข้อที่ 4
ก. ตัวเลือก 1
ข. ตัวเลือก 2
ค. ตัวเลือก 3
ง. ตัวเลือก 4

หมายเหตุ: 
- แต่ละข้อต้องขึ้นต้นด้วยตัวเลขและจุด (1. 2. 3.)
- ตัวเลือกต้องขึ้นต้นด้วย ก. ข. ค. ง. หรือ a. b. c. d. หรือ 1. 2. 3. 4.
- บทอ่านจะอยู่ก่อนคำถาม`;
            
            alert(example);
        };

        const activeIdMatch = (id) => String(id || '').trim();

        // --- 2. Icons Component ---
        const Icon = ({ path, className, size = 24 }) => (
            <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                {path}
            </svg>
        );
        const AlertTriangle = (props) => <Icon {...props} path={<><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></>} />;
        const Clock = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></>} />;
        const FileText = (props) => <Icon {...props} path={<><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></>} />;
        const Lock = (props) => <Icon {...props} path={<><rect width="18" height="11" x="3" y="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></>} />;
        const LogOut = (props) => <Icon {...props} path={<><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" x2="9" y1="12" y2="12"/></>} />;
        const Shield = (props) => <Icon {...props} path={<><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10"/></>} />;
        const RefreshCw = (props) => <Icon {...props} path={<><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></>} />;
        const Upload = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></>} />;
        const Download = (props) => <Icon {...props} path={<><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></>} />;
        const User = (props) => <Icon {...props} path={<><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></>} />;
        const XCircle = (props) => <Icon {...props} path={<><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></>} />;
        const Edit = (props) => <Icon {...props} path={<><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></>} />;
        const List = (props) => <Icon {...props} path={<><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></>} />;
        const Trash = (props) => <Icon {...props} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></>} />;
        const Eye = (props) => <Icon {...props} path={<><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></>} />;
        const BookOpen = (props) => <Icon {...props} path={<><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></>} />;
        const Layout = (props) => <Icon {...props} path={<><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><line x1="3" y1="9" x2="21" y2="9"/><line x1="9" y1="21" x2="9" y2="9"/></>} />;
        const Plus = (props) => <Icon {...props} path={<><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></>} />;
        const Users = (props) => <Icon {...props} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M15.31 8.33a4 4 0 0 1 0 5.34"/></>} />;
        const ChevronDown = (props) => <Icon {...props} path={<><polyline points="6 9 12 15 18 9"/></>} />;
        const Send = (props) => <Icon {...props} path={<><line x1="22" y1="2" x2="11" y2="13"/><polyline points="22 2 15 22 11 13 2 9 22 2"/></>} />;
        const CheckCircle = (props) => <Icon {...props} path={<><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></>} />;
        const Copy = (props) => <Icon {...props} path={<><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></>} />;

        // --- 3. UI Components ---
        const LogoHeader = ({ title, subtitle, className = "" }) => (
            <div className={`flex flex-col items-center mb-8 ${className}`}>
                <img src={LOGO_URL} alt="Logo" className="w-24 h-auto drop-shadow-md mb-4 animate-float" />
                {title && <h2 className="text-2xl font-bold text-slate-800 text-center">{title}</h2>}
                {subtitle && <p className="text-slate-500 text-sm text-center mt-1 uppercase tracking-widest font-black">{subtitle}</p>}
            </div>
        );

        const LoadingOverlay = ({ message }) => (
            <div className="fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-[9999] flex items-center justify-center text-center">
                <div className="bg-white/95 p-8 rounded-2xl shadow-2xl flex flex-col items-center border border-white/50 max-w-sm w-full mx-4">
                    <div className="relative mb-6">
                        <div className="w-16 h-16 border-4 border-sky-200 border-t-sky-600 rounded-full animate-spin"></div>
                    </div>
                    <h3 className="text-xl font-bold animate-pulse text-slate-800">{message || 'กำลังประมวลผล...'}</h3>
                </div>
            </div>
        );

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            const bgColor = type === 'success' ? 'bg-green-500' : type === 'error' ? 'bg-red-500' : 'bg-blue-500';
            
            return (
                <div className={`fixed bottom-4 right-4 ${bgColor} text-white px-6 py-3 rounded-xl shadow-lg z-[9999] animate-fade-in`}>
                    <div className="flex items-center gap-2">
                        {type === 'success' && <CheckCircle size={20} />}
                        <span className="font-bold">{message}</span>
                    </div>
                </div>
            );
        };

        const ConfirmDialog = ({ isOpen, title, message, onConfirm, onCancel }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl max-w-md w-full p-6 shadow-2xl animate-fade-in">
                        <h3 className="text-xl font-bold text-slate-800 mb-2">{title}</h3>
                        <p className="text-slate-600 mb-6">{message}</p>
                        <div className="flex gap-3 justify-end">
                            <button onClick={onCancel} className="px-6 py-2 border-2 rounded-xl font-bold text-slate-600 hover:bg-slate-50">ยกเลิก</button>
                            <button onClick={onConfirm} className="px-6 py-2 bg-red-600 text-white rounded-xl font-bold hover:bg-red-700">ยืนยัน</button>
                        </div>
                    </div>
                </div>
            );
        };

        const BlackoutOverlay = () => (
            <div className="fixed inset-0 bg-black z-[10000] flex items-center justify-center text-white p-8 text-center">
                <div className="animate-fade-in text-center">
                    <AlertTriangle size={84} className="mx-auto mb-6 text-red-500 animate-bounce" />
                    <h2 className="text-4xl font-black mb-4 text-white uppercase tracking-tighter">ห้ามแคปภาพหน้าจอ!</h2>
                    <p className="text-gray-400 text-xl font-bold">ระบบได้บันทึกความพยายามในการละเมิดกฎการสอบของคุณแล้ว</p>
                </div>
            </div>
        );

        const Watermark = ({ text }) => {
            const items = Array.from({ length: 12 });
            return (<div className="watermark-container">{items.map((_, i) => <div key={i} className="watermark-text">{text}</div>)}</div>);
        };

        // --- 4. Modals ---
const ViewExamModal = ({ exam, examSet, onClose }) => {
    if (!exam) return null;
    return (
        <div className="fixed inset-0 bg-black/60 z-[9998] flex items-center justify-center p-4" onClick={onClose}>
            <div className="bg-white rounded-2xl max-w-3xl w-full max-h-[90vh] flex flex-col shadow-2xl animate-fade-in relative" onClick={e => e.stopPropagation()}>
                <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <div>
                        <h3 className="text-xl font-bold flex items-center gap-2"><FileText size={24} className="text-blue-600"/> ตรวจสอบข้อสอบ</h3>
                        <p className="text-sm text-slate-500 mt-1">
                            {exam.id} - {exam.title} 
                            {examSet && <span className="ml-2 text-blue-600">(ชุดที่ {examSet.setId})</span>}
                        </p>
                    </div>
                    <button onClick={onClose} className="text-slate-400 hover:text-red-500 transition-colors"><XCircle size={24}/></button>
                </div>
                <div className="p-6 overflow-y-auto space-y-8">
                    {exam.questions?.map((q, idx) => (
                        <div key={idx} className="bg-slate-50 p-5 rounded-2xl border border-slate-200">
                            {q.sectionTitle && (
                                <div className="bg-blue-600 text-white p-3 rounded-lg font-bold mb-3 flex items-center gap-2">
                                    <Layout size={18}/> {q.sectionTitle}
                                </div>
                            )}
                            {q.passage && (
                                <div className="bg-amber-50 border-l-4 border-amber-400 p-4 mb-4 text-sm italic whitespace-pre-line">
                                    <BookOpen size={14} className="inline mr-2 text-amber-600"/>{q.passage}
                                </div>
                            )}
                            <p className="font-bold text-lg mb-4 whitespace-pre-line">{idx + 1}. {q.text}</p>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                                {q.options.map((opt, oIdx) => {
                                    // ดึงเฉพาะตัวอักษรนำหน้า (A, B, C, D) และข้อความ
                                    let optionLetter = String.fromCharCode(65 + oIdx); // A, B, C, D
                                    let optionText = opt;
                                    
                                    // ถ้าตัวเลือกมีรูปแบบ A. ข้อความ ให้แยก
                                    const optionMatch = opt.match(/^([A-D])\.\s*(.+)/);
                                    if (optionMatch) {
                                        optionLetter = optionMatch[1];
                                        optionText = optionMatch[2];
                                    }
                                    
                                    return (
                                        <div key={oIdx} className={`p-3 rounded-xl border flex items-center gap-3 ${oIdx === q.correct ? 'bg-green-100 border-green-300 text-green-800 font-bold' : 'bg-white text-slate-600 border-slate-200'}`}>
                                            <span className="w-7 h-7 rounded-full bg-slate-200 flex items-center justify-center shrink-0 text-xs font-bold">{optionLetter}</span>
                                            <span className="whitespace-pre-line">{optionText}</span>
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                    ))}
                </div>
                <div className="p-4 border-t bg-slate-50 text-right">
                    <button onClick={onClose} className="px-8 py-2.5 bg-slate-800 text-white rounded-xl font-bold hover:bg-slate-900">ปิด</button>
                </div>
            </div>
        </div>
    );
};
        const EditExamModal = ({ exam, examSet, onClose, onSave }) => {
            const [data, setData] = useState({ 
                title: exam.title, 
                time: exam.timeLimit / 60,
                setId: examSet?.setId || 1
            });
            const [questions, setQuestions] = useState(exam.questions || []);

            const handleUpdateQuestion = (idx, field, value) => {
                const updated = [...questions];
                updated[idx] = { ...updated[idx], [field]: value };
                setQuestions(updated);
            };

            const handleUpdateOption = (qIdx, oIdx, value) => {
                const updated = [...questions];
                const opts = [...updated[qIdx].options];
                opts[oIdx] = value;
                updated[qIdx].options = opts;
                setQuestions(updated);
            };

            const addQuestion = () => {
                setQuestions([...questions, { 
                    id: Date.now() + Math.random(), 
                    text: '', 
                    options: ['', '', '', ''], 
                    correct: 0, 
                    sectionTitle: '', 
                    passage: '', 
                    passagePosition: 'top' 
                }]);
            };

            const removeQuestion = (idx) => {
                if(confirm('ลบข้อสอบข้อนี้?')) {
                    const updated = questions.filter((_, i) => i !== idx);
                    setQuestions(updated);
                }
            };

            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[9998] flex items-center justify-center p-4 md:p-10" onClick={onClose}>
                    <div className="bg-white rounded-[2rem] max-w-5xl w-full h-full flex flex-col shadow-2xl animate-fade-in overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="p-6 border-b flex justify-between items-center bg-slate-50">
                            <div>
                                <h3 className="text-2xl font-black flex items-center gap-2 uppercase tracking-tighter"><Edit size={24} className="text-blue-600"/> แก้ไขข้อสอบ</h3>
                                <p className="text-sm text-slate-500 font-bold uppercase tracking-widest">
                                    รหัสวิชา: {exam.id} | ชุดที่ {data.setId}
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 hover:bg-red-50 text-slate-400 hover:text-red-500 rounded-full transition-colors"><XCircle size={32}/></button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-8">
                            <section className="bg-slate-100 p-6 rounded-3xl grid grid-cols-1 md:grid-cols-3 gap-4">
                                <div className="md:col-span-2">
                                    <label className="block text-xs font-black text-slate-400 uppercase mb-2">ชื่อวิชา</label>
                                    <input type="text" value={data.title} onChange={e=>setData({...data, title: e.target.value})} className="w-full p-4 border rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold" />
                                </div>
                                <div>
                                    <label className="block text-xs font-black text-slate-400 uppercase mb-2">เวลาสอบ (นาที)</label>
                                    <input type="number" value={data.time} onChange={e=>setData({...data, time: parseInt(e.target.value) || 0})} className="w-full p-4 border rounded-2xl focus:ring-2 focus:ring-blue-500 outline-none font-bold" />
                                </div>
                            </section>
                            <section className="space-y-6">
                                <div className="flex justify-between items-center">
                                    <h4 className="font-black text-lg text-slate-800 uppercase tracking-tighter flex items-center gap-2">
                                        <List size={20} className="text-blue-600"/> รายการข้อสอบ ({questions.length})
                                    </h4>
                                    <button onClick={addQuestion} className="bg-blue-600 text-white px-5 py-2.5 rounded-xl font-black flex items-center gap-2 hover:bg-blue-700 active:scale-95 shadow-lg uppercase text-xs">
                                        <Plus size={18}/> เพิ่มข้อสอบ
                                    </button>
                                </div>
                                {questions.map((q, idx) => (
                                    <div key={idx} className="bg-white border-2 border-slate-100 p-8 rounded-3xl space-y-4 relative group shadow-sm">
                                        <button onClick={() => removeQuestion(idx)} className="absolute top-4 right-4 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-all">
                                            <Trash size={20}/>
                                        </button>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div className="md:col-span-2">
                                                <label className="text-[10px] font-black text-blue-500 uppercase mb-1 block">ตอนที่</label>
                                                <input type="text" value={q.sectionTitle || ''} onChange={e=>handleUpdateQuestion(idx, 'sectionTitle', e.target.value)} placeholder="เช่น ตอนที่ 1" className="w-full p-3 border rounded-xl bg-blue-50/20 text-sm focus:ring-2 focus:ring-blue-100 font-bold" />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="text-[10px] font-black text-amber-600 uppercase mb-1 block">บทอ่าน</label>
                                                <textarea rows="2" value={q.passage || ''} onChange={e=>handleUpdateQuestion(idx, 'passage', e.target.value)} className="w-full p-3 border rounded-xl bg-amber-50/20 text-sm focus:ring-1 focus:ring-blue-300 outline-none font-bold" />
                                            </div>
                                            <div>
                                                <label className="text-[10px] font-black text-slate-400 uppercase mb-1 block">ตำแหน่ง</label>
                                                <select value={q.passagePosition || 'top'} onChange={e=>handleUpdateQuestion(idx, 'passagePosition', e.target.value)} className="w-full p-2 border rounded-xl text-xs outline-none font-bold bg-white">
                                                    <option value="top">บน</option>
                                                    <option value="bottom">ล่าง</option>
                                                </select>
                                            </div>
                                            <div className="md:col-span-2 pt-4 border-t border-slate-50">
                                                <label className="text-xs font-black text-slate-800 uppercase mb-2 block">ข้อที่ {idx+1}</label>
                                                <input type="text" value={q.text} onChange={e=>handleUpdateQuestion(idx, 'text', e.target.value)} className="w-full p-4 border-2 border-slate-100 rounded-2xl font-black outline-none focus:border-blue-500" />
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                                            {q.options.map((opt, oIdx) => (
                                                <div key={oIdx} className="flex gap-2 items-center">
                                                    <input type="radio" checked={q.correct === oIdx} onChange={() => handleUpdateQuestion(idx, 'correct', oIdx)} className="w-4 h-4 accent-green-600 cursor-pointer" />
                                                    <input type="text" value={opt} onChange={e=>handleUpdateOption(idx, oIdx, e.target.value)} className={`flex-1 p-3.5 border-2 rounded-2xl text-sm outline-none transition-all ${q.correct === oIdx ? 'bg-green-50 border-green-400 font-black':'border-slate-100 focus:border-blue-200'}`} placeholder={`ตัวเลือก ${oIdx+1}`} />
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                ))}
                            </section>
                        </div>
                        <div className="p-6 border-t bg-slate-50 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-4 bg-white border-2 border-slate-200 rounded-2xl font-black hover:bg-slate-100 transition-all uppercase tracking-widest">ยกเลิก</button>
                            <button onClick={()=>onSave(exam.id, data.setId, { title: data.title, time: data.time * 60, questions })} className="flex-[2] py-4 bg-green-600 text-white rounded-2xl font-black shadow-xl hover:bg-green-700 transition-all active:scale-95 flex justify-center items-center gap-2 text-xl uppercase tracking-tighter">
                                บันทึกการเปลี่ยนแปลง
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const EditStudentModal = ({ student, onClose, onSave }) => {
            const [data, setData] = useState({ 
                id: student?.id || '', 
                name: student?.name || '', 
                surname: student?.surname || '', 
                classroom: student?.classroom || '' 
            });

            return (
                <div className="fixed inset-0 bg-slate-900/80 backdrop-blur-md z-[9998] flex items-center justify-center p-4">
                    <div className="bg-white rounded-[2.5rem] max-w-md w-full p-10 shadow-2xl animate-fade-in" onClick={e => e.stopPropagation()}>
                        <div className="flex justify-between items-center mb-8">
                            <div>
                                <h3 className="text-2xl font-black flex items-center gap-3 uppercase tracking-tighter"><Users className="text-blue-600"/> ข้อมูลนักเรียน</h3>
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">
                                    {student?.id ? 'แก้ไขข้อมูล' : 'เพิ่มนักเรียนใหม่'}
                                </p>
                            </div>
                            <button onClick={onClose} className="p-2 bg-slate-50 rounded-full text-slate-300 hover:text-red-500 transition-colors"><XCircle size={28}/></button>
                        </div>
                        <div className="space-y-5">
                            <div>
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">รหัสนักเรียน</label>
                                <input type="text" disabled={!!student?.id} value={data.id} onChange={e=>setData({...data, id: e.target.value})} className="w-full p-4 border-2 border-slate-50 rounded-2xl outline-none font-black text-blue-600 bg-slate-50" placeholder="00000" />
                            </div>
                            <div className="grid grid-cols-2 gap-3">
                                <div>
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">ชื่อ</label>
                                    <input type="text" value={data.name} onChange={e=>setData({...data, name: e.target.value})} className="w-full p-3 border-2 border-slate-50 rounded-xl font-bold" />
                                </div>
                                <div>
                                    <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">นามสกุล</label>
                                    <input type="text" value={data.surname} onChange={e=>setData({...data, surname: e.target.value})} className="w-full p-3 border-2 border-slate-50 rounded-xl font-bold" />
                                </div>
                            </div>
                            <div>
                                <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest mb-1 block">ห้องเรียน</label>
                                <input type="text" value={data.classroom} onChange={e=>setData({...data, classroom: e.target.value})} className="w-full p-3 border-2 border-slate-50 rounded-xl font-bold" placeholder="เช่น 601" />
                            </div>
                        </div>
                        <div className="mt-10 flex gap-4">
                            <button onClick={onClose} className="flex-1 py-4 border-2 border-slate-100 rounded-2xl font-black text-slate-300 uppercase">ยกเลิก</button>
                            <button onClick={()=>onSave(data)} className="flex-[2] py-4 bg-blue-600 text-white rounded-2xl font-black shadow-xl hover:bg-blue-700 transition-all uppercase">
                                บันทึกข้อมูล
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        // --- 5. Main App Component ---
        const SecureExamApp = () => {
            const [step, setStep] = useState('login'); 
            const [student, setStudent] = useState(null);
            const [studentIdInput, setStudentIdInput] = useState('');
            const [adminPassword, setAdminPassword] = useState('');
            const [subjects, setSubjects] = useState([]);
            const [examSets, setExamSets] = useState({});
            const [currentSubject, setCurrentSubject] = useState(null);
            const [currentExamSet, setCurrentExamSet] = useState(null);
            const [adminTab, setAdminTab] = useState('dashboard');
            const [adminTimeLimitInput, setAdminTimeLimitInput] = useState(5); 
            const [adminClassroomInput, setAdminClassroomInput] = useState('All');
            const [monitorFilterRoom, setMonitorFilterRoom] = useState('All'); 
            const [dashboardData, setDashboardData] = useState([]);
            const [editingExam, setEditingExam] = useState(null); 
            const [editingExamSet, setEditingExamSet] = useState(null);
            const [viewingExam, setViewingExam] = useState(null); 
            const [viewingExamSet, setViewingExamSet] = useState(null);
            const [editingStudent, setEditingStudent] = useState(null);
            const [finalResult, setFinalResult] = useState({ score: 0, total: 0 });
            const [systemConfig, setSystemConfig] = useState({ 
                activeSubjectId: '', 
                activeExamSetId: 1,
                isOpen: false, 
                customTimeLimit: 0, 
                activeClassroom: 'All', 
                examOpenedAt: '', 
                examStartMs: 0,
                roomPassword: '' 
            });
            const [currentQIdx, setCurrentQIdx] = useState(0); 
            const [timeLeft, setTimeLeft] = useState(0);
            const [answers, setAnswers] = useState({});
            const answersRef = useRef({}); 
            const [examStatus, setExamStatus] = useState('pending');
            const [loading, setLoading] = useState(false);
            const [loadingMessage, setLoadingMessage] = useState(''); 
            const [error, setError] = useState('');
            const [warningCount, setWarningCount] = useState(0);
            const [isBlackout, setIsBlackout] = useState(false);
            const [newAdminPassword, setNewAdminPassword] = useState('');
            const [adminGlobalPassword, setAdminGlobalPassword] = useState('admin1234');
            
            const [newSubject, setNewSubject] = useState({ id: '', title: '' });
            const [newExamSet, setNewExamSet] = useState({ 
                setId: 1, 
                title: '', 
                time: 60,
                questions: [] 
            });
            const [qDraft, setQDraft] = useState({ 
                text: '', 
                options: ['', '', '', ''], 
                correct: 0, 
                sectionTitle: '', 
                passage: '', 
                passagePosition: 'top' 
            });
            const [selectedSubjectId, setSelectedSubjectId] = useState('');
            
            const [confirmDelete, setConfirmDelete] = useState({ isOpen: false, type: '', subjectId: null, setId: null });
            const [toast, setToast] = useState({ show: false, message: '', type: 'success' });
            
            const timerRef = useRef(null);
            const unsubscribers = useRef([]);

            const showToast = useCallback((message, type = 'success') => {
                setToast({ show: true, message, type });
            }, []);

            const cleanupListeners = () => {
                unsubscribers.current.forEach(unsub => unsub?.());
                unsubscribers.current = [];
            };

            const availableClassrooms = useMemo(() => {
                if (!dashboardData || !Array.isArray(dashboardData)) return [];
                return Array.from(new Set(dashboardData.map(d => String(d.classroom || '').trim())))
                    .filter(c => c && c !== 'undefined' && c !== '')
                    .sort();
            }, [dashboardData]);

            const currentSubjectExams = useMemo(() => {
                if (!systemConfig.activeSubjectId) return [];
                return examSets[systemConfig.activeSubjectId] || [];
            }, [examSets, systemConfig.activeSubjectId]);

           const selectedExamPreview = useMemo(() => {
    if (!systemConfig.activeSubjectId || !systemConfig.activeExamSetId) return null;
    const sets = examSets[systemConfig.activeSubjectId] || [];
    // ใช้ == เพื่อให้ String "1" เท่ากับ Number 1 ได้
    return sets.find(s => s.setId == systemConfig.activeExamSetId);
}, [examSets, systemConfig.activeSubjectId, systemConfig.activeExamSetId]);

            const progress = useMemo(() => {
                if (!currentExamSet || !currentExamSet.questions) return 0;
                const answeredCount = currentExamSet.questions.filter(q => answers[q.id] !== undefined).length;
                return Math.round((answeredCount / currentExamSet.questions.length) * 100);
            }, [answers, currentExamSet]);

            const fetchAllData = async () => {
    setLoading(true);
    try {
        const subjectsSnap = await window.fb.getDocs(window.fb.collection(window.db, "subjects"));
        const subjectsData = subjectsSnap.docs.map(d => ({ 
            id: d.id, 
            ...d.data() 
        }));
        console.log('Subjects loaded:', subjectsData);
        setSubjects(subjectsData);
        
        const examSetsData = {};
        for (const subject of subjectsData) {
            const setsSnap = await window.fb.getDocs(
                window.fb.collection(window.db, "subjects", subject.id, "examSets")
            );
            examSetsData[subject.id] = setsSnap.docs.map(d => ({ 
                setId: parseInt(d.id), 
                ...d.data() 
            })).sort((a, b) => a.setId - b.setId);
            
            console.log(`Exam sets for ${subject.id}:`, examSetsData[subject.id]);
        }
        setExamSets(examSetsData);
        
        // ตรวจสอบว่า activeSubjectId ยังมีอยู่ใน subjects หรือไม่
        if (systemConfig.activeSubjectId) {
            const subjectExists = subjectsData.some(s => s.id === systemConfig.activeSubjectId);
            if (!subjectExists) {
                console.log('Active subject no longer exists, resetting...');
                await window.fb.updateDoc(window.fb.doc(window.db, "config", "system"), {
                    activeSubjectId: '',
                    activeExamSetId: 1
                });
            }
        }
        
        setLoading(false);
        return { subjects: subjectsData, examSets: examSetsData };
    } catch (err) { 
        console.error('Error fetching data:', err);
        setLoading(false);
        showToast('เกิดข้อผิดพลาดในการโหลดข้อมูล: ' + err.message, 'error');
        return { subjects: [], examSets: {} };
    }
};

            const exportToCSV = useCallback(() => {
                const filterRoom = monitorFilterRoom;
                const filtered = dashboardData.filter(d => filterRoom === 'All' || String(d.classroom).trim() === filterRoom.trim());
                
                if (filtered.length === 0) {
                    showToast('ไม่มีข้อมูลสำหรับการส่งออก', 'error');
                    return;
                }

                const subjectTitle = subjects.find(s => s.id === systemConfig.activeSubjectId)?.title || '';
                const examSetTitle = selectedExamPreview?.title || '';

                const headers = ["รหัสนักเรียน", "ชื่อ", "นามสกุล", "ห้อง", "คะแนน", "สถานะ", "หมายเหตุ"];
                const rows = filtered.map(d => [
                    `'${d.id}`,
                    `"${d.name || ''}"`,
                    `"${d.surname || ''}"`,
                    `"${d.classroom || ''}"`,
                    d.score ?? "-",
                    `"${d.status || ''}"`,
                    `"${d.reason || '-'}"`
                ]);

                const csvContent = "\ufeff" + [headers, ...rows].map(e => e.join(",")).join("\n");
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement("a");
                link.href = url; 
                link.download = `${subjectTitle}_${examSetTitle}_${Date.now()}.csv`;
                document.body.appendChild(link);
                link.click(); 
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
                showToast('ส่งออกรายงานสำเร็จ');
            }, [dashboardData, monitorFilterRoom, systemConfig.activeSubjectId, systemConfig.activeExamSetId, selectedExamPreview, subjects, showToast]);

const handleToggleExam = async (isOpen) => {
    // 1. ตรวจสอบความพร้อมเบื้องต้น
    if (isOpen) {
        if (!systemConfig.activeSubjectId || !systemConfig.activeExamSetId) {
            showToast('กรุณาเลือกวิชาและชุดข้อสอบให้ครบถ้วนก่อนเปิดสอบ', 'error');
            return;
        }
        const timeLimit = parseInt(adminTimeLimitInput);
        if (isNaN(timeLimit) || timeLimit <= 0) {
            showToast('กรุณาระบุเวลาสอบเป็นตัวเลขที่ถูกต้อง', 'error');
            return;
        }
    }

    setLoading(true);
    setLoadingMessage(isOpen ? 'กำลังเปิดระบบสอบ...' : 'กำลังปิดระบบสอบ...');
    
    try {
        // 2. กรณีปิดสอบ: ตรวจสอบนักเรียนที่ยังสอบไม่เสร็จ
        if (!isOpen && systemConfig.activeSubjectId) {
            const submissionsQuery = window.fb.query(
                window.fb.collection(window.db, "submissions"),
                window.fb.where("subjectId", "==", systemConfig.activeSubjectId),
                window.fb.where("examSetId", "==", Number(systemConfig.activeExamSetId)), // บังคับเป็น Number
                window.fb.where("status", "==", "IN_PROGRESS")
            );
            const submissionsSnap = await window.fb.getDocs(submissionsQuery);
            if (!submissionsSnap.empty) {
                if (!confirm(`มีนักเรียน ${submissionsSnap.size} คนกำลังสอบอยู่\nยืนยันที่จะปิดระบบและตัดสิทธิ์การสอบหรือไม่?`)) {
                    setLoading(false);
                    return;
                }
            }
        }
        
        // 3. เตรียมข้อมูลที่จะบันทึก (ป้องกันค่าเสียหาย)
        const updateData = {
            isOpen: !!isOpen, 
            customTimeLimit: (parseInt(adminTimeLimitInput) || 60) * 60, 
            activeClassroom: adminClassroomInput || 'All',
            examOpenedAt: isOpen ? new Date().toLocaleString('th-TH') : '', 
            examStartMs: isOpen ? Date.now() : 0
        };

        // 4. บันทึกลง Firestore
        await window.fb.updateDoc(window.fb.doc(window.db, "config", "system"), updateData);
        
        // 5. อัปเดต Local State ทันทีเพื่อให้ปุ่มเปลี่ยนสีทันใจ
        setSystemConfig(prev => ({ ...prev, ...updateData }));
        
        showToast(`ระบบสอบ ${isOpen ? 'เปิด' : 'ปิด'} เรียบร้อยแล้ว`);
    } catch (err) { 
        console.error("Toggle Error:", err);
        showToast('ไม่สามารถเปลี่ยนสถานะได้: ' + err.message, 'error');
    }
    setLoading(false);
};

            const handleChangeAdminPassword = async () => {
                if (!newAdminPassword || newAdminPassword.length < 4) {
                    showToast("รหัสผ่านต้องมีความยาวอย่างน้อย 4 ตัวอักษร", 'error');
                    return;
                }
                
                setLoading(true);
                try {
                    await window.fb.setDoc(window.fb.doc(window.db, "config", "admin"), { password: newAdminPassword });
                    setAdminGlobalPassword(newAdminPassword);
                    showToast("เปลี่ยนรหัสผ่านแอดมินสำเร็จ");
                    setNewAdminPassword('');
                } catch (err) { 
                    showToast("เกิดข้อผิดพลาด: " + err.message, 'error');
                }
                setLoading(false);
            };

            const handleResetSubmission = async (studentId) => {
                if (!confirm(`ยืนยันการรีเซ็ตสถานะการสอบของนักเรียนรหัส ${studentId}?`)) return;
                
                setLoading(true);
                try {
                    await window.fb.deleteDoc(
                        window.fb.doc(window.db, "submissions", `${studentId}_${systemConfig.activeSubjectId}_${systemConfig.activeExamSetId}`)
                    );
                    showToast("รีเซ็ตสถานะเรียบร้อย");
                } catch (err) { 
                    showToast(err.message, 'error');
                }
                setLoading(false);
            };
const handleChangeSubject = async (subjectId) => {
    if (!subjectId) return;
    setLoading(true);
    try {
        // หาชุดข้อสอบที่มีของวิชานี้
        const sets = examSets[subjectId] || [];
        // ถ้ามีชุดข้อสอบ ให้ใช้ ID ของชุดแรกที่มี ถ้าไม่มีให้ใช้ 1
        const firstSetId = sets.length > 0 ? Number(sets[0].setId) : 1;
        const firstTimeLimit = sets.length > 0 ? (sets[0].timeLimit / 60) : 60;

        const updateData = { 
            activeSubjectId: subjectId,
            activeExamSetId: firstSetId 
        };

        await window.fb.updateDoc(window.fb.doc(window.db, "config", "system"), updateData);
        
        // อัปเดต State ทันทีเพื่อป้องกัน UI กระโดดกลับ
        setSystemConfig(prev => ({ ...prev, ...updateData }));
        setAdminTimeLimitInput(firstTimeLimit);
        
        showToast(`สลับเป็นวิชา ${subjectId} เรียบร้อย`);
    } catch (err) {
        showToast('Error: ' + err.message, 'error');
    }
    setLoading(false);
};

const handleChangeExamSet = async (setId) => {
    if (!setId) return;
    const setIdNum = Number(setId); // บังคับเป็นตัวเลข
    setLoading(true);
    try {
        await window.fb.updateDoc(window.fb.doc(window.db, "config", "system"), { 
            activeExamSetId: setIdNum 
        });
        
        // อัปเดต Local State ทันที
        setSystemConfig(prev => ({ ...prev, activeExamSetId: setIdNum }));
        
        // อัปเดตเวลาตามชุดที่เลือก
        const sets = examSets[systemConfig.activeSubjectId] || [];
        const selectedSet = sets.find(s => Number(s.setId) === setIdNum);
        if (selectedSet) {
            setAdminTimeLimitInput(selectedSet.timeLimit / 60);
        }
        
        showToast('เปลี่ยนชุดข้อสอบเรียบร้อย');
    } catch (err) {
        showToast(err.message, 'error');
    }
    setLoading(false);
};

const handleFileSelect = async (e) => {
    const file = e.target.files[0];
    if (!file) return;
    
    setLoading(true);
    setLoadingMessage('กำลังอ่านไฟล์...');
    
    try {
        const arrayBuffer = await file.arrayBuffer();
        const result = await mammoth.extractRawText({ arrayBuffer });
        
        // เก็บบรรทัดไว้ตามเดิม ไม่ตัดช่องว่าง
        const lines = result.value.split('\n');
        
        const newQuestionsTemp = [];
        let currentQuestion = null;
        let collectingOptions = false;
        let currentOptions = [];
        let correctAnswer = null;
        let questionTextLines = [];
        let foundFirstOption = false;
        
        for (let i = 0; i < lines.length; i++) {
            const line = lines[i].replace(/\r$/, ''); // ลบ carriage return
            const trimmedLine = line.trim();
            
            // ข้ามบรรทัดว่างแต่เก็บไว้เป็นตัวแบ่ง
            if (trimmedLine === '') {
                if (collectingOptions && !foundFirstOption) {
                    questionTextLines.push(''); // เก็บบรรทัดว่างไว้ในคำถาม
                }
                continue;
            }
            
            // ตรวจสอบว่าเป็นข้อใหม่หรือไม่ (ขึ้นต้นด้วยตัวเลขและจุด)
            if (trimmedLine.match(/^\d+\./)) {
                // ถ้ามีคำถามก่อนหน้า ให้บันทึก
                if (currentQuestion && questionTextLines.length > 0) {
                    currentQuestion.text = questionTextLines.join('\n'); // ใช้ \n เพื่อรักษาบรรทัด
                    
                    if (correctAnswer !== null && currentOptions.length > 0) {
                        let correctIndex = -1;
                        const answerLetter = correctAnswer.toUpperCase();
                        
                        if (answerLetter === 'A') correctIndex = 0;
                        else if (answerLetter === 'B') correctIndex = 1;
                        else if (answerLetter === 'C') correctIndex = 2;
                        else if (answerLetter === 'D') correctIndex = 3;
                        
                        if (correctIndex !== -1) {
                            const questionData = {
                                id: Date.now() + Math.random() + i,
                                text: currentQuestion.text,
                                options: currentOptions.map(opt => {
                                    // เก็บตัวเลือกตามเดิม รวมทั้ง A. B. C. D.
                                    return opt;
                                }),
                                correct: correctIndex,
                                sectionTitle: '',
                                passage: '',
                                passagePosition: 'top'
                            };
                            newQuestionsTemp.push(questionData);
                        }
                    }
                }
                
                // เริ่มคำถามใหม่
                questionTextLines = [line]; // เก็บทั้งบรรทัดรวมทั้งตัวเลขข้อ
                currentQuestion = { text: '' };
                collectingOptions = true;
                currentOptions = [];
                correctAnswer = null;
                foundFirstOption = false;
            }
            // ตรวจสอบว่าเป็นตัวเลือก (A. B. C. D.)
            else if (collectingOptions && trimmedLine.match(/^[A-D]\./)) {
                foundFirstOption = true;
                currentOptions.push(line); // เก็บทั้งบรรทัดรวมทั้ง A.
            }
            // ตรวจสอบว่าเป็นเฉลย (ans: A หรือ เฉลย: A)
            else if (trimmedLine.match(/^(ans|เฉลย)\s*:\s*([A-D])/i)) {
                const match = trimmedLine.match(/^(ans|เฉลย)\s*:\s*([A-D])/i);
                if (match) {
                    correctAnswer = match[2];
                }
            }
            // ถ้าไม่ใช่ตัวเลือกและไม่ใช่เฉลย แสดงว่าเป็นข้อความคำถามเพิ่มเติม
            else if (collectingOptions && !foundFirstOption) {
                questionTextLines.push(line); // เก็บตามเดิม
            }
        }
        
        // เพิ่มคำถามสุดท้าย
        if (currentQuestion && questionTextLines.length > 0) {
            currentQuestion.text = questionTextLines.join('\n');
            
            if (correctAnswer !== null && currentOptions.length > 0) {
                let correctIndex = -1;
                const answerLetter = correctAnswer.toUpperCase();
                
                if (answerLetter === 'A') correctIndex = 0;
                else if (answerLetter === 'B') correctIndex = 1;
                else if (answerLetter === 'C') correctIndex = 2;
                else if (answerLetter === 'D') correctIndex = 3;
                
                if (correctIndex !== -1) {
                    const questionData = {
                        id: Date.now() + Math.random() + 999,
                        text: currentQuestion.text,
                        options: currentOptions.map(opt => opt),
                        correct: correctIndex,
                        sectionTitle: '',
                        passage: '',
                        passagePosition: 'top'
                    };
                    newQuestionsTemp.push(questionData);
                }
            }
        }
        
        // จัดรูปแบบข้อสอบที่นำเข้า (ไม่ต้องแก้ไขข้อความ)
        const formattedQuestions = newQuestionsTemp;
        
        // แสดงตัวอย่างการนำเข้า
        if (formattedQuestions.length > 0) {
            let previewMessage = `📋 พบข้อสอบทั้งหมด ${formattedQuestions.length} ข้อ\n\n`;
            
            formattedQuestions.slice(0, 1).forEach((q, idx) => {
                previewMessage += `ข้อ ${idx + 1}:\n${q.text}\n\n`;
                previewMessage += `ตัวเลือก:\n`;
                q.options.forEach((opt, optIdx) => {
                    previewMessage += `   ${opt}\n`;
                });
                previewMessage += `   ✅ เฉลย: ${String.fromCharCode(65 + q.correct)}\n\n`;
            });
            
            if (formattedQuestions.length > 1) {
                previewMessage += `... และอีก ${formattedQuestions.length - 1} ข้อ\n\n`;
            }
            
            if (confirm(previewMessage + '\n\nต้องการนำเข้าข้อสอบทั้งหมดนี้หรือไม่?')) {
                setNewExamSet(prev => ({
                    ...prev,
                    questions: [...prev.questions, ...formattedQuestions]
                }));
                showToast(`✅ นำเข้าข้อสอบ ${formattedQuestions.length} ข้อเรียบร้อย`);
            } else {
                showToast('❌ ยกเลิกการนำเข้า', 'error');
            }
        } else {
            showToast('❌ ไม่พบโครงสร้างข้อสอบในไฟล์ กรุณาตรวจสอบรูปแบบไฟล์', 'error');
            setTimeout(() => {
                showFileFormatExample();
            }, 1000);
        }
        
    } catch (err) {
        console.error(err);
        showToast('❌ เกิดข้อผิดพลาดในการอ่านไฟล์: ' + err.message, 'error');
    }
    
    setLoading(false);
    e.target.value = '';
};

            const addQuestionToDraft = () => {
                if (!qDraft.text || !qDraft.text.trim()) {
                    showToast('กรุณากรอกโจทย์', 'error');
                    return;
                }
                
                const validOptions = qDraft.options.filter(o => o && o.trim());
                if (validOptions.length < 2) {
                    showToast('กรุณากรอกตัวเลือกอย่างน้อย 2 ตัวเลือก', 'error');
                    return;
                }
                
                setNewExamSet(prev => ({
                    ...prev,
                    questions: [...prev.questions, { 
                        ...qDraft, 
                        id: Date.now() + Math.random(),
                        options: qDraft.options.map(o => o.trim())
                    }]
                }));
                
                setQDraft({ 
                    text: '', 
                    options: ['', '', '', ''], 
                    correct: 0, 
                    sectionTitle: '', 
                    passage: '', 
                    passagePosition: 'top' 
                });
                
                showToast('เพิ่มข้อสอบเรียบร้อย');
            };

            const handleCreateSubject = async () => {
                if (!newSubject.id || !newSubject.id.trim()) {
                    showToast('กรุณากรอกรหัสวิชา', 'error');
                    return;
                }
                if (!newSubject.title || !newSubject.title.trim()) {
                    showToast('กรุณากรอกชื่อวิชา', 'error');
                    return;
                }
                
                setLoading(true);
                setLoadingMessage('กำลังบันทึกวิชา...');
                
                try {
                    const existing = await window.fb.getDoc(window.fb.doc(window.db, "subjects", newSubject.id.trim()));
                    if (existing.exists()) {
                        showToast('รหัสวิชานี้มีอยู่แล้ว', 'error');
                        setLoading(false);
                        return;
                    }
                    
                    await window.fb.setDoc(
                        window.fb.doc(window.db, "subjects", newSubject.id.trim()), 
                        {
                            title: newSubject.title.trim(),
                            createdAt: new Date().toISOString()
                        }
                    );
                    
                    showToast('สร้างวิชาเรียบร้อย');
                    setNewSubject({ id: '', title: '' });
                    await fetchAllData();
                } catch (err) {
                    showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
                }
                
                setLoading(false);
            };

            const handleCreateExamSet = async () => {
                if (!selectedSubjectId) {
                    showToast('กรุณาเลือกวิชา', 'error');
                    return;
                }
                if (!newExamSet.title || !newExamSet.title.trim()) {
                    showToast('กรุณากรอกชื่อชุดข้อสอบ', 'error');
                    return;
                }
                if (newExamSet.questions.length === 0) {
                    showToast('กรุณาเพิ่มข้อสอบอย่างน้อย 1 ข้อ', 'error');
                    return;
                }
                
                setLoading(true);
                setLoadingMessage('กำลังบันทึกชุดข้อสอบ...');
                
                try {
                    const existingSets = examSets[selectedSubjectId] || [];
                    const maxSetId = existingSets.length > 0 ? Math.max(...existingSets.map(s => s.setId)) : 0;
                    const newSetId = maxSetId + 1;
                    
                    await window.fb.setDoc(
                        window.fb.doc(window.db, "subjects", selectedSubjectId, "examSets", newSetId.toString()), 
                        {
                            title: newExamSet.title.trim(),
                            timeLimit: newExamSet.time * 60,
                            questions: newExamSet.questions.filter(q => q.text && q.text.trim()),
                            createdAt: new Date().toISOString()
                        }
                    );
                    
                    showToast('สร้างชุดข้อสอบสำเร็จ');
                    setNewExamSet({ 
                        setId: 1, 
                        title: '', 
                        time: 60,
                        questions: [] 
                    });
                    setSelectedSubjectId('');
                    setQDraft({ text: '', options: ['', '', '', ''], correct: 0, sectionTitle: '', passage: '', passagePosition: 'top' });
                    await fetchAllData();
                } catch (err) {
                    showToast('เกิดข้อผิดพลาด: ' + err.message, 'error');
                }
                
                setLoading(false);
            };

            const prepareExamFromData = useCallback((subjectId, setId) => {
                const sets = examSets[subjectId] || [];
                const selectedSet = sets.find(s => s.setId === setId);
                
                if (!selectedSet) return;
                
                let processed = JSON.parse(JSON.stringify(selectedSet));
                const hasStructure = processed.questions.some(q => q.sectionTitle || q.passage);
                if (!hasStructure) processed.questions = shuffleArray(processed.questions);
                
                processed.questions = processed.questions.map(q => {
                    const opts = q.options.map((opt, i) => ({ text: opt, isCorrect: i === q.correct }));
                    const shuffled = shuffleArray(opts);
                    return { 
                        ...q, 
                        options: shuffled.map(o => o.text), 
                        correct: shuffled.findIndex(o => o.isCorrect) 
                    };
                });
                
                setCurrentExamSet({ 
                    ...processed, 
                    timeLimit: systemConfig.customTimeLimit || processed.timeLimit 
                });
                
                const subject = subjects.find(s => s.id === subjectId);
                setCurrentSubject(subject);
            }, [examSets, subjects, systemConfig.customTimeLimit]);

            const submitExam = useCallback(async (reason = 'Normal', isCheat = false) => {
    if (examStatus !== 'active' && !['TimeOut', 'Manual Submit', 'User Submitted'].includes(reason)) return;
    
    clearInterval(timerRef.current);
    setLoading(true); 
    setLoadingMessage('กำลังบันทึกคะแนน...');
    
    let score = 0;
    if (currentExamSet && currentExamSet.questions) {
        currentExamSet.questions.forEach(q => { 
            if(answersRef.current[q.id] === q.correct) score++; 
        });
    }
    
    try {
        await window.fb.setDoc(
            window.fb.doc(window.db, "submissions", `${student.id}_${currentSubject.id}_${currentExamSet.setId}`), 
            {
                studentId: student.id, 
                studentName: `${student.name} ${student.surname}`, 
                subjectId: currentSubject.id,
                subjectTitle: currentSubject.title,
                examSetId: Number(currentExamSet.setId),
                examSetTitle: currentExamSet.title,
                score: score, 
                totalScore: currentExamSet.questions.length, 
                status: isCheat ? 'CHEATED' : 'COMPLETED', 
                reason, 
                submittedAt: new Date().toISOString()
            },
            { merge: true }
        );
        
        // --- เปลี่ยนตรงนี้: บันทึกคะแนนลง State และเปลี่ยน Step ---
        setFinalResult({ score: score, total: currentExamSet.questions.length });
        setStep('result');
        showToast(`ส่งกระดาษคำตอบเรียบร้อยแล้ว`);
        
    } catch (err) { 
        showToast('เกิดข้อผิดพลาดในการส่งคำตอบ', 'error');
    }
    setLoading(false);
}, [currentExamSet, currentSubject, student, examStatus, showToast]);

          const handleStudentLogin = async (e) => {
    e.preventDefault(); 
    setLoading(true); 
    setError('');
    
    try {
        const inputId = studentIdInput.trim();
        if (!inputId) {
            setError('กรุณากรอกรหัสนักเรียน');
            setLoading(false);
            return;
        }
        
        const snap = await window.fb.getDoc(window.fb.doc(window.db, "students", inputId));
        
        if (snap.exists()) {
            const sData = { id: snap.id, ...snap.data() };
            setStudent(sData);
            
            const activeSubjectId = activeIdMatch(systemConfig.activeSubjectId);
            const activeSetId = systemConfig.activeExamSetId;

            // --- ส่วนที่แก้ไข: ตรวจสอบสิทธิ์ห้องเรียนทันทีที่เข้าสู่ระบบ ---
            const cfgRoom = String(systemConfig.activeClassroom || 'All').trim().toLowerCase();
            const studentRoom = String(sData.classroom || '').trim().toLowerCase();
            const isCorrectRoom = cfgRoom === 'all' || cfgRoom === studentRoom;
            
            // ต้องผ่านเงื่อนไข: ระบบเปิดสอบ + เลือกวิชาแล้ว + ห้องเรียนถูกต้อง
            if (systemConfig.isOpen && activeSubjectId && activeSetId && isCorrectRoom) { 
                await fetchAllData();
                const sets = examSets[activeSubjectId] || [];
                const found = sets.find(s => s.setId == activeSetId);
                
                if (found) { 
                    prepareExamFromData(activeSubjectId, activeSetId); 
                    setStep('instructions');
                } else {
                    setStep('waiting_room');
                }
            } else {
                // หากไม่ตรงเงื่อนไข (เช่น อยู่คนละห้อง) ให้ส่งไปที่หน้า Waiting Room
                setStep('waiting_room');
            }
            
            showToast('เข้าสู่ระบบสำเร็จ');
        } else {
            setError('ไม่พบรหัสนักเรียนในระบบ');
        }
    } catch (err) { 
        setError(err.message);
        showToast(err.message, 'error');
    }
    setLoading(false);
};
            const startExam = async () => {
    if (!systemConfig.isOpen) {
        showToast('ระบบปิดการสอบอยู่', 'error');
        return;
    }
    if (!currentExamSet) {
        showToast('ข้อมูลข้อสอบไม่พร้อม', 'error');
        return;
    }
    
    setLoading(true);
    setLoadingMessage('กำลังเตรียมห้องสอบและบันทึกสถานะ...');
    
    try {
        // --- ส่วนที่เพิ่มเข้ามา: บันทึกสถานะ IN_PROGRESS ลง Firestore ---
        await window.fb.setDoc(
            window.fb.doc(window.db, "submissions", `${student.id}_${currentSubject.id}_${currentExamSet.setId}`), 
            {
                studentId: student.id, 
                studentName: `${student.name} ${student.surname}`,
                classroom: student.classroom || '',
                subjectId: currentSubject.id,
                subjectTitle: currentSubject.title,
                examSetId: Number(currentExamSet.setId),
                examSetTitle: currentExamSet.title,
                status: 'IN_PROGRESS', 
                startedAt: new Date().toISOString(),
                score: null // ยังไม่มีคะแนนจนกว่าจะส่ง
            },
            { merge: true } // ใช้ merge เพื่อไม่ให้ไปทับข้อมูลอื่นที่มีอยู่
        );

        setTimeLeft(currentExamSet.timeLimit || 3600); 
        setStep('exam'); 
        setExamStatus('active');
        
        if (timerRef.current) clearInterval(timerRef.current);
        
        timerRef.current = setInterval(() => {
            setTimeLeft(prev => {
                if (prev <= 1) { 
                    submitExam('หมดเวลา'); 
                    return 0; 
                } 
                return prev - 1; 
            });
        }, 1000);
        
        showToast('เริ่มการสอบได้ ขอให้โชคดี');
    } catch (err) {
        console.error("Start Exam Error:", err);
        showToast('ไม่สามารถแจ้งสถานะเริ่มสอบได้: ' + err.message, 'error');
    }
    setLoading(false);
};

            const handleDeleteConfirm = async () => {
                if (!confirmDelete.subjectId) return;
                
                setLoading(true);
                setLoadingMessage('กำลังลบข้อมูล...');
                
                try {
                    if (confirmDelete.type === 'student') {
                        await window.fb.deleteDoc(window.fb.doc(window.db, "students", confirmDelete.subjectId));
                        showToast('ลบข้อมูลนักเรียนเรียบร้อย');
                    } else if (confirmDelete.type === 'subject') {
                        const sets = examSets[confirmDelete.subjectId] || [];
                        for (const set of sets) {
                            await window.fb.deleteDoc(
                                window.fb.doc(window.db, "subjects", confirmDelete.subjectId, "examSets", set.setId.toString())
                            );
                        }
                        await window.fb.deleteDoc(window.fb.doc(window.db, "subjects", confirmDelete.subjectId));
                        showToast('ลบวิชาและชุดข้อสอบเรียบร้อย');
                        await fetchAllData();
                    } else if (confirmDelete.type === 'examSet') {
                        await window.fb.deleteDoc(
                            window.fb.doc(window.db, "subjects", confirmDelete.subjectId, "examSets", confirmDelete.setId.toString())
                        );
                        showToast('ลบชุดข้อสอบเรียบร้อย');
                        await fetchAllData();
                    }
                } catch (err) {
                    showToast(err.message, 'error');
                }
                
                setLoading(false);
                setConfirmDelete({ isOpen: false, type: '', subjectId: null, setId: null });
            };

            // --- Effects ---
            useEffect(() => {
                const init = async () => {
                    await fetchAllData();
                    
                    const adminDoc = await window.fb.getDoc(window.fb.doc(window.db, "config", "admin"));
                    if (!adminDoc.exists()) {
                        await window.fb.setDoc(window.fb.doc(window.db, "config", "admin"), { 
                            password: "admin1234" 
                        });
                    }
                };
                
                init();
                
                const unsubConfig = window.fb.onSnapshot(
                    window.fb.doc(window.db, "config", "system"), 
                    (doc) => {
                        if (doc.exists()) setSystemConfig(doc.data());
                    }
                );
                
                const unsubAdmin = window.fb.onSnapshot(
                    window.fb.doc(window.db, "config", "admin"), 
                    (doc) => {
                        if (doc.exists()) setAdminGlobalPassword(doc.data().password);
                    }
                );
                
                unsubscribers.current.push(unsubConfig, unsubAdmin);
                
                return () => {
                    cleanupListeners();
                };
            }, []);

            useEffect(() => {
                let unsubStudent = null;
                
                if (student?.id && (['waiting_room', 'instructions', 'exam'].includes(step))) {
                    unsubStudent = window.fb.onSnapshot(
                        window.fb.doc(window.db, "students", student.id), 
                        (doc) => {
                            if (doc.exists()) setStudent({ id: doc.id, ...doc.data() });
                        }
                    );
                    
                    if (unsubStudent) {
                        unsubscribers.current.push(unsubStudent);
                    }
                }
                
                return cleanupListeners;
            }, [student?.id, step]);

            useEffect(() => {
                let unsubSubmissions = null;
                
                if (step === 'admin_dashboard' && (adminTab === 'manage_students' || adminTab === 'dashboard')) {
                    setLoading(true);
                    
                    window.fb.getDocs(window.fb.collection(window.db, "students"))
                        .then(snap => {
                            const allStudents = snap.docs.map(d => ({id: d.id, ...d.data()}));
                            
                            // ปรับปรุงส่วนการสร้าง subQuery ใน useEffect
const subQuery = window.fb.query(
    window.fb.collection(window.db, "submissions"), 
    window.fb.where("subjectId", "==", systemConfig.activeSubjectId || "NONE"),
    window.fb.where("examSetId", "==", Number(systemConfig.activeExamSetId) || 0) // บังคับเป็น Number
);
                            
                            unsubSubmissions = window.fb.onSnapshot(subQuery, (subSnap) => {
                                const submissions = {};
                                subSnap.forEach(doc => { 
                                    submissions[doc.data().studentId] = doc.data(); 
                                });
                                
                                setDashboardData(allStudents.map(std => {
                                    const sub = submissions[std.id];
                                    return { 
                                        ...std, 
                                        score: sub?.score, 
                                        status: sub?.status || 'รอเข้าสอบ', 
                                        reason: sub?.reason 
                                    };
                                }));
                                setLoading(false);
                            }, (error) => {
                                console.error(error);
                                setLoading(false);
                            });
                            
                            if (unsubSubmissions) {
                                unsubscribers.current.push(unsubSubmissions);
                            }
                        })
                        .catch(() => setLoading(false));
                }
                
                return cleanupListeners;
            }, [step, adminTab, systemConfig.activeSubjectId, systemConfig.activeExamSetId]);

useEffect(() => {
    const autoRedirect = async () => {
        // ต้องอยู่ในหน้า Waiting Room และระบบเปิดสอบแล้ว
        if (step !== 'waiting_room' || !systemConfig.isOpen || !systemConfig.activeSubjectId || !student) return;
        
        const cfgRoom = String(systemConfig.activeClassroom || 'All').trim().toLowerCase();
        const studentRoom = String(student.classroom || '').trim().toLowerCase();
        const isCorrectRoom = cfgRoom === 'all' || cfgRoom === studentRoom;
        
        // เฉพาะนักเรียนที่ห้องเรียนตรงกับที่ Admin กำหนดเท่านั้นที่จะถูกดึงเข้าสอบ
        if (isCorrectRoom) {
            setLoading(true); 
            setLoadingMessage('กำลังตรวจสอบสิทธิ์ห้องเรียน...');
            
            // โหลดข้อมูลล่าสุดเพื่อความมั่นใจ
            const latestData = await fetchAllData();
            const sets = latestData.examSets[systemConfig.activeSubjectId] || [];
            const found = sets.find(s => s.setId == systemConfig.activeExamSetId);
            
            if (found) { 
                prepareExamFromData(systemConfig.activeSubjectId, systemConfig.activeExamSetId); 
                setStep('instructions');
            }
            setLoading(false);
        }
    };
    
    autoRedirect();
}, [systemConfig.isOpen, systemConfig.activeSubjectId, systemConfig.activeExamSetId, systemConfig.activeClassroom, step, student]);
            // Anti-Cheat
            useEffect(() => {
                if (step !== 'exam' || examStatus !== 'active') return;
                
                const handleCheat = () => {
                    setWarningCount(prev => {
                        const next = prev + 1;
                        if (next <= 2) { 
                            showToast(`⚠️ คำเตือน ${next}/2: ห้ามสลับหน้าจอหรือพับแท็บเด็ดขาด!`, 'error'); 
                            return next; 
                        } else { 
                            submitExam('สลับหน้าจอเกินกำหนด', true); 
                            return next; 
                        }
                    });
                };
                
                const handleVisibility = () => { 
                    if (document.hidden) handleCheat(); 
                };
                
                const handleKeyDown = (e) => {
                    if (e.key === 'PrintScreen' || (e.ctrlKey && e.shiftKey && e.key === 'S')) {
                        setIsBlackout(true);
                        setTimeout(() => setIsBlackout(false), 4000);
                        showToast('🚨 ตรวจพบพฤติกรรมสุ่มเสี่ยงต่อการทุจริต', 'error');
                    }
                };
                
                document.addEventListener('visibilitychange', handleVisibility);
                document.addEventListener('keydown', handleKeyDown);
                document.addEventListener('contextmenu', e => e.preventDefault());
                
                return () => {
                    document.removeEventListener('visibilitychange', handleVisibility);
                    document.removeEventListener('keydown', handleKeyDown);
                };
            }, [step, examStatus, submitExam, showToast]);

            // ✅ useEffect สำหรับตรวจสอบการนำเข้า
            useEffect(() => {
                if (newExamSet.questions.length > 0) {
                    const lastQuestion = newExamSet.questions[newExamSet.questions.length - 1];
                    const optionCount = lastQuestion.options.filter(o => o && o.trim() !== '').length;
                    
                    if (optionCount < 2) {
                        showToast('⚠️ ข้อสอบบางข้อมีตัวเลือกน้อยกว่า 2 ตัวเลือก กรุณาตรวจสอบ', 'error');
                    }
                }
            }, [newExamSet.questions]);
            
            // ✅ useEffect สำหรับติดตามการเปลี่ยนแปลงของ systemConfig
            useEffect(() => {
                console.log('systemConfig updated:', systemConfig);
            }, [systemConfig]);
            
            // ✅ useEffect สำหรับโหลดข้อมูลเมื่อเข้าสู่หน้า manage_exams
            useEffect(() => {
                if (step === 'admin_dashboard' && adminTab === 'manage_exams') {
                    fetchAllData();
                }
            }, [step, adminTab]);

            // แก้ไข useEffect ส่วนนี้ให้เหลือเพียงการโหลดเวลาครับ
useEffect(() => {
    if (systemConfig.activeSubjectId && systemConfig.activeExamSetId) {
        const sets = examSets[systemConfig.activeSubjectId] || [];
        const selectedSet = sets.find(s => Number(s.setId) === Number(systemConfig.activeExamSetId));
        if (selectedSet) {
            setAdminTimeLimitInput(selectedSet.timeLimit / 60);
        }
    }
}, [systemConfig.activeSubjectId, systemConfig.activeExamSetId, examSets]);

            
useEffect(() => {
    const syncTimeLimit = () => {
        if (systemConfig.activeSubjectId && systemConfig.activeExamSetId) {
            const sets = examSets[systemConfig.activeSubjectId] || [];
            const selectedSet = sets.find(s => Number(s.setId) === Number(systemConfig.activeExamSetId));
            
            if (selectedSet) {
                // อัปเดตเวลาในช่อง Input ให้ตรงกับชุดข้อสอบที่เลือกในฐานข้อมูล
                setAdminTimeLimitInput(selectedSet.timeLimit / 60);
            }
        }
    };
    syncTimeLimit();
}, [systemConfig.activeSubjectId, systemConfig.activeExamSetId, examSets]);          
            
            // Manage Students Tab
            const renderManageStudents = () => (
                <div className="space-y-6">
                    <div className="flex justify-between items-center">
                        <h3 className="font-black text-2xl uppercase tracking-tighter">
                            จัดการนักเรียน
                        </h3>
                        <button 
                            onClick={() => setEditingStudent({})} 
                            className="bg-slate-900 text-white px-6 py-3 rounded-2xl font-black flex items-center gap-2 shadow-xl uppercase text-xs tracking-widest"
                        >
                            <Plus size={18}/> เพิ่มนักเรียน
                        </button>
                    </div>
                    
                    <div className="bg-white border-2 border-slate-50 rounded-[3rem] overflow-hidden shadow-xl">
                        <table className="w-full text-left border-collapse">
                            <thead className="bg-slate-50 text-slate-400 text-[10px] font-black uppercase border-b">
                                <tr>
                                    <th className="p-6">รหัสนักเรียน</th>
                                    <th className="p-6">ชื่อ-นามสกุล</th>
                                    <th className="p-6 text-center">ห้อง</th>
                                    <th className="p-6 text-right">จัดการ</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y-2 divide-slate-50">
                                {dashboardData.map(std => (
                                    <tr key={std.id} className="hover:bg-slate-50/70 transition-all">
                                        <td className="p-6 font-mono font-black text-blue-600">{std.id}</td>
                                        <td className="p-6 font-black text-xl">{std.name} {std.surname}</td>
                                        <td className="p-6 text-center font-black text-slate-400 text-lg">ห้อง {std.classroom}</td>
                                        <td className="p-6 text-right">
                                            <div className="flex gap-2 justify-end">
                                                <button 
                                                    onClick={() => setEditingStudent(std)} 
                                                    className="p-4 bg-slate-50 rounded-2xl text-slate-400 hover:text-blue-600 transition-all shadow-sm"
                                                >
                                                    <Edit size={20}/>
                                                </button>
                                                <button 
                                                    onClick={() => setConfirmDelete({ isOpen: true, type: 'student', subjectId: std.id, setId: null })} 
                                                    className="p-4 bg-slate-50 rounded-2xl text-slate-400 hover:text-red-500 transition-all shadow-sm"
                                                >
                                                    <Trash size={20}/>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            // Manage Exams Tab
            const renderManageExams = () => (
                <div className="space-y-8">
                    <h3 className="font-black text-2xl border-b-2 border-slate-50 pb-4 flex items-center gap-3 uppercase tracking-tighter">
                        <List size={28} className="text-blue-600"/> จัดการวิชาและข้อสอบ
                    </h3>
                    
                    <div className="flex justify-end">
                        <button 
                            onClick={() => {
                                setLoading(true);
                                fetchAllData().then(() => {
                                    showToast('รีเฟรชข้อมูลเรียบร้อย');
                                });
                            }}
                            className="bg-blue-50 text-blue-600 px-4 py-2 rounded-xl font-black flex items-center gap-2 hover:bg-blue-100 transition-all"
                        >
                            <RefreshCw size={18}/> รีเฟรชข้อมูล
                        </button>
                    </div>
                    
                    <div className="space-y-6">
                        {subjects.length > 0 ? (
                            subjects.map(subject => {
                                const subjectExamSets = examSets[subject.id] || [];
                                
                                return (
                                    <div key={subject.id} className="bg-white p-8 rounded-[2.5rem] border-2 border-slate-50 shadow-sm">
                                        <div className="flex justify-between items-center mb-6">
                                            <div>
                                                <h4 className="font-black text-2xl">{subject.title || 'ไม่ระบุชื่อ'}</h4>
                                                <p className="text-sm text-slate-400 font-black">รหัสวิชา: {subject.id}</p>
                                            </div>
                                            <div className="flex gap-2">
                                                <button 
                                                    onClick={() => {
                                                        setSelectedSubjectId(subject.id);
                                                        setAdminTab('create_exam');
                                                    }} 
                                                    className="p-4 bg-blue-50 text-blue-600 rounded-2xl hover:bg-blue-100 transition-all"
                                                    title="เพิ่มชุดข้อสอบ"
                                                >
                                                    <Plus size={20}/>
                                                </button>
                                                <button 
                                                    onClick={() => setConfirmDelete({ isOpen: true, type: 'subject', subjectId: subject.id, setId: null })} 
                                                    className="p-4 bg-red-50 text-red-500 rounded-2xl hover:bg-red-100 transition-all"
                                                    title="ลบวิชา"
                                                >
                                                    <Trash size={20}/>
                                                </button>
                                            </div>
                                        </div>
                                        
                                        <div className="space-y-4">
                                            <h5 className="font-black text-sm text-slate-400 uppercase tracking-wider">
                                                ชุดข้อสอบทั้งหมด ({subjectExamSets.length})
                                            </h5>
                                            
                                            {subjectExamSets.length > 0 ? (
                                                <div className="grid grid-cols-1 gap-4">
                                                    {subjectExamSets.map(set => (
                                                        <div key={set.setId} className="bg-slate-50 p-6 rounded-2xl border border-slate-200">
                                                            <div className="flex justify-between items-start">
                                                                <div>
                                                                    <h6 className="font-black text-lg">
                                                                        ชุดที่ {set.setId}: {set.title || 'ไม่ระบุชื่อ'}
                                                                    </h6>
                                                                    <div className="flex gap-4 text-xs text-slate-500 font-bold mt-2">
                                                                        <span>📝 จำนวนข้อ: {set.questions?.length || 0} ข้อ</span>
                                                                        <span>⏱️ เวลา: {set.timeLimit ? set.timeLimit / 60 : 0} นาที</span>
                                                                    </div>
                                                                    {set.createdAt && (
                                                                        <p className="text-xs text-slate-400 mt-1">
                                                                            สร้างเมื่อ: {new Date(set.createdAt).toLocaleString('th-TH')}
                                                                        </p>
                                                                    )}
                                                                </div>
                                                                <div className="flex gap-2">
                                                                    <button 
                                                                        onClick={() => {
                                                                            setEditingExam(set);
                                                                            setEditingExamSet({ subjectId: subject.id, setId: set.setId });
                                                                        }} 
                                                                        className="p-3 bg-white text-slate-600 rounded-xl hover:bg-blue-50 hover:text-blue-600 transition-all"
                                                                        title="แก้ไข"
                                                                    >
                                                                        <Edit size={18}/>
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => {
                                                                            setViewingExam({ ...set, id: subject.id });
                                                                            setViewingExamSet({ subjectId: subject.id, setId: set.setId });
                                                                        }} 
                                                                        className="p-3 bg-white text-slate-600 rounded-xl hover:bg-green-50 hover:text-green-600 transition-all"
                                                                        title="ดูตัวอย่าง"
                                                                    >
                                                                        <Eye size={18}/>
                                                                    </button>
                                                                    <button 
                                                                        onClick={() => setConfirmDelete({ isOpen: true, type: 'examSet', subjectId: subject.id, setId: set.setId })} 
                                                                        className="p-3 bg-white text-slate-600 rounded-xl hover:bg-red-50 hover:text-red-500 transition-all"
                                                                        title="ลบ"
                                                                    >
                                                                        <Trash size={18}/>
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    ))}
                                                </div>
                                            ) : (
                                                <div className="text-center p-8 bg-slate-50 rounded-2xl border-2 border-dashed">
                                                    <p className="text-slate-400 font-black">ยังไม่มีชุดข้อสอบ</p>
                                                    <button 
                                                        onClick={() => {
                                                            setSelectedSubjectId(subject.id);
                                                            setAdminTab('create_exam');
                                                        }}
                                                        className="mt-4 text-blue-600 font-black hover:text-blue-700"
                                                    >
                                                        + คลิกเพื่อเพิ่มชุดข้อสอบ
                                                    </button>
                                                </div>
                                            )}
                                        </div>
                                    </div>
                                );
                            })
                        ) : (
                            <div className="text-center p-12 bg-slate-50 rounded-3xl border-2 border-dashed">
                                <p className="text-slate-400 font-black text-lg">ยังไม่มีวิชาในระบบ</p>
                                <p className="text-sm text-slate-300 mt-2">ไปที่แท็บ "สร้างข้อสอบ" เพื่อเพิ่มวิชาและชุดข้อสอบ</p>
                                <button 
                                    onClick={() => setAdminTab('create_exam')}
                                    className="mt-6 bg-blue-600 text-white px-8 py-4 rounded-2xl font-black hover:bg-blue-700 transition-all"
                                >
                                    <Plus size={20} className="inline mr-2"/> สร้างวิชาแรก
                                </button>
                            </div>
                        )}
                    </div>
                </div>
            );

            // Create Exam Tab
            const renderCreateExam = () => (
                <div className="space-y-8 max-w-4xl mx-auto">
                    <div className="bg-blue-50 p-8 rounded-[2.5rem] border-2 border-blue-100">
                        <h3 className="font-black text-xl mb-6 flex items-center gap-2">
                            <Plus size={24} className="text-blue-600"/> สร้างวิชาใหม่
                        </h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <input 
                                type="text" 
                                placeholder="รหัสวิชา (เช่น MATH101)" 
                                value={newSubject.id} 
                                onChange={e => setNewSubject({...newSubject, id: e.target.value})} 
                                className="w-full p-4 border-2 border-white rounded-2xl font-black bg-white" 
                            />
                            <input 
                                type="text" 
                                placeholder="ชื่อวิชา" 
                                value={newSubject.title} 
                                onChange={e => setNewSubject({...newSubject, title: e.target.value})} 
                                className="w-full p-4 border-2 border-white rounded-2xl font-black bg-white" 
                            />
                            <button 
                                onClick={handleCreateSubject} 
                                className="md:col-span-2 bg-blue-600 text-white py-4 rounded-2xl font-black hover:bg-blue-700 transition-all"
                            >
                                สร้างวิชา
                            </button>
                        </div>
                    </div>

                    <div className="bg-white p-8 rounded-[2.5rem] border-2 border-slate-50">
                        <h3 className="font-black text-xl mb-6">เลือกวิชาสำหรับสร้างชุดข้อสอบ</h3>
                        <select 
                            value={selectedSubjectId} 
                            onChange={e => setSelectedSubjectId(e.target.value)}
                            className="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50 mb-6"
                        >
                            <option value="">-- เลือกวิชา --</option>
                            {subjects.map(subject => (
                                <option key={subject.id} value={subject.id}>
                                    {subject.id} - {subject.title}
                                </option>
                            ))}
                        </select>
                        
                        {selectedSubjectId && (
                            <>
                                <div className="bg-emerald-50 p-6 rounded-2xl border-2 border-emerald-100 flex items-center justify-between mb-6">
                                    <div className="flex items-center gap-4">
                                        <div className="p-3 bg-emerald-600 text-white rounded-2xl">
                                            <FileText size={24}/>
                                        </div>
                                        <div>
                                            <h4 className="font-black">นำเข้าจาก Word</h4>
                                            <p className="text-xs text-emerald-600">อัปโหลด .docx เพื่อสร้างข้อสอบ</p>
                                        </div>
                                    </div>
                                    <div className="flex gap-2">
                                        <button 
                                            onClick={showFileFormatExample}
                                            className="bg-slate-200 text-slate-700 px-4 py-3 rounded-2xl font-black hover:bg-slate-300 transition-all text-sm flex items-center gap-1"
                                            title="ดูตัวอย่างรูปแบบไฟล์"
                                        >
                                            <Eye size={18}/> ตัวอย่าง
                                        </button>
                                        <label className="bg-emerald-600 text-white px-6 py-3 rounded-2xl cursor-pointer font-black hover:bg-emerald-700 transition-all flex items-center gap-2">
                                            <Upload size={18}/> เลือกไฟล์
                                            <input type="file" accept=".docx" onChange={handleFileSelect} className="hidden" />
                                        </label>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                                    <input 
                                        type="text" 
                                        placeholder="ชื่อชุดข้อสอบ" 
                                        value={newExamSet.title} 
                                        onChange={e => setNewExamSet({...newExamSet, title: e.target.value})} 
                                        className="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50" 
                                    />
                                    <input 
                                        type="number" 
                                        placeholder="เวลา (นาที)" 
                                        value={newExamSet.time} 
                                        onChange={e => setNewExamSet({...newExamSet, time: parseInt(e.target.value) || 0})} 
                                        className="w-full p-4 border-2 border-slate-50 rounded-2xl font-black bg-slate-50" 
                                        min="1"
                                    />
                                </div>

                                <div className="bg-slate-50 p-6 rounded-3xl space-y-6">
                                    <h4 className="font-black">สร้างข้อสอบ</h4>
                                    
                                    <input 
                                        type="text" 
                                        placeholder="หัวข้อส่วน (ถ้ามี)" 
                                        value={qDraft.sectionTitle} 
                                        onChange={e => setQDraft({...qDraft, sectionTitle: e.target.value})} 
                                        className="w-full p-4 border-2 border-white rounded-2xl bg-white font-bold" 
                                    />
                                    
                                    <textarea 
                                        rows="2" 
                                        placeholder="บทอ่าน (ถ้ามี)" 
                                        value={qDraft.passage} 
                                        onChange={e => setQDraft({...qDraft, passage: e.target.value})} 
                                        className="w-full p-4 border-2 border-white rounded-2xl bg-white font-bold" 
                                    />
                                    
                                    <div className="flex gap-4">
                                        <select 
                                            value={qDraft.passagePosition} 
                                            onChange={e => setQDraft({...qDraft, passagePosition: e.target.value})}
                                            className="p-3 border-2 border-white rounded-xl bg-white font-bold"
                                        >
                                            <option value="top">แสดงด้านบน</option>
                                            <option value="bottom">แสดงด้านล่าง</option>
                                        </select>
                                    </div>
                                    
                                    <input 
                                        type="text" 
                                        placeholder="โจทย์ข้อสอบ" 
                                        value={qDraft.text} 
                                        onChange={e => setQDraft({...qDraft, text: e.target.value})} 
                                        className="w-full p-4 border-2 border-white rounded-2xl bg-white font-black text-lg" 
                                    />
                                    
                                    <div className="space-y-3">
                                        {qDraft.options.map((opt, i) => (
                                            <div key={i} className="flex gap-3 items-center">
                                                <input 
                                                    type="radio" 
                                                    checked={qDraft.correct === i} 
                                                    onChange={() => setQDraft({...qDraft, correct: i})} 
                                                    className="w-5 h-5 accent-green-600" 
                                                />
                                                <input 
                                                    type="text" 
                                                    value={opt} 
                                                    onChange={e => {
                                                        const n = [...qDraft.options];
                                                        n[i] = e.target.value;
                                                        setQDraft({...qDraft, options: n});
                                                    }} 
                                                    className={`flex-1 p-3 border-2 rounded-xl font-bold ${
                                                        qDraft.correct === i ? 'bg-green-50 border-green-400' : 'bg-white border-slate-200'
                                                    }`}
                                                    placeholder={`ตัวเลือก ${i + 1}`} 
                                                />
                                            </div>
                                        ))}
                                        
                                        {qDraft.options.length < 6 && (
                                            <button 
                                                onClick={() => setQDraft(p => ({...p, options: [...p.options, '']}))} 
                                                className="text-sm text-blue-600 font-black"
                                            >
                                                + เพิ่มตัวเลือก
                                            </button>
                                        )}
                                    </div>
                                    
                                    <button 
                                        onClick={addQuestionToDraft} 
                                        className="w-full bg-slate-800 text-white py-4 rounded-2xl font-black hover:bg-black transition-all flex items-center justify-center gap-2"
                                    >
                                        <Plus size={20}/> เพิ่มข้อสอบ ({newExamSet.questions.length})
                                    </button>
                                </div>

                                {newExamSet.questions.length > 0 && (
                                    <button 
                                        onClick={handleCreateExamSet} 
                                        className="w-full bg-green-600 text-white py-5 rounded-2xl font-black text-xl hover:bg-green-700 transition-all mt-6"
                                    >
                                        บันทึกชุดข้อสอบ
                                    </button>
                                )}
                            </>
                        )}
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen text-slate-800 selection:bg-blue-100">
                    {loading && <LoadingOverlay message={loadingMessage} />}
                    {isBlackout && <BlackoutOverlay />}
                    
                    <ConfirmDialog 
                        isOpen={confirmDelete.isOpen}
                        title="ยืนยันการลบ"
                        message="คุณแน่ใจหรือไม่ว่าต้องการลบรายการนี้? การกระทำนี้ไม่สามารถเรียกคืนได้"
                        onConfirm={handleDeleteConfirm}
                        onCancel={() => setConfirmDelete({ isOpen: false, type: '', subjectId: null, setId: null })}
                    />
                    
                    {toast.show && (
                        <Toast 
                            message={toast.message} 
                            type={toast.type} 
                            onClose={() => setToast({ show: false, message: '', type: 'success' })}
                        />
                    )}
                    
                    {/* Modals */}
                    {editingExam && editingExamSet && (
                        <EditExamModal 
                            exam={{ ...editingExam, id: editingExamSet.subjectId }} 
                            examSet={{ setId: editingExamSet.setId }}
                            onClose={() => {
                                setEditingExam(null);
                                setEditingExamSet(null);
                            }} 
                            onSave={async (subjectId, setId, updateData) => {
                                setLoading(true);
                                setLoadingMessage('กำลังบันทึกการเปลี่ยนแปลง...');
                                try { 
                                    await window.fb.updateDoc(
                                        window.fb.doc(window.db, "subjects", subjectId, "examSets", setId.toString()), 
                                        { 
                                            title: updateData.title, 
                                            timeLimit: updateData.time, 
                                            questions: updateData.questions 
                                        }
                                    ); 
                                    showToast('บันทึกการเปลี่ยนแปลงเรียบร้อย'); 
                                    setEditingExam(null); 
                                    setEditingExamSet(null);
                                    await fetchAllData(); 
                                } catch (err) { 
                                    showToast(err.message, 'error');
                                }
                                setLoading(false);
                            }} 
                        />
                    )}
                    
                    {viewingExam && (
                        <ViewExamModal 
                            exam={viewingExam} 
                            examSet={viewingExamSet}
                            onClose={() => {
                                setViewingExam(null);
                                setViewingExamSet(null);
                            }} 
                        />
                    )}
                    
                    {editingStudent !== null && (
                        <EditStudentModal 
                            student={editingStudent} 
                            onClose={() => setEditingStudent(null)} 
                            onSave={async (data) => {
                                if (!data.id || !data.id.trim()) {
                                    showToast('กรุณากรอกรหัสนักเรียน', 'error');
                                    return;
                                }
                                if (!data.name || !data.name.trim()) {
                                    showToast('กรุณากรอกชื่อ', 'error');
                                    return;
                                }
                                
                                setLoading(true); 
                                setLoadingMessage('กำลังบันทึกข้อมูล...');
                                
                                try {
                                    await window.fb.setDoc(
                                        window.fb.doc(window.db, "students", data.id.trim()), 
                                        { 
                                            name: data.name, 
                                            surname: data.surname, 
                                            classroom: data.classroom 
                                        }
                                    );
                                    setEditingStudent(null); 
                                    showToast('บันทึกข้อมูลเรียบร้อย');
                                } catch (err) {
                                    showToast(err.message, 'error');
                                }
                                
                                setLoading(false);
                            }} 
                        />
                    )}

                    {/* Login นักเรียน */}
                    {step === 'login' && (
                        <div className="min-h-screen flex items-center justify-center p-4">
                            <div className="glass-card p-10 rounded-3xl shadow-2xl w-full max-w-md relative text-center animate-fade-in border-white border-2">
                                <button onClick={() => setStep('admin_login')} className="absolute top-4 right-4 text-slate-400 p-2 hover:bg-sky-100 rounded-full transition-colors">
                                    <Shield size={20}/>
                                </button>
                                <LogoHeader title="ระบบสอบ Secure Exam" subtitle="STUDENT LOGIN" />
                                <form onSubmit={handleStudentLogin} className="space-y-6">
                                    <div className="text-left">
                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2 px-1">รหัสนักเรียน</label>
                                        <input 
                                            type="text" 
                                            value={studentIdInput} 
                                            onChange={(e) => setStudentIdInput(e.target.value)} 
                                            className="w-full p-5 border-2 border-slate-50 rounded-2xl text-center text-2xl tracking-widest outline-none font-black bg-slate-50 focus:bg-white focus:ring-4 focus:ring-blue-100" 
                                            placeholder="00000" 
                                            required 
                                            autoFocus 
                                        />
                                    </div>
                                    {error && (
                                        <div className="p-4 bg-red-50 text-red-600 rounded-2xl text-sm font-bold animate-shake">
                                            {error}
                                        </div>
                                    )}
                                    <button className="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-blue-700 transition-all text-xl uppercase tracking-tighter">
                                        เข้าสู่ระบบ
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Admin Login */}
                    {step === 'admin_login' && (
                        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                            <div className="glass-card p-10 rounded-3xl w-full max-w-sm text-center shadow-2xl border-white border-2">
                                <LogoHeader title="Admin Access" subtitle="AUTHENTICATION" />
                                <form onSubmit={e => {
                                    e.preventDefault(); 
                                    if(adminPassword === adminGlobalPassword) { 
                                        setStep('admin_dashboard'); 
                                        showToast('เข้าสู่ระบบแอดมินสำเร็จ'); 
                                    } else showToast('รหัสผ่านไม่ถูกต้อง', 'error');
                                }} className="space-y-4">
                                    <input 
                                        type="password" 
                                        value={adminPassword} 
                                        onChange={e => setAdminPassword(e.target.value)} 
                                        className="w-full p-4 border rounded-2xl text-center outline-none focus:ring-2 focus:ring-slate-800 text-lg font-bold bg-slate-50" 
                                        placeholder="รหัสผ่าน" 
                                        autoFocus
                                    />
                                    <button className="w-full bg-slate-800 text-white font-black py-4 rounded-2xl shadow-xl hover:bg-black transition-all text-lg uppercase">
                                        เข้าสู่ระบบ
                                    </button>
                                </form>
                                <button onClick={() => setStep('login')} className="mt-6 text-sm text-slate-400 font-bold hover:text-slate-600 uppercase tracking-widest">
                                    กลับสู่หน้านักเรียน
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Waiting Room Section */}
{step === 'waiting_room' && (
    <div className="min-h-screen flex items-center justify-center p-4">
        <div className="glass-card p-12 rounded-[3.5rem] w-full max-w-md shadow-2xl text-center border-white border-2">
            <h2 className="text-4xl font-black mb-10 uppercase">ห้องรอสอบ</h2>

            {(() => {
                const cfgRoom = String(systemConfig.activeClassroom || 'All').trim().toLowerCase();
                const studentRoom = String(student?.classroom || '').trim().toLowerCase();
                const isCorrectRoom = cfgRoom === 'all' || cfgRoom === studentRoom;
                
                // หากระบบเปิดแล้ว แต่ห้องเรียนไม่ตรงกับที่กำหนด
                if (systemConfig.isOpen && !isCorrectRoom) {
                    return (
                        <div className="mb-10 p-8 bg-red-50 border-2 border-red-100 rounded-[2.5rem] animate-shake">
                            <div className="text-red-600 font-black text-2xl mb-2">❌ ไม่มีสิทธิ์สอบ</div>
                            <div className="text-red-400 font-bold">
                                วิชานี้เปิดให้เฉพาะห้อง <span className="text-red-600 font-black">{systemConfig.activeClassroom}</span> เข้าสอบในขณะนี้
                            </div>
                        </div>
                    );
                }
                
                // กรณีห้องถูกต้อง หรือระบบยังไม่เปิด
                return (
                    <div className="relative inline-block mb-10">
                        <div className="w-24 h-24 border-[8px] border-blue-100 border-t-blue-600 rounded-full animate-spin mx-auto"></div>
                        <div className="absolute inset-0 flex items-center justify-center text-3xl font-bold">⏳</div>
                    </div>
                );
            })()}

            <p className="text-slate-400 text-[10px] font-bold uppercase mb-3">วิชาที่สอบ</p>
            <div className="font-black text-blue-600 text-2xl bg-blue-50 py-5 px-8 rounded-3xl border-2 border-blue-100 inline-block mb-4">
                {currentSubject?.title || 'รออาจารย์เลือกวิชา...'}
            </div>
            
            <p className="mt-8 text-sm text-slate-400 italic">
                {systemConfig.isOpen && (String(systemConfig.activeClassroom).toLowerCase() === 'all' || String(systemConfig.activeClassroom).toLowerCase() === String(student?.classroom).toLowerCase())
                    ? 'สิทธิ์ถูกต้อง ระบบกำลังพาคุณเข้าสอบ...' 
                    : 'ระบบจะตรวจสอบห้องเรียนของคุณอัตโนมัติ'}
            </p>
        </div>
    </div>
)}
                    {/* Instructions */}
                    {step === 'instructions' && currentExamSet && currentSubject && (
                        <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in">
                            <div className="glass-card p-12 rounded-[3.5rem] w-full max-w-lg shadow-2xl border-white border-2">
                                <div className="flex flex-col sm:flex-row items-center gap-5 mb-10">
                                    <div className="p-5 bg-blue-600 text-white rounded-[2rem] shadow-xl">
                                        <Lock size={36}/>
                                    </div>
                                    <div className="text-center sm:text-left">
                                        <h2 className="text-4xl font-black uppercase tracking-tighter leading-none">
                                            กฎการสอบ
                                        </h2>
                                        <p className="text-sm text-slate-400 font-black uppercase tracking-widest mt-2">
                                            {currentSubject.title} - {currentExamSet.title}
                                        </p>
                                    </div>
                                </div>
                                
                                <div className="space-y-4 mb-10 text-slate-700 text-sm sm:text-base">
                                    <div className="flex gap-5 items-center p-6 bg-red-50 text-red-700 rounded-3xl border-2 border-red-100 font-black shadow-sm">
                                        <XCircle size={24} className="shrink-0"/> 
                                        ห้ามสลับหน้าจอหรือพับแท็บโดยเด็ดขาด
                                    </div>
                                    <div className="flex gap-5 items-center p-6 bg-orange-50 text-orange-700 rounded-3xl border-2 border-orange-100 font-black shadow-sm">
                                        <AlertTriangle size={24} className="shrink-0"/> 
                                        ห้ามบันทึกภาพหน้าจอ ระบบจะตัดสิทธิ์การสอบทันที
                                    </div>
                                    <div className="flex gap-5 items-center p-6 bg-blue-50 text-blue-700 rounded-3xl border-2 border-blue-100 font-black shadow-sm">
                                        <Clock size={24} className="shrink-0"/> 
                                        เวลาสอบ: {currentExamSet.timeLimit / 60} นาที
                                    </div>
                                </div>
                                
                                <button 
                                    onClick={startExam} 
                                    className="w-full bg-slate-800 text-white py-6 rounded-3xl font-black text-2xl shadow-xl hover:bg-black transition-all active:scale-95 uppercase tracking-wider"
                                >
                                    เริ่มสอบ
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Exam */}
                    {step === 'exam' && currentExamSet && currentSubject && (
                        <div className="min-h-screen bg-slate-100 pb-32 animate-fade-in">
                            <Watermark text={`${student?.id} - ${student?.name}`} />
                            
                            <div className="sticky top-0 bg-white/95 backdrop-blur-md border-b z-20 shadow-md">
                                <div className="px-8 py-5 flex justify-between items-center">
                                    <div className="flex items-center gap-4">
                                        <img src={LOGO_URL} alt="Logo" className="w-10 h-10 hidden sm:block" />
                                        <div>
                                            <div className="font-black text-sm text-slate-500">{currentSubject.title}</div>
                                            <div className="font-black text-lg tracking-tight">{currentExamSet.title}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-4">
                                        <button 
                                            onClick={() => {
                                                if(confirm(`ยืนยันส่งกระดาษคำตอบ?\nคุณตอบไปแล้ว ${currentExamSet.questions.filter(q => answers[q.id] !== undefined).length} จาก ${currentExamSet.questions.length} ข้อ`)) 
                                                    submitExam('Manual Submit');
                                            }} 
                                            className="hidden md:flex px-4 py-2 bg-red-600 text-white rounded-xl font-black text-xs uppercase items-center gap-2 hover:bg-red-700 active:scale-95 transition-all shadow-sm"
                                        >
                                            <Send size={14}/> ส่งข้อสอบทันที
                                        </button>
                                        <div className={`px-5 py-2.5 rounded-xl font-mono font-black text-xl border-2 transition-colors ${
                                            timeLeft < 300 
                                                ? 'bg-red-50 border-red-500 text-red-600 animate-pulse'
                                                : 'bg-slate-800 border-slate-800 text-white'
                                        }`}>
                                            {Math.floor(timeLeft / 60)}:{String(timeLeft % 60).padStart(2, '0')}
                                        </div>
                                    </div>
                                </div>
                                <div className="w-full h-2 bg-slate-200">
                                    <div className="h-full bg-blue-600 transition-all duration-500" style={{width: `${progress}%`}}></div>
                                </div>
                                <div className="bg-blue-50 px-8 py-1.5 flex justify-between items-center border-b border-blue-100">
                                    <span className="text-[10px] font-black text-blue-600 uppercase tracking-widest">ความคืบหน้า: {progress}%</span>
                                    <span className="text-[10px] font-black text-blue-400 uppercase tracking-widest">ตอบแล้ว: {currentExamSet.questions.filter(q => answers[q.id] !== undefined).length} / {currentExamSet.questions.length}</span>
                                </div>
                            </div>

                            <div className="max-w-5xl mx-auto p-4 md:p-10 space-y-8">
                                <div className="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                                    <div className="flex items-center gap-2 mb-4 text-slate-400 font-black text-[10px] uppercase tracking-widest">
                                        <List size={14}/> แผนที่ข้อสอบ
                                    </div>
                                    <div className="flex flex-wrap gap-2">
                                        {currentExamSet.questions.map((q, idx) => (
                                            <button 
                                                key={idx} 
                                                onClick={() => setCurrentQIdx(idx)} 
                                                className={`w-10 h-10 rounded-xl font-black text-sm transition-all border-2 flex items-center justify-center ${
                                                    currentQIdx === idx 
                                                        ? 'border-blue-600 bg-blue-50 text-blue-600 scale-110 shadow-md ring-2 ring-blue-100' 
                                                        : answers[q.id] !== undefined 
                                                        ? 'bg-green-500 border-green-500 text-white' 
                                                        : 'bg-white border-slate-200 text-slate-400 hover:border-slate-300'
                                                }`}
                                            >
                                                {idx + 1}
                                            </button>
                                        ))}
                                    </div>
                                </div>

                                {step === 'result' && (
    <div className="min-h-screen flex items-center justify-center p-4 animate-fade-in bg-slate-50">
        <div className="glass-card p-8 md:p-12 rounded-[3rem] w-full max-w-lg shadow-2xl text-center border-white border-2">
            <div className="w-24 h-24 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <CheckCircle size={48} />
            </div>
            
            <h2 className="text-3xl font-black mb-2 uppercase tracking-tighter text-slate-800">บันทึกคำตอบสำเร็จ</h2>
            <p className="text-slate-500 font-bold mb-8 uppercase tracking-widest text-xs">{currentSubject?.title}</p>
            
            <div className="bg-slate-900 text-white p-10 rounded-[2.5rem] shadow-xl mb-8 relative overflow-hidden">
                <div className="relative z-10">
                    <p className="text-[10px] font-black opacity-60 uppercase tracking-[0.2em] mb-2">คะแนนที่คุณได้</p>
                    <div className="text-7xl font-black tracking-tighter">
                        {finalResult.score}<span className="text-2xl opacity-40 ml-2">/ {finalResult.total}</span>
                    </div>
                </div>
                <div className="absolute -bottom-4 -right-4 text-white/5 text-9xl font-black rotate-12">SCORE</div>
            </div>

            <p className="text-slate-400 text-sm font-bold mb-10">ระบบได้ทำการบันทึกคะแนนของคุณเรียบร้อยแล้ว<br/>คุณสามารถออกจากระบบได้ทันที</p>
            
            <button 
                onClick={() => window.location.reload()} 
                className="w-full py-5 bg-slate-100 text-slate-600 rounded-2xl font-black hover:bg-slate-200 transition-all uppercase tracking-widest"
            >
                กลับสู่หน้าหลัก / ออกจากระบบ
            </button>
        </div>
    </div>
)}
                                {/* Current Question */}
<div className="bg-white p-10 md:p-16 rounded-[4rem] shadow-2xl relative overflow-hidden border border-white">
    <div className="absolute top-0 right-0 p-8 opacity-[0.03] text-[12rem] font-black select-none pointer-events-none tracking-tighter leading-none">
        # {currentQIdx + 1}
    </div>
    
    {currentExamSet.questions[currentQIdx].passage && currentExamSet.questions[currentQIdx].passagePosition !== 'bottom' && (
        <div className="bg-amber-50 border-l-[10px] border-amber-400 p-8 mb-10 rounded-r-[2.5rem] text-slate-700 italic whitespace-pre-line font-black text-lg">
            <BookOpen size={24} className="inline mr-4 mb-1 text-amber-600"/>
            {currentExamSet.questions[currentQIdx].passage}
        </div>
    )}
    
    <div className="relative mb-12">
        <h3 className="text-3xl font-black text-slate-800 leading-relaxed tracking-tight whitespace-pre-line">
            {currentExamSet.questions[currentQIdx].text}
        </h3>
    </div>
    
    {currentExamSet.questions[currentQIdx].passage && currentExamSet.questions[currentQIdx].passagePosition === 'bottom' && (
        <div className="bg-amber-50 border-l-[10px] border-amber-400 p-8 mb-12 rounded-r-[2.5rem] text-slate-700 italic whitespace-pre-line font-black text-lg">
            <BookOpen size={24} className="inline mr-4 mb-1 text-amber-600"/>
            {currentExamSet.questions[currentQIdx].passage}
        </div>
    )}
    
    <div className="grid gap-5">
        {currentExamSet.questions[currentQIdx].options.map((opt, i) => {
            // ดึงเฉพาะตัวอักษรนำหน้า (A, B, C, D) และข้อความ
            const optionMatch = opt.match(/^([A-D])\.\s*(.+)/);
            const optionLetter = optionMatch ? optionMatch[1] : String.fromCharCode(65 + i);
            const optionText = optionMatch ? optionMatch[2] : opt;
            
            return (
                <label 
                    key={i} 
                    className={`flex items-center p-8 border-2 rounded-[2.5rem] cursor-pointer transition-all active:scale-[0.98] group ${
                        answers[currentExamSet.questions[currentQIdx].id] === i 
                            ? 'bg-blue-600 border-blue-600 text-white shadow-2xl ring-8 ring-blue-100 font-bold'
                            : 'bg-slate-50 border-transparent text-slate-600 hover:bg-white hover:border-blue-100 hover:shadow-lg'
                    }`}
                >
                    <input 
                        type="radio" 
                        className="hidden" 
                        checked={answers[currentExamSet.questions[currentQIdx].id] === i}
                        onChange={() => {
                            setAnswers({
                                ...answers, 
                                [currentExamSet.questions[currentQIdx].id]: i
                            });
                            answersRef.current = {
                                ...answersRef.current,
                                [currentExamSet.questions[currentQIdx].id]: i
                            };
                        }}
                    />
                    <div className={`w-12 h-12 rounded-2xl border-2 mr-6 flex items-center justify-center font-black text-xl transition-all ${
                        answers[currentExamSet.questions[currentQIdx].id] === i
                            ? 'bg-white text-blue-600 border-white'
                            : 'bg-white text-slate-300 border-slate-200'
                    }`}>
                        {optionLetter}
                    </div>
                    <span className="text-2xl leading-tight font-black whitespace-pre-line">{optionText}</span>
                </label>
            );
        })}
    </div>
</div>
                                <div className="flex justify-between items-center px-4">
                                    <button 
                                        onClick={() => setCurrentQIdx(p => Math.max(0, p - 1))} 
                                        disabled={currentQIdx === 0} 
                                        className="px-8 py-4 bg-white text-slate-600 border-2 border-slate-200 rounded-3xl font-black disabled:opacity-30 hover:bg-slate-50 shadow-sm transition-all uppercase"
                                    >
                                        ย้อนกลับ
                                    </button>
                                    
                                    <div className="text-slate-400 font-black text-sm hidden sm:block uppercase tracking-tighter">
                                        ข้อที่ {currentQIdx + 1} / {currentExamSet.questions.length}
                                    </div>
                                    
                                    {currentQIdx < currentExamSet.questions.length - 1 ? (
                                        <button 
                                            onClick={() => setCurrentQIdx(p => p + 1)} 
                                            className="px-10 py-4 bg-slate-800 text-white rounded-2xl font-black shadow-lg hover:bg-black transition-all active:scale-95 uppercase"
                                        >
                                            ถัดไป
                                        </button>
                                    ) : (
                                        <button 
                                            onClick={() => {
                                                if(confirm("ยืนยันส่งกระดาษคำตอบ?")) 
                                                    submitExam('User Submitted');
                                            }} 
                                            className="px-12 py-4 bg-green-600 text-white rounded-2xl font-black shadow-xl hover:bg-green-700 transition-all active:scale-95 uppercase text-lg"
                                        >
                                            ส่งข้อสอบ
                                        </button>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Admin Dashboard */}
                    {step === 'admin_dashboard' && (
                        <div className="p-4 md:p-8 max-w-7xl mx-auto animate-fade-in">
                            <div className="glass-card rounded-3xl shadow-2xl min-h-[85vh] flex flex-col overflow-hidden bg-white/60">
                                <div className="p-4 border-b flex justify-between items-center bg-white/80 overflow-x-auto gap-4 shadow-sm">
                                    <div className="flex gap-2 bg-slate-100 p-1.5 rounded-2xl shrink-0">
                                        <button onClick={() => setAdminTab('dashboard')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'dashboard' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <RefreshCw size={16}/> ภาพรวม
                                        </button>
                                        <button onClick={() => setAdminTab('manage_exams')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'manage_exams' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <List size={16}/> จัดการข้อสอบ
                                        </button>
                                        <button onClick={() => setAdminTab('manage_students')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'manage_students' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <Users size={16}/> จัดการนักเรียน
                                        </button>
                                        <button onClick={() => setAdminTab('security')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'security' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <Lock size={16}/> ความปลอดภัย
                                        </button>
                                        <button onClick={() => setAdminTab('create_exam')} className={`px-5 py-2.5 rounded-xl font-black flex items-center gap-2 transition-all uppercase text-xs tracking-tighter ${adminTab === 'create_exam' ? 'bg-white text-blue-600 shadow-md' : 'text-slate-400'}`}>
                                            <Plus size={16}/> สร้างข้อสอบ
                                        </button>
                                    </div>
                                    <button onClick={() => { setStep('login'); setAdminPassword(''); cleanupListeners(); }} className="p-3 bg-red-50 text-red-500 hover:bg-red-500 hover:text-white rounded-2xl transition-all shadow-sm">
                                        <LogOut size={20}/>
                                    </button>
                                </div>
                                
                                <div className="p-8 overflow-y-auto flex-1">
                                    {adminTab === 'dashboard' && (
                                        <div className="space-y-10">
                                            <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                                                <div className="lg:col-span-8 bg-white p-10 rounded-[3rem] border border-slate-100 shadow-xl space-y-8">
                                                    <h3 className="font-black text-2xl uppercase tracking-tighter flex items-center gap-3">
                                                        <Shield className="text-blue-600" size={32}/> แผงควบคุม
                                                    </h3>
                                                    
                                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                                                        <div>
    <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
        เลือกวิชา
    </label>
    <div className="relative">
        
<select 
    value={systemConfig.activeSubjectId || ''} 
    onChange={(e) => handleChangeSubject(e.target.value)} 
    className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl appearance-none shadow-sm"
>
    <option value="" disabled>-- โปรดเลือกวิชา --</option>
    {subjects.map(subject => (
        <option key={subject.id} value={subject.id}>
            {subject.id} - {subject.title}
        </option>
    ))}
</select>
        <div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
            <ChevronDown size={24}/>
        </div>
    </div>
    {subjects.length === 0 && (
        <p className="text-xs text-red-500 mt-2">ยังไม่มีวิชาในระบบ กรุณาสร้างวิชาก่อน</p>
    )}
</div>
                                                        
                                                        <div>
    <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
        เลือกชุดข้อสอบ
    </label>
    <div className="relative">
        <select 
            value={systemConfig.activeExamSetId || ''} 
            onChange={e => {
                const value = e.target.value;
                console.log('Selected exam set:', value);
                handleChangeExamSet(value);
            }} 
            className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl appearance-none shadow-sm"
            disabled={!systemConfig.activeSubjectId || currentSubjectExams.length === 0}
        >
            <option value="">-- เลือกชุดข้อสอบ --</option>
            {currentSubjectExams.map(set => (
                <option key={set.setId} value={set.setId}>
                    ชุดที่ {set.setId}: {set.title}
                </option>
            ))}
        </select>
        <div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
            <ChevronDown size={24}/>
        </div>
    </div>
    {systemConfig.activeSubjectId && currentSubjectExams.length === 0 && (
        <p className="text-xs text-amber-500 mt-2">ยังไม่มีชุดข้อสอบในวิชานี้</p>
    )}
</div>
                                                        <div>
                                                            <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
                                                                ห้องเรียนที่สอบได้
                                                            </label>
                                                            <div className="relative">
                                                                <select 
                                                                    value={adminClassroomInput} 
                                                                    onChange={e => setAdminClassroomInput(e.target.value)} 
                                                                    className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl appearance-none shadow-sm"
                                                                >
                                                                    <option value="All">ทุกห้องเรียน</option>
                                                                    {availableClassrooms.map(room => (
                                                                        <option key={room} value={room}>
                                                                            เฉพาะห้อง {room}
                                                                        </option>
                                                                    ))}
                                                                </select>
                                                                <div className="absolute right-6 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">
                                                                    <ChevronDown size={24}/>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div>
                                                            <label className="text-[10px] font-black text-slate-400 block mb-3 uppercase tracking-widest">
                                                                เวลาสอบ (นาที)
                                                            </label>
                                                            <input 
                                                                type="number" 
                                                                value={adminTimeLimitInput} 
                                                                onChange={e => setAdminTimeLimitInput(e.target.value)} 
                                                                className="w-full p-5 border-2 border-slate-50 rounded-3xl bg-slate-50 outline-none focus:border-blue-500 focus:bg-white font-black text-xl shadow-inner" 
                                                                min="1"
                                                            />
                                                        </div>
                                                    </div>
                                                </div>
                                                
                                                <div className="lg:col-span-4 space-y-6">
                                                    {selectedExamPreview ? (
                                                        <div className="bg-slate-900 text-white p-10 rounded-[3.5rem] shadow-2xl space-y-6 relative overflow-hidden">
                                                            <h4 className="text-3xl font-black leading-tight tracking-tight">
                                                                {selectedExamPreview.title}
                                                            </h4>
                                                            <div className="pt-6 border-t border-white/10 space-y-3">
                                                                <p className="text-xs opacity-60">จำนวนข้อ: {selectedExamPreview.questions?.length || 0} ข้อ</p>
                                                                <p className="text-xs opacity-60">เวลา: {selectedExamPreview.timeLimit / 60} นาที</p>
                                                            </div>
                                                            <button 
                                                                onClick={() => handleToggleExam(!systemConfig.isOpen)} 
                                                                className={`w-full py-5 rounded-[2rem] font-black text-xl transition-all shadow-2xl active:scale-95 uppercase ${
                                                                    systemConfig.isOpen ? 'bg-red-500 hover:bg-red-600' : 'bg-blue-600 hover:bg-blue-700'
                                                                }`}
                                                            >
                                                                {systemConfig.isOpen ? 'ปิดระบบสอบ' : 'เปิดระบบสอบ'}
                                                            </button>
                                                        </div>
                                                    ) : (
                                                        <div className="bg-white border-4 border-dashed border-slate-100 p-16 rounded-[3.5rem] text-center text-slate-400 font-black">
                                                            กรุณาเลือกวิชาและชุดข้อสอบ
                                                        </div>
                                                    )}
                                                </div>
                                            </div>

                                            <div className="pt-10 space-y-6">
                                                <div className="flex justify-between items-center">
                                                    <div className="flex items-center gap-6">
                                                        <h4 className="font-black text-2xl uppercase tracking-tighter">
                                                            ติดตามสถานะ
                                                        </h4>
                                                        <div className="flex items-center gap-3 bg-white p-2 border-2 border-slate-50 rounded-2xl">
                                                            <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-2">
                                                                แสดงห้อง:
                                                            </label>
                                                            <select 
                                                                value={monitorFilterRoom} 
                                                                onChange={e => setMonitorFilterRoom(e.target.value)} 
                                                                className="bg-transparent font-black text-blue-600 outline-none text-sm cursor-pointer pr-4"
                                                            >
                                                                <option value="All">ทุกห้องเรียน</option>
                                                                {availableClassrooms.map(room => (
                                                                    <option key={room} value={room}>
                                                                        ห้อง {room}
                                                                    </option>
                                                                ))}
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <div className="flex gap-2">
                                                        <button 
                                                            onClick={() => {
                                                                setLoading(true);
                                                                fetchAllData().then(() => {
                                                                    showToast('รีเฟรชข้อมูลเรียบร้อย');
                                                                    setLoading(false);
                                                                });
                                                            }}
                                                            className="text-xs bg-blue-50 text-blue-600 px-4 py-3 rounded-2xl border-2 border-blue-100 hover:bg-blue-100 font-black uppercase flex items-center gap-2"
                                                        >
                                                            <RefreshCw size={16}/> รีเฟรช
                                                        </button>
                                                        <button 
                                                            onClick={exportToCSV} 
                                                            className="text-xs bg-emerald-50 text-emerald-700 px-6 py-3 rounded-2xl border-2 border-emerald-100 hover:bg-emerald-100 font-black uppercase flex items-center gap-2"
                                                        >
                                                            <Download size={18}/> ส่งออกรายงาน
                                                        </button>
                                                    </div>
                                                </div>

                                                <div className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
                                                    {dashboardData
                                                        .filter(d => monitorFilterRoom === 'All' || String(d.classroom).trim() === monitorFilterRoom.trim())
                                                        .map((d, i) => (
                                                            <div 
                                                                key={i} 
                                                                className={`bg-white p-6 rounded-[2.5rem] border-2 flex flex-col justify-between shadow-sm transition-all hover:shadow-lg ${
                                                                    d.status === 'COMPLETED' 
                                                                        ? 'border-emerald-100 ring-4 ring-emerald-400/10' 
                                                                        : d.status === 'IN_PROGRESS' 
                                                                        ? 'border-blue-100 ring-4 ring-blue-400/10 animate-pulse' 
                                                                        : 'border-slate-50 opacity-60'
                                                                }`}
                                                            >
                                                                <div className="flex justify-between items-start">
                                                                    <span className="font-black text-[10px] text-slate-400 tracking-tighter uppercase">
                                                                        {d.id}
                                                                    </span>
                                                                    <div className="flex gap-1 items-center">
                                                                        <button 
                                                                            onClick={() => handleResetSubmission(d.id)} 
                                                                            className="p-1 text-red-400 hover:text-red-600 transition-colors" 
                                                                            title="รีเซ็ตสถานะการสอบ"
                                                                        >
                                                                            <RefreshCw size={14}/>
                                                                        </button>
                                                                        <span className={`text-[9px] px-3 py-1 rounded-full font-black uppercase tracking-widest ${
                                                                            d.status === 'COMPLETED' 
                                                                                ? 'bg-emerald-100 text-emerald-700' 
                                                                                : d.status === 'IN_PROGRESS' 
                                                                                ? 'bg-blue-100 text-blue-700' 
                                                                                : 'bg-slate-100 text-slate-400'
                                                                        }`}>
                                                                            {d.status}
                                                                        </span>
                                                                    </div>
                                                                </div>
                                                                <div className="text-lg font-black truncate py-6 border-b-2 border-slate-50 mb-6">
                                                                    {d.name} {d.surname}
                                                                </div>
                                                                <div className="flex justify-between items-end">
                                                                    <div className="flex flex-col">
                                                                        <span className="text-[9px] text-slate-300 font-black uppercase">
                                                                            คะแนน
                                                                        </span>
                                                                        <span className="text-4xl font-black text-slate-900 leading-none">
                                                                            {d.score ?? '-'}
                                                                        </span>
                                                                    </div>
                                                                    <span className="text-[10px] font-black text-slate-300 uppercase">
                                                                        ห้อง {d.classroom}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        ))}
                                                </div>
                                            </div>
                                        </div>
                                    )}

                                    {adminTab === 'manage_students' && renderManageStudents()}
                                    {adminTab === 'manage_exams' && renderManageExams()}
                                    {adminTab === 'create_exam' && renderCreateExam()}
                                    
                                    {adminTab === 'security' && (
                                        <div className="space-y-6">
                                            <div className="max-w-md mx-auto bg-white p-10 rounded-[3rem] border-2 border-slate-50 shadow-xl">
                                                <h3 className="font-black text-2xl uppercase tracking-tighter mb-8 flex items-center gap-3">
                                                    <Lock size={32} className="text-blue-600"/> รหัสผ่านแอดมิน
                                                </h3>
                                                <div className="space-y-6">
                                                    <div>
                                                        <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest block mb-2">
                                                            รหัสผ่านใหม่
                                                        </label>
                                                        <input 
                                                            type="text" 
                                                            value={newAdminPassword} 
                                                            onChange={e => setNewAdminPassword(e.target.value)} 
                                                            className="w-full p-5 border-2 border-slate-50 rounded-2xl outline-none font-black bg-slate-50 focus:bg-white" 
                                                            placeholder="รหัสผ่านใหม่"
                                                        />
                                                    </div>
                                                    <button 
                                                        onClick={handleChangeAdminPassword} 
                                                        className="w-full bg-blue-600 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-blue-700 transition-all uppercase"
                                                    >
                                                        เปลี่ยนรหัสผ่าน
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<SecureExamApp />);
    </script>
</body>
</html>
